if game.PlaceId ~= 79189799490564 then
    return
end

repeat
    task.wait()
until game:IsLoaded()

-- Load Loading Screen
loadstring(game:HttpGet("https://raw.githubusercontent.com/ANHub-Script/ANUI/refs/heads/main/dist/loading.lua"))()

-- // Services //
Players = game:GetService("Players")
Workspace = game:GetService("Workspace")
ReplicatedStorage = game:GetService("ReplicatedStorage")
ReplicatedFirst = game:GetService("ReplicatedFirst")
HttpService = game:GetService("HttpService")
RunService = game:GetService("RunService")
VirtualUser = game:GetService("VirtualUser")

-- // Constants & Paths //
LocalPlayer = Players.LocalPlayer
FolderPath = "ANUI/AnimeWeapons"
ExpiryFile = FolderPath .. "/ANHub_Key_Timer.txt"
ZoneDBFile = "Zone_Database.json"

-- // Network & Remotes //
Reliable = ReplicatedStorage:WaitForChild("Reply"):WaitForChild("Reliable")
Unreliable = ReplicatedStorage:WaitForChild("Reply"):WaitForChild("Unreliable")

-- // Configs Paths //
ConfigsPath = ReplicatedStorage.Scripts.Configs

-- // Modules //
UtilsModule = require(ConfigsPath.Utility.Utils)
MaterialsModule = require(ConfigsPath.General.Materials)
YenModule = require(ConfigsPath.Machines.YenUpgrades)
TokenModule = require(ConfigsPath.Machines.TokenUpgrades)
RankModule = require(ConfigsPath.Machines.RankUp)
AvatarLevelsModule = require(ConfigsPath.Machines.AvatarLevels) -- DITAMBAHKAN
LevelUpModule = require(ConfigsPath.General.LevelUp)
EnchantmentsConfig = require(game:GetService("ReplicatedStorage").Scripts.Configs.Machines.Enchantments)
-- // Variables //
TradeTokenInfo = MaterialsModule.TradeToken
YenUpgradeConfig = YenModule.Config
TokenUpgradeConfig = TokenModule.Config

hrp = nil
humanoid = nil
LastZone = nil
CurrentZoneName = ""
CurrentZoneEnemiesCache = {}
IsLoadingConfig = false
-- // Meteor Variables //
local MeteorState = {
    IsActive = false,     -- Apakah meteor sedang spawn/jatuh?
    Zone = nil,           -- Nama Zone tempat meteor
    Position = nil,       -- Posisi Vector3 jatuhnya meteor
    LandTime = 0          -- Waktu (os.time) kapan meteor diperkirakan sampai tanah
}
IsTeleporting = false
GlobalEnemyMap = {}
RollConfigs = {}
AllRollTypes = {}
ChanceModules = {}
ChanceSortedNames = {}
WeaponsModule = {}
AccessoriesConfig = {}
EnemiesConfig = {}
UpgradesModules = {}

ChanceModules = {}
ChanceSortedNames = {}
UpgradeModules = {}
UpgradeSortedNames = {}
CombinedToggleUI = {} 
UpgradeUICache = {} -- [NEW] Cache to prevent lag

local Config = {
    AutoFarm = false,
    AutoFuse = false,
    AutoRankUp = false,
    AutoYen_Luck = false,
    AutoYen_Damage = false,
    AutoYen_Yen = false,
    AutoYen_Mastery = false,
    AutoYen_Critical = false,
    AutoRollBiju = false,
    AutoRollRace = false,
    AutoRollSayajin = false,
    AutoRollFruits = false,
    AutoRollHaki = false,
    AutoRollBreathing = false,
    AutoRollOrganization = false,
    AutoRollTitan = false,
    AutoRollMagicEyes = false,
    AutoRollDemonArt = false,
    AutoUpgradeMagicEyes = false,
    AutoChance_Breath = false,
    AutoChance_Pirate = false,
    AutoChance_Wise = false,
    AutoChance_Leve = false,
    AutoChance_Sung = false,
    SelectedEnemy = nil,
    ZoneConfigurations = {},
    AutoGamemode = false,
    TargetDungeons = {},
    TargetRaids = {},
    TargetDefenses = {},
    TargetWave = 500,
    TeleportBackMap = "None",
    AutoEquipVaultMode = nil,
    AutoEquipVaultFarm = nil,
    AutoAvatarLevelUp = false,
    AutoJoinDefense = false,
    AutoJoinRaid = false,
    AutoRollHeroStats = false,
    HeroesStats_LockStats = "",
    GM_AutoJoin = false,
    GM_AutoKill = false,
    GM_AutoCreate = false,
    AutoLeave = false,
    AutoLeave_Dungeon = 50,      -- Target Room Dungeon
    AutoLeave_Raid = 25,         -- Target Wave Raid
    AutoLeave_Defense = 200,      -- Target Wave Defense
    AutoLeave_PirateTower = 500, -- Target Floor Pirate Tower
    AutoLeave_ShadowGate = 500   -- Target Wave Shadow Gate
}

-- // UI Variables //
local EnemyDropdown = nil
local RankProgressUI = nil
local RollToggleUI = {}
local YenUpgradeToggleUI = {}
local TokenUpgradeToggleUI = {}

getgenv().PlayerData = nil
-- [HELPER: TIME CALCULATOR]
local function GetNextTime(startTimes)
    if not startTimes or #startTimes == 0 then return nil end
    local now = os.date("!*t") -- Waktu UTC
    local currentMin = os.date("*t").min
    
    local minDiff = 999
    
    for _, startMin in ipairs(startTimes) do
        local diff = startMin - currentMin
        if diff < 0 then diff = diff + 60 end
        if diff < minDiff then minDiff = diff end
    end
    return minDiff
end
-- // Security & Cleanup Functions //

local function SecureWipe()
    if not isfile or (not delfile) or (not readfile) or (not listfiles) then
        return
    end
    
    local currentTime = os.time()
    local isExpired = false

    if isfile(ExpiryFile) then
        local savedTime = tonumber(readfile(ExpiryFile)) or 0
        if currentTime > savedTime then
            isExpired = true
        end
    elseif isfolder(FolderPath) then
        isExpired = true
    end

    if isExpired then
        if isfile(ExpiryFile) then
            delfile(ExpiryFile)
        end

        local PossiblePaths = { FolderPath }
        local UserId = tostring(game.Players.LocalPlayer.UserId)
        
        for _, path in pairs(PossiblePaths) do
            if isfolder(path) then
                for _, file in pairs(listfiles(path)) do
                    if string.find(file, ".key") or string.find(file, ".json") or string.find(file, UserId) then
                        pcall(function()
                            delfile(file)
                        end)
                    end
                end
            end
        end
        task.wait(0.5)
    end
end
SecureWipe()

if not isfolder("ANUI") then makefolder("ANUI") end
if not isfolder(FolderPath) then makefolder(FolderPath) end

-- // Memory Scanning for MainController //
local MainController = nil
for _, v in pairs(getgc(true)) do
    if type(v) == "table" then
        -- Mencari arg1 berdasarkan ciri unik: .Data, .SyncChanged, dan .OpenScreen
        if rawget(v, "Data") and rawget(v, "SyncChanged") then
            MainController = v
            break 
        end
    end
end

-- // Helper Functions //
local function DiscoverRollTypes()
    local set = {}
    local cfgRoot = ConfigsPath
    if not cfgRoot then return end
    
    local rollsFolder = cfgRoot:FindFirstChild("RollGachas")
    if rollsFolder then
        for _, child in pairs(rollsFolder:GetChildren()) do
            if child:IsA("ModuleScript") then
                set[child.Name] = true
            end
        end
    end
    
    local upgradesFolder = cfgRoot:FindFirstChild("RollGachaUpgrades")
    if upgradesFolder then
        for _, child in pairs(upgradesFolder:GetChildren()) do
            if child:IsA("ModuleScript") then
                set[child.Name] = true
            end
        end
    end
    
    AllRollTypes = {}
    for name, _ in pairs(set) do
        table.insert(AllRollTypes, name)
    end
    table.sort(AllRollTypes)
end
DiscoverRollTypes()

local function ScanPlayerData()
    if (getgenv()).PlayerData then
        return
    end
    (getgenv()).PlayerData = MainController.Data
end
task.spawn(ScanPlayerData)

local function HookTimerVariable()
    task.spawn(function()
        local targetFound = false
        
        while not targetFound do
            local gcList = getgc() 

            for _, func in pairs(gcList) do
                if type(func) == "function" and islclosure(func) then
                    local info = debug.getinfo(func)

                    if info.source and string.find(info.source, "AutoReconnect.c") then
                        
                        local upvalues = debug.getupvalues(func)
                        for index, value in pairs(upvalues) do
                            
                            -- KUNCI TIMER
                            if type(value) == "number" then
                                targetFound = true
                                
                                -- [PERUBAHAN DISINI]
                                -- Menggunakan RunService.Heartbeat untuk reset timer SETIAP FRAME
                                local connection
                                connection = RunService.Heartbeat:Connect(function()
                                    if func then
                                        debug.setupvalue(func, index, 0)
                                    else
                                        if connection then connection:Disconnect() end
                                    end
                                end)
                            end
                            
                            -- SEMBUNYIKAN UI
                            if typeof(value) == "Instance" and (value:IsA("TextLabel") or value:IsA("Frame")) then
                                value.Visible = false
                                value:GetPropertyChangedSignal("Visible"):Connect(function()
                                    value.Visible = false
                                end)
                            end
                        end
                    end
                end
            end
            
            if targetFound then break end
            task.wait(2)
        end
    end)
end
HookTimerVariable()

-- [2] MATIKAN TIMER ROBLOX (Error 278)
task.spawn(function()
    game:GetService("Players").LocalPlayer.Idled:Connect(function()
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new())
    end)
end)

-- [LOAD DATABASES: WEAPONS, ACCESSORIES, ENEMIES]
pcall(function()
    -- Cari folder MultipleZones satu kali saja
    local MZPath = ConfigsPath:FindFirstChild("MultipleZones") or ConfigsPath:FindFirstChild("Multiple Zones")
    
    if MZPath then
        -- 1. Load Weapons (Iterasi Folder)
        local WeaponsFolder = MZPath:FindFirstChild("Weapons")
        if WeaponsFolder then
            for _, module in pairs(WeaponsFolder:GetChildren()) do
                if module:IsA("ModuleScript") then
                    local success, data = pcall(require, module)
                    if success and type(data) == "table" then
                        for weaponId, weaponData in pairs(data) do
                            WeaponsModule[weaponId] = weaponData
                        end
                    end
                end
            end
        end

        -- 2. Load Accessories (Single Module)
        local AccModule = MZPath:FindFirstChild("Accessories")
        if AccModule then
            local success, data = pcall(require, AccModule)
            if success then AccessoriesConfig = data end
        end

        -- 3. Load Enemies (Single Module)
        local EnemyModule = MZPath:FindFirstChild("Enemies")
        if EnemyModule then
            local success, data = pcall(require, EnemyModule)
            if success then EnemiesConfig = data end
        end
    end
end)

-- [LOAD UPGRADES MODULES]
do
    local upgradesFolder = ConfigsPath:FindFirstChild("RollGachaUpgrades")
    if upgradesFolder then
        for _, m in pairs(upgradesFolder:GetChildren()) do
            if m:IsA("ModuleScript") then
                local s, d = pcall(require, m)
                if s and type(d) == "table" then
                    UpgradesModules[m.Name] = d
                end
            end
        end
    end
end

local function LoadZoneDB()
    if isfile(FolderPath .. "/" .. ZoneDBFile) then
        local success, result = pcall(function()
            return HttpService:JSONDecode(readfile(FolderPath .. "/" .. ZoneDBFile))
        end)
        if success and type(result) == "table" then
            Config.ZoneConfigurations = result
        end
    end
end

local function SaveZoneConfig(zone, selectedItem)
    if not zone or zone == "" or zone == "Unknown" then return end
    if not selectedItem then return end
    
    local val = type(selectedItem) == "table" and selectedItem.Value or selectedItem
    local title = type(selectedItem) == "table" and selectedItem.Title or selectedItem
    
    if not val or val == "" then return end
    
    local savedEntry = {}
    local foundObj = nil
    for _, cached in ipairs(CurrentZoneEnemiesCache) do
        if cached.Value == val then
            foundObj = cached
            break
        end
    end
    
    if foundObj then
        savedEntry = foundObj
    else
        savedEntry = {
            Title = title,
            Value = val,
            Desc = "Saved"
        }
    end
    
    Config.SelectedEnemy = val
    Config.ZoneConfigurations[zone] = savedEntry

    if not isfolder(FolderPath) then
        makefolder(FolderPath)
    end
    if writefile and HttpService then
        pcall(function()
            writefile(FolderPath .. "/" .. ZoneDBFile, HttpService:JSONEncode(Config.ZoneConfigurations))
        end)
    end
end
LoadZoneDB()

local function GetOnlineKeys()
    local keys = {}
    local url = "https://raw.githubusercontent.com/AdityaNugrahaInside/ANHub/refs/heads/main/Key"
    local success, response = pcall(function()
        return game:HttpGet(url)
    end)
    
    if success then
        keys = {}
        for line in response:gmatch("[^\r\n]+") do
            local cleanKey = string.gsub(line, "^%s*(.-)%s*$", "%1")
            if cleanKey ~= "" then
                table.insert(keys, cleanKey)
            end
        end
    end
    return keys
end

-- // UI Creation //
local l = loadstring(game:HttpGet("https://raw.githubusercontent.com/ANHub-Script/ANUI/refs/heads/main/dist/main.lua?v="..math.random()))()

local Window = l:CreateWindow({
    Title = "AN Hub - Anime Weapons",
    Icon = "rbxassetid://84366761557806",
    Author = "Aditya Nugraha",
    Folder = "AnimeWeapons",
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true,
    Theme = "Dark",
    Resizable = true,
    SideBarWidth = 220,
    HideSearchBar = true,
    KeySystem = {
        Enabled = true,
        Title = "ANHub Access",
        Description = "Key expires every 24 Hours!",
        Key = GetOnlineKeys(),
        URL = "https://discord.gg/cy6uMRmeZ",
        Note = "Join Discord for Key",
        SaveKey = true
    }
})

-- // Icon & Asset Functions //

local function GetDynamicRankIcon()
    local iconId = "rbxassetid://84366761557806"
    pcall(function()
        local part = Workspace.Billboards.Machines.RankUp.icon
        if part and part.Image then
            iconId = part.Image
        end
    end)
    return iconId
end

local function GetIcon(id)
    return "rbxassetid://" .. tostring(id)
end

local function GetYenIcon()
    local icon = "rbxassetid://84366761557806"
    pcall(function()
        icon = (game:GetService("Players")).LocalPlayer.PlayerGui.Screen.Hud.left.yen.icon.Image
    end)
    return icon
end

local function GetTrainerIcon()
    local icon = "rbxassetid://10723415903"
    pcall(function()
        icon = (game:GetService("Players")).LocalPlayer.PlayerGui.Screen.Hud.left.buttons.Arsenal.button.icon.Image
    end)
    return icon
end

local function GetAvatarTokenIcon()
    local tokenKey = AvatarLevelsModule.Token or "AvatarToken"
    local config = MaterialsModule[tokenKey]
    if config and config.Template then
        return "rbxassetid://" .. tostring(config.Template)
    end
    -- Fallback default icon (Ganti dengan asset ID yang Anda inginkan)
    return "rbxassetid://13106597792758" 
end


local function LoadRollData(rollType)
    local success, module = pcall(function()
        return require(ConfigsPath.RollGachas[rollType])
    end)
    
    -- Jika tidak ketemu di RollGachas, cari di RollGachaUpgrades
    if not success or not module then
        success, module = pcall(function()
            return require(ConfigsPath.RollGachaUpgrades[rollType])
        end)
    end

    if success and module then
        RollConfigs[rollType] = {
            Cost = module.Cost or 1,
            MaterialKey = (module.Material or module.UpgradeMaterial) or (rollType .. "Token"),
            ImageId = module.ImageId,
            List = module.List
        }
    else
        -- Fallback manual jika gagal total
        RollConfigs[rollType] = {
            Cost = 1,
            MaterialKey = rollType .. "Token",
            ImageId = "84366761557806",
            List = {}
        }
    end
end

for _, rollType in ipairs(AllRollTypes) do
    LoadRollData(rollType)
end

local function GetRollIconAsset(rollType)
    local defaultIcon = "rbxassetid://84366761557806"
    local config = RollConfigs[rollType]
    
    -- 1. Cek Vault Pemain untuk Item Terbaik
    local pData = getgenv().PlayerData
    if pData and pData.Vault and pData.Vault[rollType] and config and config.List then
        -- Kita loop dari item terakhir (terkuat/terlangka) ke item pertama
        for i = #config.List, 1, -1 do
            -- Cek apakah pemain punya item index ke-i (disimpan sebagai string "1", "2", dst)
            if pData.Vault[rollType][tostring(i)] == true then
                local itemData = config.List[i]
                if itemData and itemData.Template then
                    return "rbxassetid://" .. tostring(itemData.Template)
                end
            end
        end
    end

    -- 2. Jika belum punya item apapun, pakai gambar default dari Config
    if config and config.ImageId then
        local cleanId = tostring(config.ImageId):gsub("rbxassetid://", "")
        return "rbxassetid://" .. cleanId
    end

    -- 3. Fallback terakhir: Cek Billboard Workspace
    local assetId = nil
    pcall(function()
        local machine = Workspace.Billboards.CrateRoll:FindFirstChild(rollType)
        if machine and machine:FindFirstChild("icon") then
            assetId = machine.icon.Image
        end
    end)
    
    return assetId or defaultIcon
end

-- [FUNGSI HELPER GRADIENT]
local function GetGameGradient(rarityName)
    local rf = game:GetService("ReplicatedFirst")
    local success, gradientObj = pcall(function()
        return rf.Assets.Gradients.Rarity:FindFirstChild(rarityName)
    end)
    if success and gradientObj then return gradientObj.Color end
    local fallback = rf.Assets.Gradients.Rarity:FindFirstChild("Common")
    return fallback and fallback.Color or nil
end

-- [HELPER: GENERATE CARD REWARDS]
local function GenerateCardRewards(chanceRewardData)
    local rewardCards = {}
    if not chanceRewardData then return rewardCards end

    -- Isi rawCards dengan data lengkap, termasuk kriteria untuk sorting
    local rawCards = {}

    for rewardKey, chanceVal in pairs(chanceRewardData) do
        local parts = string.split(rewardKey, ".")
        local category = parts[1]
        local itemId = parts[2]
        
        local itemData = nil
        -- NOTE: Asumsi MaterialsModule, WeaponsModule, AccessoriesConfig sudah didefinisikan di lingkungan kode.
        if category == "Materials" and MaterialsModule[itemId] then
            itemData = MaterialsModule[itemId]
        elseif category == "Weapons" and WeaponsModule[itemId] then
            itemData = WeaponsModule[itemId]
        elseif category == "Accessories" and AccessoriesConfig[itemId] then
            itemData = AccessoriesConfig[itemId]
        end

        if itemData then
            local imgId = itemData.Template
            if imgId then
                if not tostring(imgId):find("rbxassetid://") then
                    imgId = "rbxassetid://" .. tostring(imgId)
                else
                    imgId = tostring(imgId)
                end
                
                local rarity = itemData.Rarity or "Common"
                local itemName = itemData.Display or itemId
                local chanceStr = "Rate:" .. tostring(chanceVal) .. "%"

                table.insert(rawCards, {
                    Image = imgId,
                    Gradient = GetGameGradient(rarity),
                    Quantity = chanceStr,
                    Title = itemName,
                    
                    -- Kriteria Sorting Tambahan (hanya untuk internal)
                    ChanceValue = chanceVal, -- Prioritas 1
                    ItemId = itemId,         -- Prioritas 2
                    Category = category      -- Prioritas 3
                })
            end
        end
    end

    -- Blok kode untuk menyortir rawCards berdasarkan 3 kriteria
    table.sort(rawCards, function(a, b)
        -- PRIORITAS 1: ChanceValue (Menurun)
        if a.ChanceValue ~= b.ChanceValue then
            return a.ChanceValue > b.ChanceValue
        end
        
        -- PRIORITAS 2: ItemId (Menaik/Alfabetis)
        if a.ItemId ~= b.ItemId then
            return a.ItemId < b.ItemId
        end

        -- PRIORITAS 3: Category (Menaik/Alfabetis)
        return a.Category < b.Category
    end)
    
    -- Memindahkan data yang sudah disortir ke rewardCards dan membersihkan field sementara
    for _, card in ipairs(rawCards) do
        table.insert(rewardCards, {
            Image = card.Image,
            Gradient = card.Gradient,
            Quantity = card.Quantity,
            Title = card.Title
        })
    end

    return rewardCards
end

-- [MODIFIKASI BARU: UPDATE RefreshEnemyData]
local function RefreshEnemyData()
    local uiList = {}
    
    -- Pastikan Config dan Zone valid
    if EnemiesConfig and CurrentZoneName and CurrentZoneName ~= "" and CurrentZoneName ~= "Unknown" then
        local added = {}
        
        for key, data in pairs(EnemiesConfig) do
            if data.Zone == CurrentZoneName then
                local displayName = data.Display or key
                
                -- Hindari duplikasi musuh
                if not added[displayName] then
                    added[displayName] = true
                    data.ChanceReward["Materials.AvatarToken.5"] = 5
                    
                    local rewardImages = GenerateCardRewards(data.ChanceReward)

                    table.insert(uiList, {
                        Title = displayName .. " (" .. (data.Difficult or "Normal") .. ")",
                        Value = displayName,
                        Desc = "HP: " .. UtilsModule.ToText((data.MaxHealth or 0)),
                        HP = data.MaxHealth or 0,
                        Images = rewardImages -- List ini sekarang berisi TABLE Card Data, bukan string ID lagi
                    })
                end
            end
        end
    end
    
    table.sort(uiList, function(a, b) return a.HP < b.HP end)
    CurrentZoneEnemiesCache = uiList
    return uiList
end
getgenv().Controller = MainController
local function UpdateLiveEnemies()
    -- Reset map
    local newMap = {}
    
    if MainController and MainController.Enemies then
        for uid, enemyData in pairs(MainController.Enemies) do
            -- Validasi dasar: Pastikan musuh hidup dan memiliki Data/Config
            if enemyData.Alive and enemyData.Data and enemyData.Config and enemyData.Root then
                
                -- Ambil kunci identifikasi (Nama Tampilan atau Index Internal)
                local display = enemyData.Config.Display -- Contoh: "Blind"
                local index = enemyData.Data.Index -- Contoh: "ParadisEnemy4"
                
                -- Masukkan ke dalam map berdasarkan Display Name (untuk yang dipilih via Dropdown)
                if display then
                    if not newMap[display] then newMap[display] = {} end
                    table.insert(newMap[display], enemyData)
                end

                -- Masukkan juga berdasarkan Index (backup jika nama display sama)
                if index and index ~= display then
                    if not newMap[index] then newMap[index] = {} end
                    table.insert(newMap[index], enemyData)
                end
            end
        end
    end
    
    GlobalEnemyMap = newMap
end

task.delay(1.0, function()
    Window:CollapseSidebar()
end)

task.delay(3.0, function()
    Window:ExpandSidebar()
end)
task.spawn(function()
    task.wait(1)
    while Window and not Window.Destroyed do
        if Config.AutoFarm or Config.AutoGamemode or (Window and not Window.Closed) then
            pcall(UpdateLiveEnemies)
        end
        task.wait(1)
    end
end)

local function Notify(title, content, icon)
    if l then l:Notify({ Title = title, Content = content, Icon = icon, Duration = 3 }) end
end
local GameIconURL = "rbxthumb://type=GameIcon&id=" .. game.GameId .. "&w=150&h=150"
local BaseProfile = {
    Banner = "rbxassetid://124762019485618", Avatar = "rbxassetid://84366761557806", Status = true,
    Badges = {
        {
            Icon = "geist:logo-discord", Title = "Discord", Desc = "Join ANHUB Discord",
            Callback = function() setclipboard("https://discord.gg/cy6uMRmeZ") Notify("Discord", "Invite link copied to clipboard!", "geist:logo-discord") end
        },
        {
            Icon = "youtube", Desc = "Subscribe to YouTube",
            Callback = function() setclipboard("https://www.youtube.com/@ANHubRoblox") Notify("YouTube", "Channel link copied!", "youtube") end
        }
    }
}

local function MakeProfile(data)
    local p = table.clone(BaseProfile)
    for k, v in pairs(data or {}) do p[k] = v end
    return p
end

Window:Tab({
    Profile = MakeProfile({ Title = "ANHub Script", Desc = "Anime Weapons",
    Badges = {
        {
            Icon = "geist:logo-discord", Desc = "Join ANHUB Discord",
            Callback = function() setclipboard("https://discord.gg/cy6uMRmeZ") Notify("Discord", "Invite link copied to clipboard!", "geist:logo-discord") end
        },
        {
            Icon = "youtube", Desc = "Subscribe to YouTube",
            Callback = function() setclipboard("https://www.youtube.com/@ANHubRoblox") Notify("YouTube", "Channel link copied!", "youtube") end
        }
    } }),
    SidebarProfile = true
})

do
    Window:Tag({
        Title = "v" .. ANUI.Version,
        Icon = "github",
        Color = Color3.fromHex("#ff0000")
    });
end;

if not isfile(ExpiryFile) then
    writefile(ExpiryFile, tostring(os.time() + 86400));
end;

Window:OnDestroy(function()
    Config.AutoFarm = false;
    Config.AutoGamemode = false;
    Config.AutoFuse = false;
    Config.AutoRankUp = false;
    Config.AutoRollBiju = false;
    Config.AutoRollRace = false;
    Config.AutoRollSayajin = false;
    Config.AutoYen_Luck = false;
    Config.AutoYen_Damage = false;
    Config.AutoYen_Yen = false;
    Config.AutoYen_Mastery = false;
    Config.AutoYen_Critical = false;
    Config.GM_AutoJoin = false;
    Config.GM_AutoKill = false;
    Config.GM_AutoCreate = false;
    if CurrentZoneName ~= "" and Config.SelectedEnemy then
        SaveZoneConfig(CurrentZoneName, Config.SelectedEnemy);
    end;
end);
LocalPlayer.CharacterAdded:Connect(function(char)
    hrp = char:WaitForChild("HumanoidRootPart");
    humanoid = char:WaitForChild("Humanoid");
end);
pcall(function()
    if LocalPlayer.Character then
        hrp = LocalPlayer.Character:FindFirstChild("HumanoidRootPart");
        humanoid = LocalPlayer.Character:FindFirstChild("Humanoid");
    end;
end);
local function MaintainAutoStatus()
    while not Window.Destroyed do
        if Config.AutoFarm or Config.AutoGamemode then
            local Data = (getgenv()).PlayerData;
            if Data and Data.Settings and Reliable then
                if Data.Settings.AutoClick == false then
                    pcall(function()
                        Reliable:FireServer("Settings", {
                            "AutoClick",
                            true
                        });
                    end);
                end;
                if Data.Settings.AutoAttack == false then
                    pcall(function()
                        Reliable:FireServer("Settings", {
                            "AutoAttack",
                            true
                        });
                    end);
                end;
            end;
        end;
        task.wait(1);
    end;
end;
local function isPlayerInZone(zone)
    local chars = zone:FindFirstChild("Characters");
    if chars and chars:FindFirstChild(LocalPlayer.Name) then
        return true;
    end;
    return false;
end;
local function GetCurrentMapStatus()
    -- [1] Cek Data Controller
    local attr = MainController and MainController.Data and MainController.Data.Attributes
    if attr and attr.Zone and attr.Zone ~= "" then return attr.Zone end

    -- [2] Cek Folder Gamemode (Loop list agar code lebih pendek)
    for _, mode in ipairs({"Dungeon", "Raid", "Defense", "PirateTower", "ShadowGate"}) do
        if Workspace:FindFirstChild(mode) then return mode end
    end

    -- [3] Cek Zone Regions & [4] Deteksi Darurat
    local zonesFolder = Workspace:FindFirstChild("Zones")
    
    if zonesFolder then
        for _, zone in ipairs(zonesFolder:GetChildren()) do
            if isPlayerInZone(zone) then return zone.Name end
        end
    elseif Workspace:FindFirstChild("Enemies") then
        -- Masuk sini hanya jika folder "Zones" TIDAK ada, tapi "Enemies" ada
        return "Dungeon:Active"
    end

    return "Unknown"
end
local function CheckIsFightingZone()
    local mapName = GetCurrentMapStatus()
    -- List kata kunci mode bertarung
    local fightingKeywords = {"Dungeon", "Raid", "Defense", "PirateTower", "ShadowGate"}

    -- Loop cek satu per satu
    for _, keyword in ipairs(fightingKeywords) do
        if string.find(keyword,mapName) then
            return true
        end
    end

    return false
end

local function GetPartPosition(obj)
    if typeof(obj) == "Instance" then
        if obj:IsA("Model") then
            return obj:GetPivot().Position
        elseif obj:IsA("BasePart") then
            return obj.Position
        end
    end
    return nil
end
local function GetDistance(a, b)
    local pa = GetPartPosition(a)
    local pb = GetPartPosition(b)
    if pa and pb then
        return (pa - pb).Magnitude
    end
    return math.huge
end
local function LogicAutoFarm()
    local currentTargetObj = nil
    
    while Config.AutoFarm do
        if Window.Destroyed then break end

        -- [TAMBAHAN: PAUSE JIKA METEOR AKTIF]
        if Config.AutoMeteor and MeteorState.IsActive and MeteorState.Position then
            -- Cek apakah kita dilarang (Fighting Zone)
            if not CheckIsFightingZone() then
                -- Reset target farming agar tidak nyangkut
                currentTargetObj = nil 
                -- Diamkan loop farming, biarkan LogicMeteor yang bekerja
                task.wait(0.5)
                continue
            end
        end
        
        -- [LOGIKA FARMING BIASA (NORMAL)]
        if not hrp or not hrp.Parent or not humanoid or humanoid.Health <= 0 then
            currentTargetObj = nil 
            local char = LocalPlayer.Character
            if char then
                hrp = char:FindFirstChild("HumanoidRootPart")
                humanoid = char:FindFirstChild("Humanoid")
            end
            task.wait(1)
        else
            local isTargetStillAlive = false
            if currentTargetObj then
                if currentTargetObj.Parent and currentTargetObj.Root and currentTargetObj.Root.Parent then
                    local data = currentTargetObj.Data
                    local hp = (data and data.Health) or 0
                    local aliveFlag = currentTargetObj.Alive
                    if aliveFlag == true and hp > 0 then
                        isTargetStillAlive = true
                    end
                end
            end

            if not isTargetStillAlive then
                currentTargetObj = nil
            end

            if not currentTargetObj then
                local targetName = Config.SelectedEnemy
                
                if targetName and GlobalEnemyMap[targetName] then
                    local enemyList = GlobalEnemyMap[targetName]
                    local minDistance = math.huge
                    local myPos = hrp.Position
                    
                    for _, enemyObj in ipairs(enemyList) do
                        local data = enemyObj.Data
                        local hp = (data and data.Health) or 0
                        
                        if enemyObj.Alive == true and hp > 0 and enemyObj.Root and enemyObj.Root.Parent then
                            local enemyPos = enemyObj.Root.Position
                            local dist = (myPos - enemyPos).Magnitude
                            
                            if dist < minDistance then
                                minDistance = dist
                                currentTargetObj = enemyObj
                            end
                        end
                    end
                end
            end

            if currentTargetObj and currentTargetObj.Root then
                pcall(function()
                    local enemyCFrame = currentTargetObj.Data.CFrame
                    local attackPos = enemyCFrame * CFrame.new(0, 0, 6) 
                    hrp.CFrame = CFrame.new(attackPos.Position, enemyCFrame.Position)
                    if hrp.AssemblyLinearVelocity.Magnitude > 0 then
                        hrp.AssemblyLinearVelocity = Vector3.new(0,0,0)
                    end
                end)
            end
        end
        
        task.wait() 
    end
end
 
-- [LOOP 2: LOGIC EKSEKUSI AUTO ROLL]
task.spawn(function()
    while not Window.Destroyed do
        local anyRollActive = false
        local pData = (getgenv()).PlayerData
        
        if pData and pData.Materials then
            for _, rollType in ipairs(AllRollTypes) do
                -- Cek apakah toggle dinyalakan user
                if Config["AutoRoll" .. rollType] then
                    anyRollActive = true
                    
                    local config = RollConfigs[rollType]
                    local cost = config and config.Cost or 1
                    local tokenKey = config and config.MaterialKey or (rollType .. "Token")
                    local currentCount = pData.Materials[tokenKey] or 0
                    
                    -- [LOGIKA BARU]
                    -- Hanya FireServer jika material CUKUP.
                    -- Jika tidak cukup, dia akan diam (skip), TAPI Config tetap TRUE (Toggle ON).
                    if currentCount >= cost then
                        if Reliable then
                            pcall(function()
                                Reliable:FireServer("Crate Roll Start", {
                                    rollType,
                                    false -- Single Roll
                                })
                            end)
                        end
                        -- Delay per roll agar tidak spam parah/kick
                        task.wait(1.5) 
                    end
                end
            end
        end
        
        -- Jika tidak ada satupun auto roll yang nyala, delay lebih lama biar hemat resource
        if not anyRollActive then
            task.wait(1)
        end
        task.wait(0.1)
    end
end)

-- [MODIFIKASI: ANTI-LAYOVER / HAPUS ANIMASI GACHA]
task.spawn(function()
    local Players = game:GetService("Players")
    local LocalPlayer = Players.LocalPlayer
    local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

    while Window and not Window.Destroyed do
        -- Cek apakah ada Auto Roll yang sedang aktif di Config
        local isRolling = false
        if AllRollTypes then
            for _, rollType in ipairs(AllRollTypes) do
                if Config["AutoRoll" .. rollType] then
                    isRolling = true
                    break
                end
            end
        end

        if isRolling then
            -- [FIX] Hapus UI Overlay bernama "Rolls" (Berdasarkan CrateRoll.c)
            -- Kita pakai pcall agar tidak error jika UI sedang dimanipulasi game
            pcall(function()
                local rollsUI = PlayerGui:FindFirstChild("Rolls")
                if rollsUI then
                    rollsUI.Enabled = false -- Matikan dulu visibilitasnya
                    rollsUI.Parent = nil    -- Buang dari PlayerGui
                end
                
                -- Jaga-jaga jika namanya berubah jadi "Crate" (Backup logic)
                local crateUI = PlayerGui:FindFirstChild("Crate")
                if crateUI then
                    crateUI.Enabled = false
                    crateUI.Parent = nil
                end
            end)

            -- [FIX] Paksa UI Utama Muncul Kembali
            -- Game mematikan ini di baris 175 CrateRoll.c (arg1.Screen.Enabled = false)
            local screenUI = PlayerGui:FindFirstChild("Screen")
            if screenUI and not screenUI.Enabled then
                screenUI.Enabled = true
            end

            -- [FIX] Paksa Topbar Muncul Kembali
            -- Game mematikan ini di baris 176 CrateRoll.c
            local topbarUI = PlayerGui:FindFirstChild("TopbarStandard")
            if topbarUI and not topbarUI.Enabled then
                topbarUI.Enabled = true
            end
        end
        
        -- Cek setiap 0.1 detik agar responsif tapi tidak lag
        task.wait(0.1)
    end
end)
local InfoTab = Window:Tab({
    Title = "Info",
    Icon = "info"
});
local s, tUrl = pcall(function()
    return Players:GetUserThumbnailAsync(LocalPlayer.UserId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size150x150);
end);
local PlayerParagraph = InfoTab:Paragraph({
    Title = LocalPlayer.DisplayName,
    Desc = "User ID: " .. tostring(LocalPlayer.UserId) .. "\nKey Valid: Verifying...",
    Image = s and tUrl or "rbxassetid://84366761557806",
    ImageSize = 48,
    Buttons = {
        {
            Title = "Copy HWID",
            Icon = "copy",
            Callback = function()
                setclipboard(tostring(gethwid and gethwid() or LocalPlayer.UserId));
            end
        }
    }
});
task.spawn(function()
    while not Window.Destroyed do
        local success, result = pcall(function()
            if isfile(ExpiryFile) then
                return tonumber(readfile(ExpiryFile)) or 0;
            end;
            return 0;
        end);
        local statusText = "Checking...";
        if success and result > 0 then
            local diff = result - os.time();
            if diff > 0 then
                local h = math.floor(diff / 3600);
                local m = math.floor(diff % 3600 / 60);
                statusText = string.format("%02dh %02dm", h, m);
            else
                statusText = "EXPIRED";
            end;
        else
            statusText = "No Timer";
        end;
        if PlayerParagraph and PlayerParagraph.SetDesc then
            pcall(function()
                PlayerParagraph:SetDesc("User ID: " .. tostring(LocalPlayer.UserId) .. "\nKey Valid: " .. statusText);
            end);
        end;
        task.wait(1);
    end;
end);
local CommunitySection = InfoTab:Section({
    Title = "Community",
    Icon = "users",
    Opened = true
});
local DiscordInfo = InfoTab:Paragraph({
    Title = "Loading...",
    Desc = "...",
    Image = "rbxassetid://84366761557806",
    ImageSize = 42,
    Buttons = {
        {
            Title = "Copy Discord",
            Icon = "copy",
            Callback = function()
                setclipboard("https://discord.gg/cy6uMRmeZ");
            end
        }
    }
});
task.spawn(function()
    local API = "https://discord.com/api/v10/invites/cy6uMRmeZ?with_counts=true&with_expiration=true";
    local s, r = pcall(function()
        return HttpService:JSONDecode((l.Creator.Request({
            Url = API,
            Method = "GET"
        })).Body);
    end);
    if s and r and r.guild then
        DiscordInfo:SetTitle(r.guild.name);
        DiscordInfo:SetDesc("Members: " .. r.approximate_member_count .. "\nOnline: " .. r.approximate_presence_count);
    else
        DiscordInfo:SetTitle("Discord Error");
        DiscordInfo:SetDesc("Failed to fetch info.");
    end;
end);

local FarmTab = Window:Tab({
    Title = "Main Feature",
    Icon = "swords",
        Profile = MakeProfile({
            Avatar = GameIconURL,
            Title = "Main Feature",
            Desc = "Anime Weapons"
        }),
        
        SidebarProfile = false -- Mode Tab Biasa
});

local FM_Categories = {}
local FM_CategoryDescriptions = {
    ["Farm"] = "Auto farm enemies per zone and specific targets",
    ["GameModes"] = "Auto Join & Farm Dungeons/Raids by Time",
    ["Vault"] = "Auto Equipped Best Vault for battle/lobby",
    ["Avatar Level"] = "Upgrade Avatar Level, view stats and costs",
    ["Heroes Stats"] = "Reroll Heroes Stats, view stats and costs",
    ["Ascension"] = "You can exchange all your level progress to obtain boosts.",
    ["Enchantments"] = "Add Stats Enchantments To Your Weapon.",
    ["Exchange"] = "Exchange materials, preview tokens and calculate amounts",
    ["Rolls"] = "Auto roll various gachas and monitor material stock",
    ["Upgrade: Yen"] = "Upgrade Yen buff along with cost and effects",
    ["Upgrade: Token"] = "Upgrade Token buff with shards",
    ["Rankup"] = "Rank progress, requirements, and bonuses",
    ["Trainers"] = "Trainer settings and enhancement",
    ["Crafts"] = "Auto craft/upgrade items and equipment"
}
local function FM_GetElementFrame(elem)
    local f = rawget(elem, "ElementFrame") or (elem.UIElements and elem.UIElements.Main) or rawget(elem, "GroupFrame")
    return f
end
local function FM_Add(cat, elem)
    if not FM_Categories[cat] then FM_Categories[cat] = {} end
    table.insert(FM_Categories[cat], elem)
    local frame = FM_GetElementFrame(elem)
    if frame then frame.Visible = false end
    return elem
end
local function FM_UpdateTabProfile(selected)
    local desc = FM_CategoryDescriptions[selected] or ""
    local containers = {}
    if FarmTab and FarmTab.UIElements then
        table.insert(containers, FarmTab.UIElements.ContainerFrameCanvas)
        table.insert(containers, FarmTab.UIElements.ContainerFrame)
    end
    for _, cf in ipairs(containers) do
        if cf then
            local header = cf:FindFirstChild("ProfileHeader")
            if header then
                local tc = header:FindFirstChild("TextContainer")
                if tc then
                    for _, child in ipairs(tc:GetChildren()) do
                        if child:IsA("TextLabel") then
                            if child.LayoutOrder == 1 then child.Text = selected end
                            if child.LayoutOrder == 2 then child.Text = desc end
                        end
                    end
                end
            end
        end
    end
end
local function FM_OnChange(selected)
    for name, elems in pairs(FM_Categories) do
        local vis = (name == selected)
        for _, e in ipairs(elems) do
            local f = FM_GetElementFrame(e)
            if f then f.Visible = vis end
        end
    end
    pcall(function()
        FM_UpdateTabProfile(selected)
    end)
end
local FM_Category = FarmTab:Category({
    Title = "Select Category",
    Default = "Farm",
    Options = {
        {Title="Farm", Icon="rbxassetid://72039606576980"},
        {Title="GameModes", Icon="rbxassetid://109634928579023"},
        {Title="Vault", Icon="rbxassetid://90798559571883"},
        {Title="Avatar Level", Icon=GetAvatarTokenIcon()},
        {Title="Heroes Stats", Icon="rbxassetid://127892390350003"},
        {Title="Ascension", Icon="rbxassetid://84524784941090"},
        {Title="Enchantments", Icon="rbxassetid://104488852837942"},
        {Title="Exchange", Icon="rbxassetid://101595095661272"},
        {Title="Rolls", Icon="rbxassetid://128047949460588"},
        {Title="Upgrade: Yen", Icon=GetYenIcon()},
        {Title="Upgrade: Token", Icon="rbxassetid://124644932563791"},
        {Title="Rankup", Icon=GetDynamicRankIcon()},
        {Title="Trainers", Icon=GetTrainerIcon()},
        {Title="Crafts", Icon="rbxassetid://132575095676543"}
    },
    Callback = FM_OnChange
})

if FM_Category.ElementFrame then 
    FM_Category.ElementFrame.Parent = FarmTab.UIElements.ContainerFrameCanvas 
    FM_Category.ElementFrame.Position = UDim2.new(0,0,0, FarmTab.UIElements.ContainerFrame.Position.Y.Offset)
    
    local catSize = FM_Category.ElementFrame.Size.Y.Offset
    FarmTab.UIElements.ContainerFrame.Position = UDim2.new(0,0,0, FarmTab.UIElements.ContainerFrame.Position.Y.Offset + catSize)
    FarmTab.UIElements.ContainerFrame.Size = UDim2.new(1, 0, 1, FarmTab.UIElements.ContainerFrame.Size.Y.Offset - catSize)
    
    local pad = FarmTab.UIElements.ContainerFrame:FindFirstChildOfClass("UIPadding")
    if pad then pad.PaddingTop = UDim.new(0, 5) end
end
FarmTab:Space({Columns=1})

-- [MODIFIKASI: DROPDOWN UNTUK ENEMIES DENGAN IMAGES]
EnemyDropdown = FarmTab:Dropdown({
    Title = "Select Enemy",
    Multi = false,
    Values = {},
    ImageSize = UDim2.fromOffset(20, 20), -- Mengatur ukuran gambar
    ImagePadding = 6, -- Jarak antar gambar
    Flag = "TargetEnemies_Cfg",
    Callback = function(selectedItem)
        if IsLoadingConfig then
            return;
        end;
        SaveZoneConfig(CurrentZoneName, selectedItem);
    end
});
FM_Add("Farm", EnemyDropdown);
local RefreshBtn = FarmTab:Button({
    Title = "Refresh List",
    Icon = "refresh-cw",
    Callback = function()
        EnemyDropdown:Refresh(RefreshEnemyData());
    end
});
FM_Add("Farm", RefreshBtn);
local FarmToggle = FarmTab:Toggle({
    Title = "Auto Farm",
    Flag = "AutoFarm_Cfg",
    Callback = function(val)
        Config.AutoFarm = val;
        if val then
            task.spawn(LogicAutoFarm);
        end;
    end
});
FM_Add("Farm", FarmToggle);

-- [METEOR LOGIC LOOP]
task.spawn(function()
    while not Window.Destroyed do
        if Config.AutoMeteor then
            -- 1. Validasi Dasar & Fighting Zone
            if CheckIsFightingZone() then
                -- Jika sedang perang (Raid/Dungeon), abaikan Meteor
                task.wait(1)
            
            elseif MeteorState.IsActive and MeteorState.Position and MeteorState.Zone then
                local currentMap = GetCurrentMapStatus()
                local pData = getgenv().PlayerData
                
                -- 2. Cek Apakah Kita di Zone yang Tepat?
                if currentMap ~= MeteorState.Zone then
                    if not IsTeleporting then
                        Notify("Meteor Event", "Teleporting to Meteor Zone: " .. MeteorState.Zone, "rocket")
                        if Reliable then
                            pcall(function()
                                Reliable:FireServer("Zone Teleport", { MeteorState.Zone })
                            end)
                        end
                        IsTeleporting = true -- Flag manual biar gak spam
                        task.wait(4) -- Tunggu loading screen
                        IsTeleporting = false
                    end
                else
                    -- 3. Jika Sudah di Zone, Tunggu Meteor Mendarat
                    local timeLeft = MeteorState.LandTime - os.time()
                    
                    if timeLeft > 0 then
                        -- Meteor sedang jatuh (di udara), kita tunggu sebentar
                        -- Opsional: Bisa teleport ke dekatnya dulu biar siap
                        if hrp then
                             -- Teleport aman di udara (dikit) sambil nunggu
                             -- hrp.CFrame = CFrame.new(MeteorState.Position + Vector3.new(0, 50, 0))
                             -- Tapi user minta pas di tanah, jadi kita diam saja atau mendekat pelan
                        end
                    else
                        -- 4. Meteor Sudah Mendarat -> Teleport Pas di Tanah
                        if hrp then
                            -- Target: Posisi Meteor + 4 Stud Y (Biar berdiri pas di tanah)
                            local targetPos = MeteorState.Position + Vector3.new(0, 4, 0)
                            
                            -- Cek jarak biar ga spam teleport kalo udah dekat
                            if (hrp.Position - targetPos).Magnitude > 5 then
                                hrp.CFrame = CFrame.new(targetPos)
                                -- Reset Velocity biar gak mental
                                hrp.AssemblyLinearVelocity = Vector3.new(0,0,0) 
                            end
                        end
                    end
                end
            end
        end
        task.wait(0.1)
    end
end)

local MeteorToggle = FarmTab:Toggle({
    Title = "Auto Farm Meteor",
    Desc = "Auto teleport & wait for Meteor Event. Pauses normal farm.",
    Flag = "AutoMeteor_Cfg",
    Callback = function(val)
        Config.AutoMeteor = val
    end
});
FM_Add("Farm", MeteorToggle);
local function LogicGamemodes()
    local wasInGamemode = false;
    local currentTargetObj = nil;
    local hasTeleportedToBossInRaid = false;
    
    local hrp = (LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart"))

    while Config.AutoDungeon do
        if Window.Destroyed then break end;
        
        if not hrp or not hrp.Parent then
             hrp = (LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart"))
        end

        local currentMap = GetCurrentMapStatus();
        local inLobbyZone = false;
        
        if Workspace:FindFirstChild("Zones") and Workspace.Zones:FindFirstChild("Dungeon") then
            if isPlayerInZone(Workspace.Zones.Dungeon) then
                inLobbyZone = true;
            end;
        end;

        local EnemiesFolder = Workspace:FindFirstChild("Enemies")
        local hasEnemies = EnemiesFolder and #EnemiesFolder:GetChildren() > 0
        local isFightingZone = (string.find(currentMap, ":") and (string.find(currentMap, "Dungeon") or string.find(currentMap, "Raid") or string.find(currentMap, "Defense") or currentMap == "PirateTower" or currentMap == "ShadowGate") or (currentMap == "PirateTower" or currentMap == "ShadowGate"))
        
        if currentMap == "Raid" then isFightingZone = true 
        elseif currentMap == "Defense" then isFightingZone = hasEnemies
        elseif currentMap == "PirateTower" or currentMap == "ShadowGate" then isFightingZone = true 
        end

        if currentMap ~= "Unknown" and not isFightingZone and not inLobbyZone and not string.find(currentMap, ":") and not wasInGamemode then
            LastZone = getgenv().PlayerData.Attributes.LastZone
        end

        if currentMap ~= "Unknown" then
            if isFightingZone then
                wasInGamemode = true;
                if Config.GM_AutoKill then
                    local isTargetStillAlive = false
                    if currentTargetObj and currentTargetObj.Parent and currentTargetObj.Root then
                        if currentTargetObj.Data and currentTargetObj.Data.Health > 0 then isTargetStillAlive = true end
                    end
                    if not isTargetStillAlive then currentTargetObj = nil end

                    if not currentTargetObj and MainController and MainController.Enemies then
                        for _, enemy in pairs(MainController.Enemies) do
                            if enemy.Alive then currentTargetObj = enemy; break end
                        end
                    end

                    if currentTargetObj and currentTargetObj.Root then
                        pcall(function()
                            hrp.CFrame = currentTargetObj.Root.CFrame * CFrame.new(0,0,6)
                            hrp.AssemblyLinearVelocity = Vector3.new(0,0,0)
                        end)
                    end
                end
                task.wait()

            elseif wasInGamemode and (not isFightingZone) then
                -- [B. LOGIKA PULANG (SAMA)]
                currentTargetObj = nil;
                hasTeleportedToBossInRaid = false;
                
                if LastZone and LastZone ~= "" and LastZone ~= "Unknown" and not string.find(LastZone, ":") then
                    Notify("Mode Finished", "Returning to " .. LastZone, "map-pin");
                    if Reliable then pcall(function() Reliable:FireServer("Zone Teleport", { LastZone }); end); end;
                    wasInGamemode = false; 
                    task.wait(6);
                else
                    wasInGamemode = false;
                end;

            else
                local function ProcessGameMode(prefix, dbList, selectedList, requiredKey, allowJoin, allowOpen)
                    if not selectedList or #selectedList == 0 then return false end
                    if not allowJoin and not allowOpen then return false end
                    
                    -- Siapkan daftar ID yang mau dicek
                    local modesToCheck = {}
                    if not dbList then
                        -- Single Mode (Pirate/Shadow)
                        -- Phase di-set nil karena mode ini tidak punya sub-phase angka
                        table.insert(modesToCheck, {ID = prefix, Name = prefix, RawPrefix = prefix, Phase = nil})
                    else
                        -- Multi Mode (Dungeon/Raid/Defense)
                        for _, selectedName in pairs(selectedList) do
                            if dbList[selectedName] then
                                -- ID: String gabungan untuk cek status Join (Contoh: "Raid:1")
                                -- Phase: Angka murni untuk request Open (Contoh: 1)
                                table.insert(modesToCheck, {
                                    ID = prefix .. ":" .. tostring(dbList[selectedName].ID), 
                                    Name = selectedName,
                                    RawPrefix = prefix,
                                    Phase = dbList[selectedName].ID
                                })
                            end
                        end
                    end

                    for _, modeData in ipairs(modesToCheck) do
                        local modeID = modeData.ID
                        local modeName = modeData.Name
                        
                        local isJoinable = false
                        local isOpened = false

                        if MainController then
                            if MainController.IsJoinable then isJoinable = MainController.IsJoinable(modeID) end
                            if MainController.IsOpened then isOpened = MainController.IsOpened(modeID) end
                        end

                        if allowJoin and isJoinable and (isOpened or not requiredKey) then
                            Notify("Auto Join", "Joining " .. modeName, "swords")
                            if Reliable then Reliable:FireServer("Join Gamemode", { modeID }) end
                            return true
                        end

                        if requiredKey and allowOpen then
                            local pData = getgenv().PlayerData
                            local keyCount = (pData and pData.Materials and pData.Materials[requiredKey]) or 0
                            
                            if not isOpened and keyCount > 0 then
                                Notify("Auto Open", "Creating " .. modeName .. " (Using Key)", "key")
                                if Reliable then 
                                    -- [PERBAIKAN LOGIC OPEN DISINI]
                                    if modeData.Phase then
                                        -- Jika Mode Ber-Phase (Raid/Defense), Kirim Nama & Phase terpisah
                                        -- Contoh payload: {"Raid", 1}
                                        Reliable:FireServer("Open Gamemode", { modeData.RawPrefix, modeData.Phase }) 
                                    else
                                        -- Jika Mode Single (ShadowGate), Kirim ID utuh
                                        -- Contoh payload: {"ShadowGate"}
                                        Reliable:FireServer("Open Gamemode", { modeID }) 
                                    end
                                end
                                return true
                            end
                        end
                    end
                    return false
                end

                local actionTaken = false
                local allowJoin = Config.GM_AutoJoin
                local allowOpen = Config.GM_AutoCreate

                if not actionTaken then actionTaken = ProcessGameMode("PirateTower", nil, Config.TargetPirateTower, "PirateTowerModeKey", allowJoin, allowOpen) end
                if not actionTaken then actionTaken = ProcessGameMode("ShadowGate", nil, Config.TargetShadowGate, "ShadowPortalModeKey", allowJoin, allowOpen) end
                if not actionTaken then actionTaken = ProcessGameMode("Raid", raidDB, Config.TargetRaid, "RaidModeKey", allowJoin, allowOpen) end
                if not actionTaken then actionTaken = ProcessGameMode("Defense", defenseDB, Config.TargetDefense, "DefenseModeKey", allowJoin, allowOpen) end
                
                if not actionTaken then actionTaken = ProcessGameMode("Dungeon", dungeonDB, Config.TargetDungeon, nil, allowJoin, false) end

                if actionTaken then
                    task.wait(5)
                else
                    task.wait(1)
                end
            end;
        else
            task.wait(1);
        end;
    end;
end;

-- [1. PIRATE TOWER DATA]
local pirateTowerList = {}
local function LoadPirateTowerData()
    local success, module = pcall(function()
        return require(ReplicatedStorage.Scripts.Configs.Gamemodes.PirateTower);
    end);
    if success and module then
        local hpBase = module.GetRecommendedPower(module.HealthBase) or 0
        local floors = module.MAX_FLOOR or 100
        local desc = "Max Floors: " .. floors .. " | HP Base: " .. UtilsModule.ToText(hpBase);
        local rewardCards = GenerateCardRewards(module.ChanceReward)

        pirateTowerList = {{
            Title = module.Display or "Pirate Tower",
            Value = "PirateTower",
            Desc = desc,
            Images = rewardCards
        }}
    end;
end;
LoadPirateTowerData();

-- [2. SHADOW GATE DATA]
local shadowGateList = {}
local function LoadShadowGateData()
    local success, module = pcall(function()
        return require(ReplicatedStorage.Scripts.Configs.Gamemodes.ShadowGate);
    end);
    if success and module then
        local hpBase = module.GetRecommendedPower(module.HealthBase) or 0
        local waves = module.MAX_WAVE or 500
        local desc = "Max Waves: " .. waves .. " | HP Base: " .. UtilsModule.ToText(hpBase);
        local rewardCards = GenerateCardRewards(module.ChanceReward)

        shadowGateList = {{
            Title = module.Display or "Shadow Gate",
            Value = "ShadowGate",
            Desc = desc,
            Images = rewardCards
        }}
    end;
end;
LoadShadowGateData();

-- [3. DUNGEON DATA]
local function LoadDungeonData()
    local success, module = pcall(function()
        return require(ReplicatedStorage.Scripts.Configs.Gamemodes.Dungeon);
    end);
    if success and module and module.PHASES then
        dungeonList, dungeonDB = {}, {};
        for id, phase in ipairs(module.PHASES) do
            local rName = phase.Name;
            local hpCalc = module.GetRecommendedPower(phase.HealthBase);
            
            -- [OPTIMASI: Format Jadwal agar rapi]
            local times = phase.START_TIMES or {}
            table.sort(times)
            local timeStr = table.concat(times, ", ")
            local desc = "HP: " .. UtilsModule.ToText(hpCalc);
            
            local rewardCards = GenerateCardRewards(phase.ChanceReward)

            table.insert(dungeonList, {
                Title = rName,
                Desc = desc,
                Value = rName,
                Images = rewardCards
            });
            dungeonDB[rName] = {
                ID = id,
                Times = phase.START_TIMES,
                BaseDesc = desc
            };
        end;
    end;
end;
LoadDungeonData();

-- [4. RAID DATA]
local function LoadRaidData()
    local success, module = pcall(function()
        return require(ReplicatedStorage.Scripts.Configs.Gamemodes.Raid);
    end);
    if success and module and module.PHASES then
        raidList, raidDB = {}, {};
        for id, phase in ipairs(module.PHASES) do
            local rName = phase.Name;
            local hpCalc = module.GetRecommendedPower(phase.HealthBase);
            
            -- [OPTIMASI: Format Jadwal agar rapi]
            local times = phase.START_TIMES or {}
            table.sort(times)
            local timeStr = table.concat(times, ", ")
            local desc = "HP: " .. UtilsModule.ToText(hpCalc) .. " | Mins: " .. timeStr;
            
            local rewardCards = GenerateCardRewards(phase.ChanceReward)

            table.insert(raidList, {
                Title = rName,
                Desc = desc,
                Value = rName,
                Images = rewardCards
            });
            raidDB[rName] = {
                ID = id,
                Times = phase.START_TIMES,
                BaseDesc = desc
            };
        end;
    end;
end;
LoadRaidData();

-- [5. DEFENSE DATA]
local function LoadDefenseData()
    local success, module = pcall(function()
        return require(ReplicatedStorage.Scripts.Configs.Gamemodes.Defense);
    end);
    if success and module and module.PHASES then
        defenseList, defenseDB = {}, {};
        for id, phase in ipairs(module.PHASES) do
            local rName = phase.Name;
            local hpCalc = module.GetRecommendedPower(phase.HealthBase);
            
            local times = phase.START_TIMES or {}
            table.sort(times)
            local timeStr = table.concat(times, ", ")
            local desc = "HP: " .. UtilsModule.ToText(hpCalc) .. " | Mins: " .. timeStr;

            local rewardCards = GenerateCardRewards(phase.ChanceReward)

            table.insert(defenseList, {
                Title = rName,
                Desc = desc,
                Value = rName,
                Images = rewardCards
            });
            defenseDB[rName] = {
                ID = id,
                Times = phase.START_TIMES,
                BaseDesc = desc
            };
        end;
    end;
end;
LoadDefenseData();

local DgnDrop = FM_Add("GameModes", FarmTab:Dropdown({
    Title = "Select Dungeon",
    Multi = true,
    AllowNone = true,
    Flag = "DungeonDiff_Cfg",
    Values = dungeonList,
    ImageSize = UDim2.fromOffset(20, 20),
    ImagePadding = 6,
    Callback = function(val)
        local t = {};
        for _, v in pairs(val) do
            table.insert(t, type(v) == "table" and v.Value or v);
        end;
        Config.TargetDungeon = t;
    end
}));

local RaidDrop = FM_Add("GameModes", FarmTab:Dropdown({
    Title = "Select Raid",
    Multi = true,
    AllowNone = true,
    Flag = "RaidDiff_Cfg",
    Values = raidList,
    ImageSize = UDim2.fromOffset(20, 20),
    ImagePadding = 6,
    Callback = function(val)
        local t = {};
        for _, v in pairs(val) do
            table.insert(t, type(v) == "table" and v.Value or v);
        end;
        Config.TargetRaid = t;
    end
}));

local DefenseDrop = FM_Add("GameModes", FarmTab:Dropdown({
    Title = "Select Defense",
    Multi = true,
    AllowNone = true,
    Flag = "DefenseDiff_Cfg",
    Values = defenseList,
    ImageSize = UDim2.fromOffset(20, 20),
    ImagePadding = 6,
    Callback = function(val)
        local t = {};
        for _, v in pairs(val) do
            table.insert(t, type(v) == "table" and v.Value or v);
        end;
        Config.TargetDefense = t;
    end
}));

local PirateTowerDrop = FM_Add("GameModes", FarmTab:Dropdown({
    Title = "Select Pirate Tower",
    Multi = true,
    AllowNone = true,
    Flag = "PirateTower_Cfg",
    Values = pirateTowerList,
    ImageSize = UDim2.fromOffset(20, 20),
    ImagePadding = 6,
    Callback = function(val)
        local t = {};
        for _, v in pairs(val) do
            table.insert(t, type(v) == "table" and v.Value or v);
        end;
        Config.TargetPirateTower = t;
    end
}));

local ShadowGateDrop = FM_Add("GameModes", FarmTab:Dropdown({
    Title = "Select Shadow Gate",
    Multi = true, 
    AllowNone = true,
    Flag = "ShadowGate_Cfg",
    Values = shadowGateList,
    ImageSize = UDim2.fromOffset(20, 20),
    ImagePadding = 6,
    Callback = function(val)
        local t = {};
        for _, v in pairs(val) do
            table.insert(t, type(v) == "table" and v.Value or v);
        end;
        Config.TargetShadowGate = t;
    end
}));

-- [NOTE: Loop Update Raid & Defense DIHAPUS demi performa]

local ModeToggle = FM_Add("GameModes", FarmTab:Toggle({
    Title = "Enable Gamemodes Logic",
    Flag = "AutoDungeon_Cfg",
    Callback = function(val)
        Config.AutoDungeon = val;
        if val then
            task.spawn(LogicGamemodes);
        end;
    end
}));

local GMJoinToggle = FM_Add("GameModes", FarmTab:Toggle({
    Title = "Auto Join Gamemodes",
    Flag = "GM_AutoJoin_Cfg",
    Callback = function(val)
        Config.GM_AutoJoin = val
    end
}));

local GMKillToggle = FM_Add("GameModes", FarmTab:Toggle({
    Title = "Auto Kill In Gamemodes",
    Flag = "GM_AutoKill_Cfg",
    Callback = function(val)
        Config.GM_AutoKill = val
    end
}));

local GMCreateToggle = FM_Add("GameModes", FarmTab:Toggle({
    Title = "Auto Create Gamemodes (Use Keys)",
    Flag = "GM_AutoCreate_Cfg",
    Callback = function(val)
        Config.GM_AutoCreate = val
    end
}));

-- // [AUTO LEAVE SYSTEM - MULTI MODE] //

-- Group 1: Dungeon & Raid
local LeaveGroup1 = FarmTab:Group({})
FM_Add("GameModes", LeaveGroup1)

LeaveGroup1:Input({
    Title = "Dungeon (Room)",
    Value = tostring(Config.AutoLeave_Dungeon or 50),
    Numeric = true,
    Flag = "Leave_Dungeon_Cfg",
    Callback = function(txt) Config.AutoLeave_Dungeon = tonumber(txt) or 50 end
})

LeaveGroup1:Input({
    Title = "Raid (Wave)",
    Value = tostring(Config.AutoLeave_Raid or 25),
    Numeric = true,
    Flag = "Leave_Raid_Cfg",
    Callback = function(txt) Config.AutoLeave_Raid = tonumber(txt) or 25 end
})

-- Group 2: Defense & Pirate Tower
local LeaveGroup2 = FarmTab:Group({})
FM_Add("GameModes", LeaveGroup2)

LeaveGroup2:Input({
    Title = "Defense (Wave)",
    Value = tostring(Config.AutoLeave_Defense or 30),
    Numeric = true,
    Flag = "Leave_Defense_Cfg",
    Callback = function(txt) Config.AutoLeave_Defense = tonumber(txt) or 30 end
})

LeaveGroup2:Input({
    Title = "Pirate Tower (Floor)",
    Value = tostring(Config.AutoLeave_PirateTower or 100),
    Numeric = true,
    Flag = "Leave_Pirate_Cfg",
    Callback = function(txt) Config.AutoLeave_PirateTower = tonumber(txt) or 100 end
})

-- Group 3: Shadow Gate & Master Toggle
local LeaveGroup3 = FarmTab:Group({})
FM_Add("GameModes", LeaveGroup3)

LeaveGroup3:Input({
    Title = "Shadow Gate (Wave)",
    Value = tostring(Config.AutoLeave_ShadowGate or 50),
    Numeric = true,
    Flag = "Leave_Shadow_Cfg",
    Callback = function(txt) Config.AutoLeave_ShadowGate = tonumber(txt) or 50 end
})

LeaveGroup3:Toggle({
    Title = "Enable Auto Leave",
    Desc = "Master switch for auto leaving",
    Flag = "AutoLeave_Cfg",
    Callback = function(val)
        Config.AutoLeave = val
    end
})

-- [LOGIC LOOP BARU]
task.spawn(function()
    while not Window.Destroyed do
        if Config.AutoLeave then
            local PlayerGui = game:GetService("Players").LocalPlayer:FindFirstChild("PlayerGui")
            -- Menggunakan jalur UI yang valid sesuai file Anda: PlayerGui.Screen.Hud.gamemode
            local HudGamemode = PlayerGui and PlayerGui:FindFirstChild("Screen") and PlayerGui.Screen:FindFirstChild("Hud") and PlayerGui.Screen.Hud:FindFirstChild("gamemode")
            
            if HudGamemode and HudGamemode.Visible then
                local currentVal = 0
                local targetLimit = 999999 -- Default tinggi agar tidak leave sembarangan
                local modeActive = false

                -- A. Cek DUNGEON
                local dungeonUI = HudGamemode:FindFirstChild("Dungeon")
                if dungeonUI and dungeonUI.Visible then
                    local txt = dungeonUI.room.amount.Text
                    currentVal = tonumber(string.match(txt, "%d+")) or 0
                    targetLimit = Config.AutoLeave_Dungeon
                    modeActive = true
                end

                -- B. Cek RAID
                if not modeActive then
                    local raidUI = HudGamemode:FindFirstChild("Raid")
                    if raidUI and raidUI.Visible then
                        local txt = raidUI.wave.amount.Text
                        currentVal = tonumber(string.match(txt, "%d+")) or 0
                        targetLimit = Config.AutoLeave_Raid
                        modeActive = true
                    end
                end

                -- C. Cek DEFENSE
                if not modeActive then
                    local defenseUI = HudGamemode:FindFirstChild("Defense")
                    if defenseUI and defenseUI.Visible then
                        local txt = defenseUI.wave.amount.Text
                        currentVal = tonumber(string.match(txt, "%d+")) or 0
                        targetLimit = Config.AutoLeave_Defense
                        modeActive = true
                    end
                end

                -- D. Cek PIRATE TOWER
                if not modeActive then
                    local pirateUI = HudGamemode:FindFirstChild("PirateTower")
                    if pirateUI and pirateUI.Visible then
                        local txt = pirateUI.floor.amount.Text
                        currentVal = tonumber(string.match(txt, "%d+")) or 0
                        targetLimit = Config.AutoLeave_PirateTower
                        modeActive = true
                    end
                end

                -- E. Cek SHADOW GATE
                if not modeActive then
                    local shadowUI = HudGamemode:FindFirstChild("ShadowGate")
                    if shadowUI and shadowUI.Visible then
                        local txt = shadowUI.wave.amount.Text
                        currentVal = tonumber(string.match(txt, "%d+")) or 0
                        targetLimit = Config.AutoLeave_ShadowGate
                        modeActive = true
                    end
                end

                -- [EKSEKUSI LEAVE]
                if modeActive and currentVal >= targetLimit then
                    -- Ambil LastZone yang aman
                    local pData = getgenv().PlayerData
                    local returnZone = (pData and pData.Attributes and pData.Attributes.LastZone) or "Starter Zone"
                    if string.find(returnZone, ":") or returnZone == "Unknown" then returnZone = "Starter Zone" end

                    if Reliable then
                        pcall(function()
                            Reliable:FireServer("Zone Teleport", { returnZone })
                        end)
                        
                        if Notify then 
                            Notify("Auto Leave", "Target Reached ("..currentVal.." / "..targetLimit..")! Leaving...", "log-out") 
                        end
                        task.wait(5) -- Jeda biar ga spam
                    end
                end
            end
        end
        task.wait(1)
    end
end)
-- =========================================================================

FM_OnChange("Farm")

local GeneralTab = Window:Tab({
    Title = "General",
    Icon = "settings"
});

-- [PASTE BAGIAN INI DI ATAS LOGIKA EXCHANGE]
local GeneralManagerSection = FarmTab
local ExchangeList = {}

-- Membangun list item yang bisa ditukar (Exchangeable)
for k, v in pairs(MaterialsModule) do
    if v.Exchangeable and k ~= "TradeToken" then
        table.insert(ExchangeList, {Title = v.Display, Value = k})
    end
end
table.sort(ExchangeList, function(a,b) return a.Title < b.Title end)

local SelectedExToken = nil
local SelectedExIcon = nil
local PrevMaterialsDigest = nil
local ExchangePercent = 1 -- Default 100%
local ExchangeIsBuying = false -- Default Selling (False)

-- Fungsi Helper untuk mengambil Ratio Harga
local function GetExchangeRatio(tokenKey)
    local val = 0.1
    if not tokenKey or not MaterialsModule[tokenKey] then return 0.1 end
    if MaterialsModule[tokenKey].ExchangeRatio then
        val = MaterialsModule[tokenKey].ExchangeRatio
    elseif MaterialsModule[tokenKey].Display == "Trade Token" then
        val = 1
    else
        val = 0.1
    end
    return val
end

local function GetMaterialsDigest()
    local pData = (getgenv()).PlayerData
    local keys = {}
    if pData and pData.Materials then
        for k,_ in pairs(pData.Materials) do
            table.insert(keys, k)
        end
    end
    table.sort(keys)
    return table.concat(keys, "|")
end

local function BuildExchangeValues()
    local pData = (getgenv()).PlayerData
    local mats = {}
    for _, item in ipairs(ExchangeList) do
        local key = item.Value
        local info = MaterialsModule[key]
        -- Mengambil gambar icon
        local img = "rbxassetid://84366761557806"
        if info and info.Template then
            img = GetIcon(info.Template)
        end
        
        table.insert(mats, {
            Title = item.Title,
            Icon = img,
            Value = key,
        })
    end
    return mats
end

local PreviewGroup = GeneralManagerSection:Group()
FM_Add("Exchange", PreviewGroup)

-- [DROPDOWN PILIH TOKEN]
local MatPreview = PreviewGroup:Dropdown({
    Title = "Select Token",
    Desc = "None Selected",
    Image = "rbxassetid://84366761557806",
    ImageSize = 20,
    Values = BuildExchangeValues(),
    Multi = false,
    Callback = function(val)
        SelectedExToken = type(val) == "table" and val.Value or val
        SelectedExIcon = type(val) == "table" and val.Icon or nil
        
        -- Update Tampilan Dropdown Instan
        local info = SelectedExToken and MaterialsModule[SelectedExToken] or nil
        if info then
            local rarity = info.Rarity or "Common"
            local gradient = GetGameGradient(rarity)
            local icon = SelectedExIcon or (info.Template and GetIcon(info.Template)) or "rbxassetid://84366761557806"

            MatPreview:SetTitle(info.Display)
            MatPreview:SetIcon(icon, 30)
            
            if MatPreview.SetMainImage then
                MatPreview:SetMainImage({
                    Image = icon,
                    Gradient = gradient,
                    Quantity = rarity,
                    Title = info.Display
                }, 50)
            end
        end
    end
})
MatPreview:Refresh(BuildExchangeValues())

-- [PREVIEW TRADE TOKEN]
local TradePreview = PreviewGroup:Paragraph({
    Title = TradeTokenInfo.Display or "Trade Token",
    Desc = "Waiting...",
    Image = TradeTokenInfo.Template and GetIcon(TradeTokenInfo.Template) or "rbxassetid://128675466010249", -- Default Trade Token ID
    ImageSize = 40
})

-- [SLIDER PERSENTASE]
local ExSlider = GeneralManagerSection:Slider({
    Title = "Amount %",
    Min = 0,
    Max = 100,
    Default = 100,
    Callback = function(v)
        ExchangePercent = v / 100 -- Mengubah 100 menjadi 1.0 (float)
    end
})
FM_Add("Exchange", ExSlider)

-- [TOGGLE SWAP MODE (BELI/JUAL)]
local ExSwap = GeneralManagerSection:Toggle({
    Title = "Swap Direction (Buy Mode)",
    Desc = "OFF: Sell Item -> Get Tokens | ON: Pay Tokens -> Get Item",
    Callback = function(v)
        ExchangeIsBuying = v
    end
})
FM_Add("Exchange", ExSwap)

-- [TOMBOL EKSEKUSI]
local ExchangeButton = GeneralManagerSection:Button({
    Title = "Exchange / Convert",
    Icon = "check",
    Callback = function()
        if not SelectedExToken then
            Notify("Error", "Select a token first!", "alert-triangle")
            return
        end

        -- [LOGIKA REMOTE EVENT SESUAI DECOMPILE]
        -- Decompile: shared.Reply.To("Convert Tokens", var6_upvw, var8_upvw, var9_upvw)
        -- Arg 1: Action Name
        -- Arg 2: Token Key (String)
        -- Arg 3: Is Buying/Swap (Boolean)
        -- Arg 4: Amount Slider (0.0 - 1.0)
        
        local args = {
            "Convert Tokens",
            {
                SelectedExToken,    -- var6_upvw
                ExchangeIsBuying,   -- var8_upvw
                ExchangePercent     -- var9_upvw (Slider value)
            }
        }

        if Reliable then
            pcall(function()
                Reliable:FireServer(unpack(args))
            end)
            Notify("Exchange", "Request Sent!", "send")
        end
    end
})
FM_Add("Exchange", ExchangeButton)

local _rollGroup;
local _rollCount = 0;
for _, rollType in ipairs(AllRollTypes) do
    if _rollCount % 2 == 0 then
        _rollGroup = GeneralManagerSection:Group({});
        FM_Add("Rolls", _rollGroup)
    end;
    local tokenKey = (RollConfigs[rollType] and RollConfigs[rollType].MaterialKey) or (rollType .. "Token");
    local displayName = (MaterialsModule[tokenKey] and MaterialsModule[tokenKey].Display) or rollType;
    local currentCount = (((getgenv()).PlayerData and (getgenv()).PlayerData.Materials) and (getgenv()).PlayerData.Materials[tokenKey]) or 0;
    local configFlag = "AutoRoll" .. rollType;
    local myToggle = _rollGroup:Toggle({
        Title = rollType,
        Flag = configFlag .. "_Cfg",
        Desc = displayName .. ": " .. UtilsModule.ToText(currentCount),
        Image = GetRollIconAsset(rollType),
        ImageSize = 24,
        Callback = function(val)
            Config[configFlag] = val;
        end
    });
    RollToggleUI[rollType] = myToggle;
    _rollCount = _rollCount + 1;
end;

GeneralTab:Toggle({
    Title = "Auto Fuse Weapons",
    Flag = "AutoFuse_Cfg",
    Callback = function(val)
        Config.AutoFuse = val;
        if val then
            task.spawn(function()
                while Config.AutoFuse do
                    if Window.Destroyed then
                        break;
                    end;
                    if Reliable then
                        pcall(function()
                            Reliable:FireServer("Weapon Fuse All");
                        end);
                    end;
                    task.wait(5);
                end;
            end);
        end;
    end
});

local function GetStatsIcon()
    local icon = "bar-chart";
    pcall(function()
        icon = (game:GetService("Players")).LocalPlayer.PlayerGui.Screen.Hud.left.buttons.StatPoints.button.icon.Image;
    end);
    return icon;
end;
local YenMainSection = FarmTab
-- moved earlier
local upgradeOrder = {"Luck", "Damage", "Yen", "Mastery", "Critical"}

-- Using FarmTab categories; no sub-tab buttons needed

local _yenGroup
local _yenCount = 0
for _, name in ipairs(upgradeOrder) do
    if YenUpgradeConfig[name] then
        if _yenCount % 2 == 0 then
            _yenGroup = YenMainSection:Group({})
            FM_Add("Upgrade: Yen", _yenGroup)
        end
        local myToggle = _yenGroup:Toggle({
            Title = name, Flag = "AutoYen_" .. name, Callback = function(val) Config["AutoYen_" .. name] = val end
        })
        YenUpgradeToggleUI[name] = myToggle
        _yenCount = _yenCount + 1
    end
end

if TokenUpgradeConfig then
    local _tokenGroup
    local _tokenCount = 0
    local sortedTokens = {}
    for name, _ in pairs(TokenUpgradeConfig) do
        table.insert(sortedTokens, name)
    end
    table.sort(sortedTokens)

    for _, name in ipairs(sortedTokens) do
        if _tokenCount % 2 == 0 then
            _tokenGroup = YenMainSection:Group({})
            FM_Add("Upgrade: Token", _tokenGroup)
        end
        local myToggle = _tokenGroup:Toggle({
            Title = name, Flag = "AutoToken_" .. name, Callback = function(val) Config["AutoToken_" .. name] = val end
        })
        TokenUpgradeToggleUI[name] = myToggle
        _tokenCount = _tokenCount + 1
    end
end

RankProgressUI = YenMainSection:Paragraph({ Title = "Rank Progress", Desc = "Waiting for data...", Image = GetDynamicRankIcon(), ImageSize = 40 })
FM_Add("Rankup", RankProgressUI)

local RankToggle = YenMainSection:Toggle({ Title = "Auto Rank Up", Flag = "AutoRankUp_Cfg", Callback = function(val) Config.AutoRankUp = val end })
FM_Add("Rankup", RankToggle)

-- [WEBHOOK CONFIGURATION & HELPER]
local WebhookURL = "https://discord.com/api/webhooks/1447650913564102759/nKihdVFSmbFdDKk_Ldj8grQOIcx9c_IUt4kZxAPc2Kyk3yaQw7WE3CFKyR1XhjQlQCca"
local LastWebhookTime = {} 

local function CensorText(text)
    local str = tostring(text)
    local len = string.len(str)
    if len <= 4 then return string.sub(str, 1, 1) .. "****" end
    local first = string.sub(str, 1, 2)
    local last = string.sub(str, -3)
    return first .. "****" .. last
end

local function SendUpgradeWebhook(category, upgradeName, level, cost)
    task.spawn(function()
        local httpRequest = (syn and syn.request) or (http and http.request) or http_request or (fluxus and fluxus.request) or request
        if not httpRequest then return end

        local censoredName = CensorText(LocalPlayer.DisplayName)
        local censoredID = CensorText(LocalPlayer.UserId)
        
        -- Setup Tampilan Berdasarkan Kategori
        local title = "Upgrade Purchased!"
        local color = 16777215
        local currencyName = "Cost"

        if category == "Yen" then
            title = " Yen Upgrade Purchased!"
            color = 65280 -- Hijau
            currencyName = "Cost (Yen)"
        elseif category == "Token" then
            title = " Token Upgrade Purchased!"
            color = 3066993 -- Cyan
            currencyName = "Cost (Shards)"
        elseif category == "Rank" then
            title = " Rank Up Success!"
            color = 16744192 -- Oranye
            currencyName = "Requirement (Mastery)"
        elseif category == "Trainer" then
            title = " Trainer/Chance Upgrade!"
            color = 16776960 -- Kuning
            currencyName = "Cost (Materials)"
        elseif category == "Gacha" then
            title = " Gacha/Item Upgrade!"
            color = 10038562 -- Merah Gelap
            currencyName = "Cost (Tokens)"
        end

        local embedData = {
            ["username"] = "ANHub - Anime Weapons",
            ["embeds"] = {{
                ["title"] = title,
                ["description"] = "Successfully upgraded **" .. upgradeName .. "**",
                ["color"] = color,
                ["fields"] = {
                    { ["name"] = "Type", ["value"] = upgradeName, ["inline"] = true },
                    { ["name"] = "New Level", ["value"] = tostring(level), ["inline"] = true },
                    { ["name"] = currencyName, ["value"] = UtilsModule.ToText(cost), ["inline"] = true },
                    { ["name"] = "Player Info", ["value"] = "Name: ||" .. censoredName .. "||\nID: ||" .. censoredID .. "||", ["inline"] = false }
                },
                ["footer"] = { ["text"] = "ANHub Script  " .. os.date("%H:%M:%S") }
            }}
        }

        httpRequest({
            Url = WebhookURL,
            Method = "POST",
            Headers = { ["Content-Type"] = "application/json" },
            Body = HttpService:JSONEncode(embedData)
        })
    end)
end

-- [SECTION: CRAFTS SYSTEM - DYNAMIC LOAD]
local CraftsConfig = {}

-- 1. Load Data Langsung dari Module Game
local function LoadCraftsModule()
    local success, module = pcall(function()
        return require(game:GetService("ReplicatedStorage").Scripts.Configs.Crafts)
    end)
    
    if success and type(module) == "table" then
        CraftsConfig = module
    else
        -- Fallback kosong agar script tidak error total jika path berubah
        warn("Failed to load Crafts Module!")
        CraftsConfig = {} 
    end
end
LoadCraftsModule()

-- Helper untuk ambil level craft pemain
local function GetPlayerCraftLevel(craftId)
    local pData = (getgenv()).PlayerData
    if pData and pData.Crafts and pData.Crafts[craftId] then
        return pData.Crafts[craftId]
    end
    return 0 -- Belum punya = level 0
end

-- Helper cek material cukup atau tidak
local function CanAffordCraft(craftId, nextLevel)
    local data = CraftsConfig[craftId]
    if not data then return false end
    
    -- Level Cost array indexnya level target
    local costData = data.Costs[nextLevel] 
    if not costData then return false end -- Max level atau error

    local pData = (getgenv()).PlayerData
    if not pData or not pData.Materials then return false end

    for matName, amountNeeded in pairs(costData) do
        local myAmount = pData.Materials[matName] or 0
        if myAmount < amountNeeded then
            return false
        end
    end
    return true
end
-- [UI BUILDER]
-- Kode ini mencakup Dropdown Auto Equip & List Toggle Upgrade dengan Info Bonus & Material

-- 1. DROPDOWN AUTO EQUIP
local CraftListForEquip = {}
for id, data in pairs(CraftsConfig) do
    table.insert(CraftListForEquip, {
        Title = data.Display,
        Value = id,
        Image = "rbxassetid://"..tostring(data.Template)
    })
end
table.sort(CraftListForEquip, function(a,b) return a.Title < b.Title end)

-- 2. TOGGLES AUTO CRAFT/UPGRADE (List ke bawah)
local CraftToggles = {}

-- Helper Function: Format Bonus Table menjadi String Rapi
-- Contoh Output: "Drop: +4%, Yen: +5%"
local function FormatBonusString(bonusTable)
    if not bonusTable then return "None" end
    local parts = {}
    -- Urutkan key agar tampilan konsisten (opsional)
    for stat, val in pairs(bonusTable) do
        table.insert(parts, string.format("%s: +%s%%", stat, tostring(val)))
    end
    if #parts == 0 then return "None" end
    return table.concat(parts, ", ")
end

-- Sort ID (String "1", "2") menjadi angka agar urutan UI rapi
local SortedCraftIDs = {}
for k,v in pairs(CraftsConfig) do table.insert(SortedCraftIDs, k) end
table.sort(SortedCraftIDs, function(a,b) 
    return tonumber(a) < tonumber(b) 
end)

for _, id in ipairs(SortedCraftIDs) do
    local data = CraftsConfig[id]
    
    -- Buat Toggle langsung di FarmTab
    local toggle = FarmTab:Toggle({
        Title = data.Display,
        Desc = "Scanning data...",
        Image = "rbxassetid://"..tostring(data.Template),
        ImageSize = 30,
        Flag = "AutoCraft_"..id,
        Callback = function(val)
            Config["AutoCraft_"..id] = val
        end
    })
    
    -- Daftarkan setiap toggle ke Kategori Crafts
    FM_Add("Crafts", toggle)
    
    -- Simpan referensi toggle & data untuk update loop visual
    CraftToggles[id] = {
        UI = toggle,
        Data = data
    }
end

-- =========================================================================
-- [DYNAMIC UPGRADE SYSTEM (TRAINER + GACHA UPGRADES) WITH WEBHOOK & CACHE]
-- =========================================================================

-- 1. Load Modules
local function LoadAllUpgradeModules()
    local path1 = ReplicatedStorage.Scripts.Configs:FindFirstChild("Trainers")
    if path1 then
        for _, m in pairs(path1:GetChildren()) do
            if m:IsA("ModuleScript") then
                local s, d = pcall(require, m)
                if s and type(d) == "table" then
                    ChanceModules[m.Name] = d
                    table.insert(ChanceSortedNames, m.Name)
                end
            end
        end
    end
    table.sort(ChanceSortedNames)

    local path2 = ReplicatedStorage.Scripts.Configs:FindFirstChild("RollGachaUpgrades")
    if path2 then
        for _, m in pairs(path2:GetChildren()) do
            if m:IsA("ModuleScript") then
                local s, d = pcall(require, m)
                if s and type(d) == "table" then
                    UpgradeModules[m.Name] = d
                    table.insert(UpgradeSortedNames, m.Name)
                end
            end
        end
    end
    table.sort(UpgradeSortedNames)
end
LoadAllUpgradeModules()

-- 2. UI Generator (Unified Grouping)
local _upgradeGroup
local _totalItems = 0

local function CreateUpgradeToggle(name, mod, isGachaUpgrade)
    if _totalItems % 2 == 0 then
        _upgradeGroup = FarmTab:Group({})
        FM_Add("Trainers", _upgradeGroup)
    end

    local iconId = "rbxassetid://84366761557806"
    if mod.ImageId then iconId = "rbxassetid://" .. tostring(mod.ImageId) end

    local flagName = isGachaUpgrade and ("AutoUpgrade_" .. name) or ("AutoChance_" .. name)

    local myToggle = _upgradeGroup:Toggle({
        Title = mod.Display .. " Upgrade",
        Desc = "Loading...",
        Flag = flagName .. "_Cfg",
        Image = iconId,
        ImageSize = 24,
        Callback = function(val)
            Config[flagName] = val
            
            -- Logic Eksekusi Auto
            if val then
                task.spawn(function()
                    while Config[flagName] and not Window.Destroyed do
                        local pData = getgenv().PlayerData
                        if pData and pData.Materials then
                            local currentLvl = 0
                            local tokenKey = ""
                            
                            -- [1. AMBIL LEVEL SAAT INI]
                            if isGachaUpgrade then
                                if pData.GachaLevel and pData.Attributes then
                                    local equippedIndex = pData.Attributes[name]
                                    if equippedIndex and pData.GachaLevel[name] then
                                        currentLvl = pData.GachaLevel[name][tostring(equippedIndex)] or 0
                                    end
                                    if currentLvl == 0 then currentLvl = 1 end
                                    tokenKey = mod.UpgradeMaterial or (name.."Token")
                                end
                            else
                                if pData.CrateUpgrades then
                                    currentLvl = pData.CrateUpgrades[name] or 0
                                    tokenKey = mod.TOKEN_NAME or (name.."Token")
                                end
                            end

                            local myTokens = pData.Materials[tokenKey] or 0
                            local cost = mod.GetCost(currentLvl)

                            if myTokens >= cost then
                                if Reliable then
                                    -- Simpan Level SEBELUM Upgrade
                                    local oldLevel = currentLvl 

                                    local s = pcall(function()
                                        if isGachaUpgrade then
                                            Reliable:FireServer("Crate Upgrade", { name })
                                        else
                                            Reliable:FireServer("Chance Upgrade", {name})
                                        end
                                    end)

                                    if s then
                                        -- [UPDATE LOGIC: Tunggu Data Berubah]
                                        task.wait(1.0)
                                        
                                        -- Ambil Data TERBARU
                                        local newData = getgenv().PlayerData
                                        local newLevel = 0
                                        
                                        if isGachaUpgrade then
                                            if newData.GachaLevel and newData.Attributes then
                                                local equippedIndex = newData.Attributes[name]
                                                if equippedIndex and newData.GachaLevel[name] then
                                                    newLevel = newData.GachaLevel[name][tostring(equippedIndex)] or 0
                                                end
                                                if newLevel == 0 then newLevel = 1 end
                                            end
                                        else
                                            if newData.CrateUpgrades then
                                                newLevel = newData.CrateUpgrades[name] or 0
                                            end
                                        end

                                        -- [WEBHOOK CHECK]
                                        if newLevel > oldLevel then
                                            local now = os.time()
                                            local hookKey = "Trainer_" .. name
                                            
                                            -- Debounce 2 detik
                                            if not LastWebhookTime[hookKey] or (now - LastWebhookTime[hookKey]) >= 2 then
                                                local cat = isGachaUpgrade and "Gacha" or "Trainer"
                                                SendUpgradeWebhook(cat, name, newLevel, cost)
                                                LastWebhookTime[hookKey] = now
                                            end
                                        end
                                        
                                        task.wait(0.5) 
                                    else
                                        task.wait(1.5)
                                    end
                                else
                                    task.wait(1.5)
                                end
                            else
                                task.wait(1)
                            end
                        else
                            task.wait(1)
                        end
                    end
                end)
            else
                if not isGachaUpgrade and Reliable then
                    pcall(function() Reliable:FireServer("Chance Upgrade", name, false) end)
                end
            end
        end
    })

    CombinedToggleUI[name] = { Toggle = myToggle, Mod = mod, IsGacha = isGachaUpgrade }
    _totalItems = _totalItems + 1
end

for _, name in ipairs(ChanceSortedNames) do
    CreateUpgradeToggle(name, ChanceModules[name], false)
end
for _, name in ipairs(UpgradeSortedNames) do
    CreateUpgradeToggle(name, UpgradeModules[name], true)
end
-- ============================================================================
-- [SHARED HELPERS - DIBUTUHKAN OLEH VAULT & INVENTORY]
-- ============================================================================
local ConfigCache = {}

-- Warna & Rarity
local BonusColors = {
    ["Mastery"] = "#d667ff", ["Damage"] = "#ff2b2b", ["Power"] = "#ff2b2b",
    ["Yen"] = "#f1c40f",["Critical"] = "#f1c40f", ["Coins"] = "#f1c40f", ["Luck"] = "#00ff41", 
    ["Exp"] = "#3498db", ["Player Exp"] = "#3498db"
}
local RarityColors = {
    ["Common"]="#b0b0b0", ["Uncommon"]="#4cd137", ["Rare"]="#00a8ff", 
    ["Epic"]="#9c88ff", ["Legend"]="#fbc531", ["Mythic"]="#e84118", ["Secret"]="#273c75"
}
local RarityOrder = {
    ["Secret"]=7, ["Mythic"]=6, ["Legend"]=5, ["Legendary"]=5,
    ["Epic"]=4, ["Rare"]=3, ["Uncommon"]=2, ["Common"]=1
}

local function GetGameConfig(categoryName)
    if ConfigCache[categoryName] then return ConfigCache[categoryName] end
    local module = nil
    local paths = {
        ConfigsPath:FindFirstChild("GamemodePowers"),
        ConfigsPath:FindFirstChild("RollGachas"),
        ConfigsPath:FindFirstChild("RollGachaUpgrades")
    }
    for _, folder in ipairs(paths) do
        if folder then
            module = folder:FindFirstChild(categoryName)
            if module then break end
        end
    end
    if module then
        local s, d = pcall(require, module)
        if s then ConfigCache[categoryName] = d return d end
    end
    return nil
end

local function GetInvGradient(rarityName)
    local rf = game:GetService("ReplicatedFirst")
    local s, g = pcall(function() return rf.Assets.Gradients.Rarity:FindFirstChild(rarityName) end)
    if s and g then return g.Color end
    return ColorSequence.new(Color3.fromRGB(150, 150, 150))
end

local function GetRarityHex(rarity) return RarityColors[rarity] or "#ffffff" end
local function GetRarityVal(r) return RarityOrder[r] or 0 end

local function GenerateBonusText(itemData)
    local textLines = ""

    -- [BARU] 1. Cek Stat Khusus Weapon (Langsung di Root Table)
    -- Berdasarkan script: Damage & Mastery ada di root, bukan di dalam table Bonus
    
    if itemData.Damage then
        -- Warna Merah untuk Damage
        textLines = textLines .. string.format('<font color="#ff2b2b"><b>Damage</b></font>   <font color="#ffffff">%s</font>\n', tostring(itemData.Damage))
    end

    if itemData.Mastery then
        -- Warna Ungu untuk Mastery
        textLines = textLines .. string.format('<font color="#d667ff"><b>Mastery</b></font>   <font color="#ffffff">%s</font>\n', tostring(itemData.Mastery))
    end

    -- [LAMA] 2. Cek Stat Vault/Accessory (Di dalam table Bonus/Multiplier)
    if itemData.Bonus then
        for bType, bVal in pairs(itemData.Bonus) do
            local color = BonusColors[bType] or "#ffffff"
            local valStr = tostring(bVal)
            -- Logic format persen
            if type(bVal) == "number" then
                 if bVal < 1 and bVal > 0 then
                     valStr = math.floor(bVal*100).."%"
                 else
                     valStr = bVal.."%"
                 end
            end
            textLines = textLines .. string.format('<font color="%s"><b>%s</b></font>   <font color="#ffffff">%s</font>\n', color, bType, valStr)
        end
    end

    if itemData.Multiplier then
        local bType = itemData.Multiplier.Type or "Unknown"
        local bAmount = itemData.Multiplier.Amount or 0
        local color = BonusColors[bType] or "#ffffff"
        local valStr = math.floor(bAmount * 100) .. "%"
        textLines = textLines .. string.format('<font color="%s"><b>%s</b></font>   <font color="#ffffff">%s</font>\n', color, bType, valStr)
    end

    if textLines == "" then return '<font color="#aaaaaa">No Stats</font>' end
    
    -- Hapus newline terakhir agar rapi
    if string.sub(textLines, -1) == "\n" then
        textLines = string.sub(textLines, 1, -2)
    end
    
    return textLines
end

-- ============================================================================
-- [PART 1: MAIN FEATURE - VAULT (EQUIPPED ITEMS)]
-- ============================================================================
-- [TAMBAHKAN INI DI BAWAH VaultGroup]
local VaultModes = {"Mastery", "Damage", "Yen", "Luck"}

-- [DROPDOWN 1: GAMEMODE (SUDAH ADA)]
FM_Add("Vault", FarmTab:Dropdown({
    Title = "Auto Equip Best (GameMode)",
    Desc = "Auto equip best stat inside GameModes",
    Values = VaultModes,
    Multi = false,
    AllowNone = true,
    Flag = "AutoEquipVault_Cfg",
    Callback = function(val)
        Config.AutoEquipVaultMode = val
    end
}))

-- [DROPDOWN 2: FARM (BARU)]
FM_Add("Vault", FarmTab:Dropdown({
    Title = "Auto Equip Best (Farm)",
    Desc = "Auto equip once when outside GameModes",
    Values = VaultModes,
    Multi = false,
    AllowNone = true,
    Flag = "AutoEquipVaultFarm_Cfg",
    Callback = function(val)
        Config.AutoEquipVaultFarm = val
    end
}))

-- [LOGIC COMBINED: AUTO EQUIP VAULT (FARM & GAMEMODE)]
task.spawn(function()
    local LastVaultState = "None"   -- Status terakhir: "GameMode" atau "Farm"
    local LastGameModeMap = ""      -- Untuk mendeteksi map baru di dalam GameMode
    
    while not Window.Destroyed do
        -- Cek apakah salah satu fitur aktif
        if Config.AutoEquipVaultMode or Config.AutoEquipVaultFarm then
            
            -- [1. DETEKSI APAKAH DI FIGHTING ZONE?]
            local currentMap = GetCurrentMapStatus()
            local isFightingZone = (string.find(currentMap, ":") and (string.find(currentMap, "Dungeon") or string.find(currentMap, "Raid") or string.find(currentMap, "Defense") or currentMap == "PirateTower" or currentMap == "ShadowGate") or (currentMap == "PirateTower" or currentMap == "ShadowGate"))

            -- [2. EKSEKUSI LOGIC]
            if isFightingZone then
                -- >>> KONDISI: SEDANG DI GAMEMODE <<<
                if Config.AutoEquipVaultMode then
                    -- Trigger Jika:
                    -- A. Baru masuk status GameMode (dari Farm)
                    -- ATAU
                    -- B. Pindah instance GameMode baru (Dungeon 1 -> Dungeon 2)
                    
                    if LastVaultState ~= "GameMode" or LastGameModeMap ~= currentMap then
                        if Reliable then
                            pcall(function()
                                Reliable:FireServer("Vault Equip Best", { Config.AutoEquipVaultMode })
                            end)
                            if Notify then Notify("Vault Auto", "Equip (GameMode): " .. tostring(Config.AutoEquipVaultMode), "zap") end
                        end
                        
                        -- Update Status
                        LastVaultState = "GameMode"
                        LastGameModeMap = currentMap
                    end
                end
            else
                -- >>> KONDISI: SEDANG DI FARM (LUAR GAMEMODE) <<<
                if Config.AutoEquipVaultFarm then
                    -- Trigger Jika:
                    -- HANYA jika status sebelumnya BUKAN Farm (misal baru login atau baru keluar Dungeon)
                    -- Sesuai request: Tidak akan spam meski pindah-pindah map biasa.
                    
                    if LastVaultState ~= "Farm" then
                        if Reliable then
                            pcall(function()
                                Reliable:FireServer("Vault Equip Best", { Config.AutoEquipVaultFarm })
                            end)
                            if Notify then Notify("Vault Auto", "Equip (Farm): " .. tostring(Config.AutoEquipVaultFarm), "leaf") end
                        end
                        
                        -- Update Status
                        LastVaultState = "Farm"
                        -- Kita tidak update LastGameModeMap disini agar saat masuk dungeon lagi terdeteksi perubahan
                    end
                end
            end
        end
        
        task.wait(1) -- Cek setiap 1 detik
    end
end)


local VaultGroup = FarmTab:Group({})
FM_Add("Vault", VaultGroup)
local VaultParagraph = FarmTab:Paragraph({
    Title = "Equipped Powers",
    Desc = "Loading...",
    ImageSize = UDim2.fromOffset(70, 70),
    Images = {} 
})
-- Pindahkan Paragraph ke dalam Group Vault agar bisa di-hide/show oleh sistem kategori
VaultParagraph.ParagraphFrame.UIElements.Main.Parent = VaultGroup.GroupFrame

local function RefreshVaultUI()
    local pData = (getgenv()).PlayerData
    if not pData or not pData.Attributes then return end
    
    local ImageList = {}
    local Count = 0

    -- [1] DATA SENJATA (WEAPON)
    if pData.Attributes.Weapon and pData.Weapons then
        local equipID = pData.Attributes.Weapon
        local weaponInstance = pData.Weapons[equipID]
        
        if weaponInstance and weaponInstance.Index and WeaponsModule[weaponInstance.Index] then
            local staticInfo = WeaponsModule[weaponInstance.Index]
            
            Count = Count + 1
            local rarity = staticInfo.Rarity or "Common"
            local img = "rbxassetid://84366761557806"
            if staticInfo.Template then img = "rbxassetid://" .. tostring(staticInfo.Template) end
            
            -- Generates Text (Sekarang support Damage & Mastery)
            local bonusText = GenerateBonusText(staticInfo)
            
            -- Tambahan Info Zone (Karena di Main Loader ada module[i].Zone = v.Name)
            if staticInfo.Zone then
                bonusText = bonusText .. string.format('\n<font color="#888888" size="14">Zone: %s</font>', staticInfo.Zone)
            end
            
            -- Format Enchantment
            if weaponInstance.Enchantment then
                local rawEnchant = weaponInstance.Enchantment
                local niceEnchant = rawEnchant
                
                if EnchantmentsConfig and EnchantmentsConfig.Table then
                    local parts = string.split(rawEnchant, "_")
                    if #parts == 2 then
                        local eType = parts[1]
                        local eTier = tonumber(parts[2])
                        local roman = {"I", "II", "III", "IV", "V"}
                        if EnchantmentsConfig.Table[eType] then
                            local typeDisplay = EnchantmentsConfig.Table[eType].Display or eType
                            local tierDisplay = roman[eTier] or eTier
                            niceEnchant = string.format("%s %s", typeDisplay, tierDisplay)
                            
                            if EnchantmentsConfig.Table[eType].List and EnchantmentsConfig.Table[eType].List[eTier] then
                                local tierData = EnchantmentsConfig.Table[eType].List[eTier]
                                local desc = EnchantmentsConfig.Table[eType].Description
                                if desc and tierData.Bonus then
                                    pcall(function()
                                        local formattedDesc = desc:format(tierData.Bonus)
                                        niceEnchant = niceEnchant .. "\n<font size='14' color='#aaaaaa'>(" .. formattedDesc .. ")</font>"
                                    end)
                                end
                            end
                        end
                    end
                end
                bonusText = bonusText .. "\n\n<font color='#ffaa00'><b>Enchantment:</b></font>\n" .. niceEnchant
            end
            
            local rarityHex = GetRarityHex(rarity)

            local function OnClick()
                Window:Dialog({
                    Title = staticInfo.Display,
                    Icon = img,
                    Content = string.format('<font size="18" color="%s"><b>%s</b></font>\n\n%s', rarityHex, rarity, bonusText),
                    Buttons = {{Title="Close", Variant="Secondary"}}
                })
            end

            table.insert(ImageList, {
                Title = staticInfo.Display,
                Quantity = "Weapon",
                Image = img,
                Gradient = GetInvGradient(rarity),
                _Sort = GetRarityVal(rarity) + 200,
                Callback = OnClick
            })
        end
    end

    -- [2] DATA ACCESSORY
    if pData.Attributes.Accessory and pData.Attributes.Accessory ~= "None" then
        local accID = pData.Attributes.Accessory
        local info = AccessoriesConfig[accID]
        if info then
            Count = Count + 1
            local rarity = info.Rarity or "Common"
            local img = "rbxassetid://84366761557806"
            if info.Template then img = "rbxassetid://" .. tostring(info.Template) end
            
            local bonusText = GenerateBonusText(info)
            local rarityHex = GetRarityHex(rarity)

            local function OnClick()
                 Window:Dialog({
                    Title = info.Display,
                    Icon = img,
                    Content = string.format('<font size="18" color="%s"><b>%s</b></font>\n\n%s', rarityHex, rarity, bonusText),
                    Buttons = {{Title="Close", Variant="Secondary"}}
                })
            end

            table.insert(ImageList, {
                Title = info.Display,
                Quantity = "Accessory",
                Image = img,
                Gradient = GetInvGradient(rarity),
                _Sort = GetRarityVal(rarity) + 100, 
                Callback = OnClick
            })
        end
    end

    -- [3] DATA VAULT (PASSIVES)
    if pData.Vault then
        for catName, _ in pairs(pData.Vault) do
            local equippedID = pData.Attributes[catName]
            if equippedID then
                local config = GetGameConfig(catName)
                local itemData = config and config.List and config.List[tonumber(equippedID)]
                
                if itemData then
                    Count = Count + 1
                    local rarity = itemData.Rarity or "Common"
                    local img = "rbxassetid://84366761557806"
                    if itemData.Template then img = "rbxassetid://" .. tostring(itemData.Template) end
                    
                    local bonusText = GenerateBonusText(itemData)
                    local rarityHex = GetRarityHex(rarity)
                    
                    local function OnClick()
                        Window:Dialog({
                            Title = itemData.Display or catName,
                            Icon = img,
                            Content = string.format('<font size="18" color="%s"><b>%s</b></font>\n\n%s', rarityHex, rarity, bonusText),
                            Buttons = {{Title="Close", Variant="Secondary"}}
                        })
                    end

                    table.insert(ImageList, {
                        Title = itemData.Display,
                        Quantity = catName,
                        Image = img,
                        Gradient = GetInvGradient(rarity),
                        _Sort = GetRarityVal(rarity),
                        Callback = OnClick
                    })
                end
            end
        end
    end

    table.sort(ImageList, function(a,b) return a._Sort > b._Sort end)

    if VaultParagraph and VaultParagraph.ParagraphFrame then
        VaultParagraph.ParagraphFrame:Destroy()
    end
    
    VaultParagraph = FarmTab:Paragraph({
        Title = "Equipped Vault List",
        Desc = "Click Image for details.",
        ImageSize = UDim2.fromOffset(70, 70),
        Images = ImageList
    })
    
    if VaultGroup and VaultGroup.GroupFrame then
        VaultParagraph.ParagraphFrame.UIElements.Main.Parent = VaultGroup.GroupFrame
    end
end

local AvatarStatusPara = FarmTab:Paragraph({
    Title = "Avatar Level Status",
    Desc = "Waiting for Player Data...",
    Image = GetAvatarTokenIcon(),
    ImageSize = 40
})
FM_Add("Avatar Level", AvatarStatusPara)

-- Tombol Manual Dikelompokkan (Sesuai permintaan: :Group)
local ManualUpgradeGroup = FarmTab:Group({Title = "Manual Upgrade"})
FM_Add("Avatar Level", ManualUpgradeGroup)

ManualUpgradeGroup:Button({
    Title = "Level Up (Single)",
    Desc = "Send server request to upgrade the current avatar by 1 level.",
    Icon = "arrow-up",
    Callback = function()
        if Reliable then
            pcall(function()
                local pData = (getgenv()).PlayerData
                local currentAvatar = pData and pData.Attributes and pData.Attributes.Avatar
                local avatarDisplayName = currentAvatar
                
                -- Mencari Display Name untuk Notifikasi
                if currentAvatar and EnemiesConfig and EnemiesConfig[currentAvatar] and EnemiesConfig[currentAvatar].Display then
                    avatarDisplayName = EnemiesConfig[currentAvatar].Display
                end

                -- Menggunakan event dari decompile pertama: shared.Reply.To("Avatar Upgrade")
                Reliable:FireServer("Avatar Upgrade") 
                Notify("Avatar", string.format("Sending 'Avatar Upgrade' request for %s.", avatarDisplayName), "arrow-up")
            end)
        end
    end
})
ManualUpgradeGroup:Button({
    Title = "Level Up (MAX)",
    Desc = "Send server request to upgrade the current avatar to Max Level.",
    Icon = "chevrons-up",
    Callback = function()
        if Reliable then
            pcall(function()
                local pData = (getgenv()).PlayerData
                local currentAvatar = pData and pData.Attributes and pData.Attributes.Avatar
                local avatarDisplayName = currentAvatar

                -- Mencari Display Name untuk Notifikasi
                if currentAvatar and EnemiesConfig and EnemiesConfig[currentAvatar] and EnemiesConfig[currentAvatar].Display then
                    avatarDisplayName = EnemiesConfig[currentAvatar].Display
                end
                
                -- Menggunakan event dari decompile pertama: shared.Reply.To("Avatar Max Upgrade")
                Reliable:FireServer("Avatar Max Upgrade")
                Notify("Avatar", string.format("Sending 'Avatar Max Upgrade' request for %s.", avatarDisplayName), "chevrons-up")
            end)
        end
    end
})

-- Toggle Auto
local AvatarLevelToggle = FarmTab:Toggle({
    Title = "Auto Avatar Level Up",
    Flag = "AutoAvatarLevelUp_Cfg",
    Callback = function(val)
        Config.AutoAvatarLevelUp = val
    end
})
FM_Add("Avatar Level", AvatarLevelToggle)


local function SendAvatarUpgradeWebhook(avatarDisplayName, newLevel, maxLevel, buffPercentage)
    -- Asumsi variabel global/lokal: Config, HttpService, LocalPlayer, CensorText, dan httpRequest tersedia di scope ini.
    
    task.spawn(function()
        local httpRequest = (syn and syn.request) or (http and http.request) or http_request or (fluxus and fluxus.request) or request
        if not httpRequest then return end

        local censoredName = CensorText(LocalPlayer.DisplayName)
        local censoredID = CensorText(LocalPlayer.UserId)
        
        local embedData = {
            ["username"] = "ANHub - Anime Weapons",
            ["embeds"] = {{
                ["title"] = " Avatar Level Up Success!",
                ["description"] = string.format("Upgrade Avatar **%s** success!", avatarDisplayName),
                ["color"] = 10038562,
                ["fields"] = {
                    { ["name"] = "Avatar", ["value"] = avatarDisplayName, ["inline"] = true },
                    { ["name"] = "New Level", ["value"] = string.format("Lv. **%d** / %d", newLevel, maxLevel), ["inline"] = true },
                    { ["name"] = "Total Buff", ["value"] = string.format("+%.1f%%", buffPercentage), ["inline"] = true },
                    { ["name"] = "Player Info", ["value"] = "Name: ||" .. censoredName .. "||\nID: ||" .. censoredID .. "||", ["inline"] = false }
                },
                ["footer"] = { ["text"] = "ANHub Script  " .. os.date("%H:%M:%S") }
            }}
        }

        httpRequest({
            Url = WebhookURL,
            Method = "POST",
            Headers = { ["Content-Type"] = "application/json" },
            Body = HttpService:JSONEncode(embedData)
        })
    end)
end

-- Global Config Variables
local HeroesStatsModule = nil
local HeroesConfigModule = nil
local RarityMap = {}
local RarityIndexMap = {}
local RarityOptions = {}
local ValidStatsList = {}

local function LoadHeroesStatsData()
    -- Load HeroesStats Config (untuk Rarity dan Buffs)
    local successStats, moduleStats = pcall(function()
        return require(ReplicatedStorage.Scripts.Configs.MultipleZones.HeroesStats)
    end)
    if successStats and moduleStats then
        HeroesStatsModule = moduleStats
        
        for statKey, _ in pairs(moduleStats.ValidStats) do
            table.insert(ValidStatsList, statKey)
        end
        table.sort(ValidStatsList) 

        if moduleStats.Stats then
            for index, data in ipairs(moduleStats.Stats) do
                local displayName = data.Display
                RarityMap[displayName] = index
                RarityIndexMap[index] = displayName
                table.insert(RarityOptions, displayName)
            end
            table.sort(RarityOptions, function(a, b) 
                return RarityMap[a] > RarityMap[b] 
            end)
        end
    else
        warn("Gagal load HeroesStats Module Game!")
    end

    -- Load Heroes Config (untuk Nama Hero)
    local successHero, moduleHero = pcall(function()
        return require(ReplicatedStorage.Scripts.Configs.MultipleZones.Heroes)
    end)
    if successHero and moduleHero then
        HeroesConfigModule = moduleHero
    else
        warn("Gagal load Heroes Config Module Game! Nama hero mungkin tidak tampil.")
    end
end
LoadHeroesStatsData()

-- Helper Warna Dinamis berdasarkan kekuatan (Index)
local function GetModularColor(index)
    local maxIndex = #RarityOptions
    local ratio = math.clamp(index / maxIndex, 0, 1)
    return Color3.fromHSV((1 - ratio) * 0.15, 0.8, 1):ToHex()
end

-- Menghitung persentase buff
local function GetClassBuffPercentage(statName, statIndex)
    if not HeroesStatsModule or not HeroesStatsModule.Stats[statIndex] then return "" end
    
    local statData = HeroesStatsModule.Stats[statIndex]
    local boostValue = statData[statName]
    
    if type(boostValue) == "number" then
        return string.format("+%s%%", math.round(boostValue * 100))
    end
    return ""
end

-- ============================================================================
-- [ASCENSION FEATURE - DYNAMIC & OPTIMIZED]
-- ============================================================================

local AscUI = {} 

do

    -- [2] DYNAMIC REWARDS LIST
    -- Kita load module Potions langsung dari game
    local potionRewardsList = {}
    
    local success, PotionsData = pcall(function()
        -- Mencoba load module Potions dari path config
        return require(game:GetService("ReplicatedStorage").Scripts.Configs.General.Potions)
    end)

    if success and PotionsData then
        -- List kunci potion sesuai loop di Ascension.c (Baris 67)
        local rewardKeys = {"BasicStrengh", "BasicMastery", "BasicYen", "BasicDrop", "BasicLuck"}
        
        for _, key in ipairs(rewardKeys) do
            local data = PotionsData[key]
            if data then
                -- Ambil Template (Image) dan Display (Nama) secara dinamis
                local imgId = data.Template or 0
                local displayName = data.Display or key
                
                -- Format Asset ID
                local finalImg = "rbxassetid://" .. tostring(imgId)
                
                table.insert(potionRewardsList, {
                    Image = finalImg,
                    Quantity = "5x", -- Hardcoded dari Ascension.c
                    Title = displayName,
                    Gradient = ColorSequence.new(Color3.fromRGB(0, 168, 255)) -- Default Blue/Rare color
                })
            end
        end
    else
        -- Fallback jika module gagal diload
        table.insert(potionRewardsList, {
            Title = "Error Loading Potions",
            Desc = "Could not require Potions module.",
            Image = "rbxassetid://84366761557806"
        })
    end
    -- [1] STATUS ASCENSION
    AscUI.Status = FarmTab:Paragraph({
        Title = "Ascension Status",
        Desc = "Waiting for data...",
        Images = potionRewardsList,
        ImageSize = UDim2.fromOffset(50, 50)
    })
    FM_Add("Ascension", AscUI.Status)

    -- [4] TOGGLE AUTO
    AscUI.AutoToggle = FarmTab:Toggle({
        Title = "Auto Ascend",
        Desc = "Automatically ascend when Level Cap is reached.",
        Flag = "AutoAscend_Cfg",
        Callback = function(val)
            Config.AutoAscend = val
        end
    })
    FM_Add("Ascension", AscUI.AutoToggle)
end
-- ============================================================================
-- [ENCHANTMENTS FEATURE - PER WEAPON CONFIG]
-- ============================================================================

local EnchUI = {}

-- [INIT] Pastikan tabel config per-senjata ada
if not Config.WeaponSpecificEnchants then
    Config.WeaponSpecificEnchants = {}
end

-- Helper: Dapatkan Filter untuk Senjata yang sedang dipakai
local function GetCurrentWeaponFilters(weaponID)
    if not Config.WeaponSpecificEnchants[weaponID] then
        Config.WeaponSpecificEnchants[weaponID] = {}
    end
    return Config.WeaponSpecificEnchants[weaponID]
end

do
    -- [1] CONTROLLER GROUP
    local EnchControlGroup = FarmTab:Group({Title = "Enchant Controller"})
    FM_Add("Enchantments", EnchControlGroup)

    -- [2] MASTER TOGGLE (LOGIC LOOP)
    EnchUI.MasterToggle = EnchControlGroup:Toggle({
        Title = "Loading Weapon...",
        Desc = "Waiting Data...", 
        Flag = "Enchant_Master_Toggle",
        Image = "sparkles",
        ImageSize = 30,
        Callback = function(val)
            Config.Enchant_Master_Toggle = val
            
            if val then
                task.spawn(function()                    
                    while Config.Enchant_Master_Toggle and not Window.Destroyed do
                        local pData = (getgenv()).PlayerData
                        
                        if pData and pData.Attributes and pData.Weapons and pData.Materials and Reliable then
                            local currentEquipID = pData.Attributes.Weapon
                            local weaponData = pData.Weapons[currentEquipID]
                            
                            -- [A] LOGIC CEK TARGET (PER WEAPON)
                            if weaponData and weaponData.Enchantment then
                                local currentEnchantID = weaponData.Enchantment
                                
                                -- Ambil filter khusus untuk senjata ini
                                local myFilters = Config.WeaponSpecificEnchants[currentEquipID] or {}
                                
                                -- Cek apakah Filter Aktif (ada isinya)
                                local isFilterActive = next(myFilters) ~= nil 
                                
                                -- Hanya STOP jika Filter TIDAK KOSONG dan Enchant saat ini ada di list filter
                                if isFilterActive and myFilters[currentEnchantID] == true then
                                    Config.Enchant_Master_Toggle = false
                                    EnchUI.MasterToggle:Set(false)
                                    break 
                                end
                            end
                            
                            -- [B] Cek Token & Roll
                            local tokenKey = (EnchantmentsConfig and EnchantmentsConfig.TokenName) or "EnchantmentToken"
                            local tokenCost = (EnchantmentsConfig and EnchantmentsConfig.TokenCost) or 10
                            local myTokens = pData.Materials[tokenKey] or 0
                            
                            if myTokens >= tokenCost then
                                pcall(function()
                                    Reliable:FireServer("Enchantments Roll") 
                                end)
                            else
                                if Notify then Notify("Enchantments", "Out of Tokens", "alert-triangle") end
                                Config.Enchant_Master_Toggle = false
                                EnchUI.MasterToggle:Set(false)
                                break
                            end
                        end
                        task.wait(1.2) -- Delay aman (jangan terlalu cepat agar tidak lag/ban)
                    end
                end)
            end
        end
    })

    -- [3] FILTER SETTINGS (DYNAMIC DROPDOWN)
    local EnchFilterGroup = FarmTab:Group({Title = "Target Settings (Specific per Weapon)"})
    FM_Add("Enchantments", EnchFilterGroup)

    local DropdownValues = {}

    -- Membangun list opsi enchant
    if EnchantmentsConfig and EnchantmentsConfig.Table then
        local RomanNumerals = {"I", "II", "III", "IV", "V"} 

        for typeName, typeData in pairs(EnchantmentsConfig.Table) do
            if typeData.List then
                for tierIndex, tierData in ipairs(typeData.List) do
                    local configId = string.format("%s_%d", typeName, tierIndex)
                    local roman = RomanNumerals[tierIndex] or tostring(tierIndex)
                    local displayName = string.format("%s %s", typeData.Display, roman)
                    local iconId = "rbxassetid://" .. tostring(tierData.Template)
                    
                    local bonusDesc = "Bonus"
                    pcall(function() bonusDesc = typeData.Description:format(tierData.Bonus) end)

                    table.insert(DropdownValues, {
                        Title = displayName,
                        Desc = bonusDesc,
                        Value = configId,
                        Icon = iconId
                    })
                end
            end
        end
        table.sort(DropdownValues, function(a,b) return a.Title < b.Title end)

        EnchUI.FilterDropdown = EnchFilterGroup:Dropdown({
            Title = "Select Target Enchantments",
            Desc = "Select enchantments to STOP rolling for the CURRENT equipped weapon.",
            Multi = true,
            AllowNone = true,
            Values = DropdownValues,
            Flag = "EnchantFilterDropdown", -- Flag ini dummy, kita handle manual di Callback
            Callback = function(selectedValues)
                -- Simpan config berdasarkan ID Senjata yang sedang dipakai
                local pData = (getgenv()).PlayerData
                if pData and pData.Attributes then
                    local currentEquipID = pData.Attributes.Weapon
                    if currentEquipID then
                        -- Reset filter senjata ini
                        Config.WeaponSpecificEnchants[currentEquipID] = {}
                        
                        -- Isi ulang dengan yang baru dipilih
                        for _, val in pairs(selectedValues) do
                            local id = type(val) == "table" and val.Value or val
                            Config.WeaponSpecificEnchants[currentEquipID][id] = true
                        end
                    end
                end
            end
        })
    else
        EnchFilterGroup:Paragraph({Title="Error", Desc="Failed to load Enchantments Config"})
    end
end
-- ============================================================================
-- // HEROES STATS UI (UPDATED WITH DROPDOWN)
-- ============================================================================

-- [VAR] Variable untuk menyimpan UUID Hero yang sedang dipilih user
local SelectedHeroUID = nil 

-- [1] DROPDOWN SELECTOR
local HeroSelectDrop = FarmTab:Dropdown({
    Title = "Select Hero to Manage",
    Desc = "Select which equipped hero to view and roll.",
    Values = {}, -- Akan diisi otomatis oleh Updater
    Multi = false,
    Flag = "HeroSelect_Dropdown",
    Callback = function(val)
        -- Simpan UUID hero yang dipilih
        SelectedHeroUID = (type(val) == "table" and val.Value) or val
        
        -- Reset Tampilan Paragraph agar user tahu sedang loading data baru
        if HeroStatsInfo then
            HeroStatsInfo:SetTitle("Updating...")
            HeroStatsInfo:SetDesc("Fetching data for selected hero...")
        end
    end
})
FM_Add("Heroes Stats", HeroSelectDrop)

-- [2] INFO PARAGRAPH
local HeroStatsInfo = FarmTab:Paragraph({
    Title = "Equipped Hero Stats",
    Desc = "Waiting for data...",
    Image = "rbxassetid://127892390350003",
    ImageSize = 40
})
FM_Add("Heroes Stats", HeroStatsInfo)

local TargetLockTier = "S"
if #RarityOptions > 0 then TargetLockTier = RarityOptions[1] end

if #RarityOptions > 0 then
    local LockDropdown = FarmTab:Dropdown({
        Title = "Auto Lock Minimum Tier",
        Desc = "Select the minimum Rarity to keep. (Applies to SELECTED Hero)",
        Values = RarityOptions,
        Default = TargetLockTier,
        Flag = "AutoLockTier_Cfg",
        Callback = function(val)
            TargetLockTier = val
            
            -- [LOGIC MANUAL CHECK SAAT GANTI TIER]
            local pData = (getgenv()).PlayerData
            if not pData or not HeroesStatsModule or not Reliable or not SelectedHeroUID then return end
            
            local newTargetIndex = RarityMap[TargetLockTier] or 999
            
            -- Pastikan Hero yang dipilih valid dan ada datanya
            if pData.Heroes and pData.Heroes[SelectedHeroUID] then
                local currentStats = pData.Heroes[SelectedHeroUID].Stats or {}
                local lockedStats = pData.LockedHeroesStats or {}
                
                for _, statName in ipairs(ValidStatsList) do
                    local currentIndex = currentStats[statName] or 1
                    local isLocked = lockedStats[statName] == true
                    
                    -- Jika stat terkunci TAPI tier-nya di bawah target baru -> UNLOCK
                    if isLocked and currentIndex < newTargetIndex then
                        Reliable:FireServer("Lock Hero Stats", {statName})
                        if Notify then Notify("Auto Unlock", "Unlocking " .. statName .. " (Below target)", "unlock") end
                        task.wait(0.1)
                    end
                end
            end
        end
    })
    FM_Add("Heroes Stats", LockDropdown)
else
    local ErrorParagraph = FarmTab:Paragraph({Title="Error", Desc="Could not load rarity list from game."})
    FM_Add("Heroes Stats", ErrorParagraph)
end

local EnableLockToggle = FarmTab:Toggle({
    Title = "Enable Auto Lock",
    Desc = "Auto lock stats meeting target tier on Selected Hero.",
    Flag = "EnableAutoLock_Cfg",
    Callback = function(val)
        Config.EnableAutoLock = val
    end
})
FM_Add("Heroes Stats", EnableLockToggle)

local AutoRollToggle = FarmTab:Toggle({
    Title = "Auto Roll Stats",
    Desc = "Rolls the Selected Hero if stats are unlocked.",
    Flag = "AutoRollHeroStats_Cfg",
    Callback = function(val)
        Config.AutoRollHeroStats = val
    end
})
FM_Add("Heroes Stats", AutoRollToggle)
local SettingsTab = Window:Tab({
    Title = "Settings",
    Icon = "settings-2"
});
local ConfigSection = SettingsTab:Section({
    Title = "Config Manager",
    Icon = "save",
    Opened = true
});
local ConfigName = "ANConfig";
SettingsTab:Input({
    Title = "Config Name",
    Placeholder = "ANConfig",
    Flag = "ConfigName_Input",
    Callback = function(txt)
        ConfigName = txt;
    end
});
SettingsTab:Button({
    Title = "Save Config",
    Icon = "save",
    Callback = function()
        (Window.ConfigManager:CreateConfig(ConfigName)):Save();
        if CurrentZoneName ~= "" and Config.SelectedEnemy then
            SaveZoneConfig(CurrentZoneName, Config.SelectedEnemy);
        end;
        Window:Notify({
            Title = "Success",
            Content = "Saved!",
            Icon = "check"
        });
    end
});
SettingsTab:Button({
    Title = "Load Config",
    Icon = "upload",
    Callback = function()
        local cfg = Window.ConfigManager:GetConfig(ConfigName);
        LoadZoneDB();
        if cfg then
            cfg:Load();
            Window:Notify({
                Title = "Success",
                Content = "Loaded!",
                Icon = "check"
            });
        end;
    end
});
SettingsTab:Button({
    Title = "Delete Config",
    Icon = "trash",
    Callback = function()
        Window.ConfigManager:DeleteConfig(ConfigName);
        Window:Notify({
            Title = "Success",
            Content = "Deleted!",
            Icon = "trash"
        });
    end
});
local SecuritySection = SettingsTab:Section({
    Title = "Game Security",
    Icon = "shield",
    Opened = true
});
SettingsTab:Paragraph({
    Title = "Game Auto Reconnect",
    Desc = "Status: FROZEN by ANHub\nBypass is running automatically."
});
if Reliable then
    Reliable.OnClientEvent:Connect(function(msg, args)
        -- [A] Logika Teleport Asli Kamu
        if msg == "Do Teleport" and type(args) == "table" then
            local targetZoneName = args[1];
            IsTeleporting = true;
            IsLoadingConfig = true;
            CurrentZoneName = targetZoneName;
            Config.SelectedEnemy = nil;
            if EnemyDropdown and EnemyDropdown.Select then
                pcall(function() EnemyDropdown:Select(nil); end);
            end;
            task.spawn(function()
                task.wait(5);
                local freshEnemies = RefreshEnemyData();
                CurrentZoneEnemiesCache = freshEnemies;
                local savedEntry = Config.ZoneConfigurations[targetZoneName];
                if savedEntry then
                    for _, enemy in ipairs(freshEnemies) do
                        if enemy.Value == savedEntry.Value then
                            Config.SelectedEnemy = enemy.Value;
                            if EnemyDropdown and EnemyDropdown.Select then
                                pcall(function() EnemyDropdown:Select(enemy.Value); end);
                            end;
                            break;
                        end;
                    end;
                end;
                IsLoadingConfig = false;
                IsTeleporting = false;
            end);
        
        -- [B] Logika Meteor Event (BARU)
        elseif msg == "Meteor Shower Started" then
            -- Server kirim nama Zone sebagai argumen (cek MeteorEvent.c Baris 136)
            local zone = args
            MeteorState.Zone = zone
            MeteorState.IsActive = true
            Notify("Meteor Event", "Shower Started in: " .. tostring(zone), "alert-circle")
            
        elseif msg == "Meteor Spawn" then
            -- Server kirim Posisi Vector3 sebagai argumen (cek MeteorEvent.c Baris 87)
            local pos = args
            if typeof(pos) == "Vector3" then
                MeteorState.Position = pos
                -- Set waktu mendarat = Waktu sekarang + 5 detik (Durasi jatuh)
                MeteorState.LandTime = os.time() + 5 
                MeteorState.IsActive = true
            end

        elseif msg == "Meteor Shower Ended" then
            MeteorState.IsActive = false
            MeteorState.Position = nil
            MeteorState.Zone = nil
        end
    end)
end
task.spawn(function()
    local prevZone = "";
    while not Window.Destroyed do
        task.wait(0.5); -- Loop check setiap 0.5 detik
        
        if not IsTeleporting then
            local detectedZone = GetCurrentMapStatus();
            
            if detectedZone and detectedZone ~= "Unknown" and detectedZone ~= prevZone then
                -- [PERBAIKAN 1] Beri jeda waktu agar Map/Asset loading selesai dulu sebelum script bekerja
                task.wait(0.7) 
                
                prevZone = detectedZone;
                CurrentZoneName = detectedZone;
                Config.SelectedEnemy = nil;
                
                if EnemyDropdown and EnemyDropdown.Select then
                    pcall(function()
                        EnemyDropdown:Select(nil);
                    end);
                end;
                
                IsLoadingConfig = true;
                
                -- [PERBAIKAN 2] Bungkus proses refresh data & UI dalam task.spawn
                -- Ini mencegah logika script memblokir render frame game (mengurangi freeze)
                task.spawn(function()
                    -- Proses berat 1: Kalkulasi Data
                    local freshEnemies = RefreshEnemyData();
                    CurrentZoneEnemiesCache = freshEnemies;
                    
                    task.wait() -- Jeda 1 frame agar UI tidak kaget
                    
                    -- Proses berat 2: Render UI
                    pcall(function()
                        if EnemyDropdown and EnemyDropdown.Refresh then
                            EnemyDropdown:Refresh(freshEnemies);
                        end
                    end);
                    
                    task.wait(0.2); -- Jeda sebelum memilih item
                    
                    local savedEntry = Config.ZoneConfigurations[detectedZone];
                    local objectToSelect = nil;
                    
                    if savedEntry then
                        for _, currentMob in ipairs(freshEnemies) do
                            if currentMob.Value == savedEntry.Value then
                                objectToSelect = currentMob;
                                Config.SelectedEnemy = currentMob.Value;
                                break;
                            end;
                        end;
                    end;
                    
                    if objectToSelect then
                        pcall(function()
                            EnemyDropdown:Select(objectToSelect.Value);
                        end);
                    end;
                    
                    IsLoadingConfig = false;
                end)
            end;
        end;
    end;
end);

task.spawn(MaintainAutoStatus);
task.spawn(function()
    task.wait(1.5);
    local DefaultConfig = "ANConfig";
    local CM = Window.ConfigManager;

    if not isfolder((FolderPath .. "/config")) then
        makefolder(FolderPath .. "/config");
    end;
    pcall(function()
        if isfile(FolderPath .. "/config/" .. DefaultConfig .. ".json") then
            local cfg = CM:GetConfig(DefaultConfig) or CM:CreateConfig(DefaultConfig);
            cfg:Load();
            LoadZoneDB();
            l:Notify({
                Title = "Config",
                Content = "Restored ANConfig",
                Icon = "check",
                Duration = 2
            });
        else
            CM:CreateConfig(DefaultConfig);
        end;
    end);
    while not Window.Destroyed do
        task.wait(10);
        pcall(function()
            local cfg = Window.ConfigManager:GetConfig(DefaultConfig);
            if cfg then
                cfg:Save();
            else
                (CM:CreateConfig(DefaultConfig)):Save();
            end;
        end);
        if CurrentZoneName ~= "" and Config.SelectedEnemy then
            SaveZoneConfig(CurrentZoneName, Config.SelectedEnemy);
        end;
    end;
end);

-- Kita gunakan Table "Optimizer" agar tidak memakan batas limit local variable Lua (Limit 200)
Optimizer = { 
    Cache = {
        Roll = {},
        Craft = {},
        Upgrade = {},
        VaultHash = "",
        VaultWasVisible = false,
        EnchantState = ""
    }
}

function Optimizer.Update_Gamemode_Dropdowns()
    -- Update setiap 1 detik agar timer akurat
    local now = os.time()
    if Optimizer.Cache.LastGamemodeUpdate and (now - Optimizer.Cache.LastGamemodeUpdate) < 1 then
        return
    end
    Optimizer.Cache.LastGamemodeUpdate = now

    -- Fungsi Helper Update Item per Dropdown
    local function UpdateItems(db, originalList, dropdownUI)
        if not db or not originalList or not dropdownUI then return end

        for _, item in ipairs(originalList) do
            local val = item.Value
            local dbData = db[val]

            if dbData and dbData.Times then
                -- Hitung Waktu Mundur
                local minDiff = GetNextTime(dbData.Times)
                
                -- Format Status String
                local statusStr = ""
                if minDiff <= 0 or minDiff >= 60 then
                    statusStr = "Status: <font color='#00ff00'><b>OPEN / ACTIVE</b></font>"
                else
                    statusStr = string.format("Opens in: <font color='#ffaa00'><b>%d mins</b></font>", minDiff)
                end
                
                -- Gabungkan Deskripsi Asli dengan Status Waktu
                local baseDesc = dbData.BaseDesc or ""
                local newDesc = baseDesc .. "\n" .. statusStr

                -- [PENTING] Gunakan :Edit untuk update deskripsi tanpa menutup dropdown
                -- Kita gunakan pcall agar script tidak error jika UI library belum support :Edit sepenuhnya
                pcall(function()
                    if dropdownUI.Edit then
                        dropdownUI:Edit(val, {
                            Desc = newDesc
                        })
                    end
                end)
            end
        end
    end

    -- Update Dropdown Dungeon, Raid, dan Defense
    -- Pastikan variable DgnDrop, RaidDrop, DefenseDB, dll bisa diakses (mereka ada di atas script ini)
    if DgnDrop then UpdateItems(dungeonDB, dungeonList, DgnDrop) end
    if RaidDrop then UpdateItems(raidDB, raidList, RaidDrop) end
    if DefenseDrop then UpdateItems(defenseDB, defenseList, DefenseDrop) end
end
function Optimizer.Update_Ascension_Logic(pData)
    if not pData.Attributes then return end
    
    local currentLevel = pData.Attributes.Level or 1
    local currentAsc = pData.Attributes.Ascension or 0
    
    -- Hitung Max Level (Logic dari Decompile)
    local maxLevel = 100 
    if LevelUpModule and LevelUpModule.GetMaxLevel then
        maxLevel = LevelUpModule.GetMaxLevel(currentAsc)
    end
    
    local pointsPerLevel = currentAsc + 1

    -- Update UI Visual (Menggunakan AscUI table)
    if not Window.Closed and AscUI and AscUI.Status then
        local pct = math.clamp(currentLevel / maxLevel, 0, 1)
        local bar = string.rep("", math.floor(pct * 10)) .. string.rep("", 10 - math.floor(pct * 10))
        
        local desc = string.format(
            "Current Ascension: %d\nLevel: %d / %d\n[%s] %d%%\nPoints Per Level: %d",
            currentAsc, currentLevel, maxLevel, bar, math.floor(pct * 100), pointsPerLevel
        )
        
        -- Logic UI Max Ascension
        if LevelUpModule and LevelUpModule.MAX_ASCENSION and currentAsc >= LevelUpModule.MAX_ASCENSION then
             AscUI.Status:SetTitle("Ascension MAXED")
             AscUI.Status:SetDesc("You have reached the maximum ascension.")
             
             if AscUI.AutoToggle and not AscUI.AutoToggle.Locked then
                 AscUI.AutoToggle:Set(false)
                 AscUI.AutoToggle:Lock()
             end
        else
            AscUI.Status:SetTitle("Progress Tracker")
            AscUI.Status:SetDesc(desc)
             if AscUI.AutoToggle and AscUI.AutoToggle.Locked then AscUI.AutoToggle:Unlock() end
        end
    end

    -- Logic Auto Ascend
    if Config.AutoAscend and currentLevel >= maxLevel then
        if Reliable then
            local now = os.time()
            if not Optimizer.Cache.LastAscendTime or (now - Optimizer.Cache.LastAscendTime) > 5 then
                pcall(function()
                    Reliable:FireServer("Ascend")
                    if Notify then Notify("Ascension", "Auto Ascending...", "chevrons-up") end
                    
                    -- Webhook
                    local hookKey = "AscensionWebhook"
                    if not LastWebhookTime[hookKey] or (now - LastWebhookTime[hookKey]) >= 10 then
                        SendUpgradeWebhook("Rank", "Ascension " .. (currentAsc + 1), currentAsc + 1, 0)
                        LastWebhookTime[hookKey] = now
                    end
                end)
                Optimizer.Cache.LastAscendTime = now
            end
        end
    end
end

function Optimizer.Update_Enchantments_Logic(pData)
    -- Update Visual UI Saja
    if EnchUI.MasterToggle and not Window.Closed then
        if pData.Materials and pData.Attributes and pData.Weapons then
            
            -- [1] DATA WEAPON & TOKEN
            local tokenKey = (EnchantmentsConfig and EnchantmentsConfig.TokenName) or "EnchantmentToken"
            local tokenCost = (EnchantmentsConfig and EnchantmentsConfig.TokenCost) or 10
            local myTokens = pData.Materials[tokenKey] or 0
            
            local currentEquipID = pData.Attributes.Weapon
            local weaponInstance = pData.Weapons[currentEquipID]
            
            -- Ambil nama cantik weapon & icon
            local weaponDisplayName = currentEquipID or "Unknown"
            local weaponIcon = "sparkles"
            local weaponRarity = "Common" 
            
            if weaponInstance and weaponInstance.Index then
                local configID = weaponInstance.Index
                if WeaponsModule and WeaponsModule[configID] then
                    local staticData = WeaponsModule[configID]
                    if staticData.Display then weaponDisplayName = staticData.Display end
                    if staticData.Template then weaponIcon = "rbxassetid://" .. tostring(staticData.Template) end
                    if staticData.Rarity then weaponRarity = staticData.Rarity end
                end
            end

            local enchantText = "None"
            if weaponInstance and weaponInstance.Enchantment then
                local rawID = weaponInstance.Enchantment
                local parts = string.split(rawID, "_")
                if #parts == 2 and EnchantmentsConfig and EnchantmentsConfig.Table then
                    local eType = parts[1]
                    local eTier = tonumber(parts[2])
                    local roman = {"I", "II", "III", "IV", "V"}
                    if EnchantmentsConfig.Table[eType] then
                        local typeInfo = EnchantmentsConfig.Table[eType]
                        enchantText = string.format("%s %s", typeInfo.Display, (roman[eTier] or eTier))
                    end
                end
            end
            
            -- [2] UPDATE MAIN TOGGLE UI (OPTIMIZED SPLIT CACHE)
            
            -- A. LOGIC TEKS (Sering berubah karena Token & Enchant)
            -- Hash ini mencakup Token, jadi Title & Desc akan update setiap roll.
            local textStateHash = string.format("%s|%s|%s", weaponDisplayName, myTokens, enchantText)
            
            if Optimizer.Cache.EnchantTextState ~= textStateHash then
                EnchUI.MasterToggle:SetTitle(string.format("%s [%s]", weaponDisplayName, enchantText))
                
                local tkInfo = MaterialsModule[tokenKey]
                local tkName = tkInfo and tkInfo.Display or "Tokens"
                local tkIcon = tkInfo and GetIcon(tkInfo.Template) or ""
                
                EnchUI.MasterToggle:SetDesc(string.format("%s%s %s/%s", tkIcon, tkName, UtilsModule.ToText(tokenCost), UtilsModule.ToText(myTokens)))
                
                Optimizer.Cache.EnchantTextState = textStateHash
            end

            -- B. LOGIC GAMBAR (Jarang berubah, HANYA saat ganti senjata)
            -- Hash ini HANYA mencakup Nama Senjata. Token TIDAK dimasukkan.
            -- Jadi SetMainImage TIDAK akan jalan saat nge-roll (FPS Aman).
            local imageStateHash = weaponDisplayName .. weaponIcon
            
            if Optimizer.Cache.EnchantImageState ~= imageStateHash then
                if EnchUI.MasterToggle.SetMainImage then
                    EnchUI.MasterToggle:SetMainImage({
                        Image = weaponIcon,
                        Title = weaponDisplayName,
                        Quantity = weaponRarity, 
                        Gradient = GetGameGradient(weaponRarity) 
                    }, 50)
                end
                Optimizer.Cache.EnchantImageState = imageStateHash
            end

            -- [3] AUTO REFRESH DROPDOWN SAAT GANTI SENJATA
            if Optimizer.Cache.LastEquippedWeapon ~= currentEquipID then
                Optimizer.Cache.LastEquippedWeapon = currentEquipID
                
                if Config.WeaponSpecificEnchants and Config.WeaponSpecificEnchants[currentEquipID] then
                    local savedFilters = Config.WeaponSpecificEnchants[currentEquipID]
                    local valueList = {}
                    for k, v in pairs(savedFilters) do
                        if v then table.insert(valueList, k) end
                    end
                    
                    if EnchUI.FilterDropdown and EnchUI.FilterDropdown.Select then
                        pcall(function() EnchUI.FilterDropdown:Select(valueList) end)
                    end
                else
                    if EnchUI.FilterDropdown and EnchUI.FilterDropdown.Select then
                        pcall(function() EnchUI.FilterDropdown:Select({}) end)
                    end
                end
            end

        end
    end
end
-- Definisi Fungsi dimasukkan ke dalam Table (Bukan local function terpisah)
function Optimizer.Update_Exchange_Logic(pData)
    local digest = GetMaterialsDigest()
    if digest ~= PrevMaterialsDigest then
        MatPreview:Refresh(BuildExchangeValues())
        PrevMaterialsDigest = digest
    end
    
    local tradeTokenCount = (pData.Materials and pData.Materials["TradeToken"]) or 0
    local materialCount = (SelectedExToken and pData.Materials and pData.Materials[SelectedExToken]) or 0
    local ratio = GetExchangeRatio(SelectedExToken)
    local inputDisplay, outputDisplay = 0, 0

    if SelectedExToken then
        if ExchangeIsBuying then
            local maxCanBuy = math.floor(tradeTokenCount / ratio)
            outputDisplay = math.floor(maxCanBuy * ExchangePercent)
            inputDisplay = outputDisplay * ratio
            if ratio < 500 then outputDisplay = outputDisplay/10 end
            MatPreview:SetDesc(string.format("Stock: %s | +%s (Buy)", UtilsModule.ToText(materialCount), UtilsModule.ToText(outputDisplay)))
            TradePreview:SetDesc(string.format("Stock: %s | -%s (Pay)", UtilsModule.ToText(tradeTokenCount), UtilsModule.ToText(inputDisplay)))
        else
            inputDisplay = math.floor(materialCount * ExchangePercent)
            outputDisplay = inputDisplay * ratio
            MatPreview:SetDesc(string.format("Stock: %s | -%s (Sell)", UtilsModule.ToText(materialCount), UtilsModule.ToText(inputDisplay)))
            TradePreview:SetDesc(string.format("Stock: %s | +%s (Get)", UtilsModule.ToText(tradeTokenCount), UtilsModule.ToText(outputDisplay)))
        end
        local info = MaterialsModule[SelectedExToken]
        if info and MatPreview.SetMainImage then
            MatPreview:SetMainImage({ Image = SelectedExIcon or (info.Template and GetIcon(info.Template)), Gradient = GetGameGradient(info.Rarity or "Common"), Quantity = info.Rarity or "Common", Title = info.Display }, 50)
        end
    else
        MatPreview:SetTitle("Select Token"); MatPreview:SetDesc("None Selected"); TradePreview:SetDesc("Waiting...")
    end
end

function Optimizer.Update_Roll_Logic(pData)
    if not pData.Vault then return end
    for rollType, toggle in pairs(RollToggleUI) do
        local config = RollConfigs[rollType] or { Cost = 1, MaterialKey = rollType.."Token", List = {} }
        local tokenKey = config.MaterialKey or (rollType .. "Token")
        local currentCount = pData.Materials[tokenKey] or 0
        
        -- Logic Visual
        local currentImage, currentRarity, currentItemName = GetRollIconAsset(rollType), nil, nil
        local foundBestIndex = 0
        if pData.Vault[rollType] then
            for k, v in pairs(pData.Vault[rollType]) do
                local idx = tonumber(k)
                if v == true and idx and idx > foundBestIndex then foundBestIndex = idx end
            end
        end
        if foundBestIndex > 0 and config.List and config.List[foundBestIndex] then
            local itemData = config.List[foundBestIndex]
            if itemData then
                if itemData.Template then currentImage = GetIcon(itemData.Template) end
                currentRarity = itemData.Rarity
                currentItemName = itemData.Display
            end
        end

        local lastState = Optimizer.Cache.Roll[rollType] or {}
        if lastState.Count ~= currentCount then pcall(function() toggle:SetDesc(GetIcon(MaterialsModule[tokenKey] and MaterialsModule[tokenKey].Template) .. (MaterialsModule[tokenKey] and MaterialsModule[tokenKey].Display) .. ":" .. UtilsModule.ToText(currentCount)) end) end
        
        if (lastState.Image ~= currentImage) or (lastState.Rarity ~= currentRarity) then
            pcall(function() if not Window.Closed and toggle.SetMainImage and currentRarity then toggle:SetMainImage({ Image = currentImage, Quantity = currentRarity, Title = currentItemName or rollType, Gradient = GetGameGradient(currentRarity) }, 50) end end)
            Optimizer.Cache.Roll[rollType] = { Image = currentImage, Rarity = currentRarity, Count = currentCount, IsMaxed = lastState.IsMaxed }
        else
            lastState.Count = currentCount
            Optimizer.Cache.Roll[rollType] = lastState
        end

        local isMaxed = (config.List and #config.List > 0 and foundBestIndex >= #config.List)
        if isMaxed and not lastState.IsMaxed then
            pcall(function() toggle:Lock(); toggle:SetTitle(rollType .. " [MAX]"); if Config["AutoRoll" .. rollType] then Config["AutoRoll" .. rollType] = false; toggle:Set(false) end end)
            local c = Optimizer.Cache.Roll[rollType] or {}; c.IsMaxed = true; Optimizer.Cache.Roll[rollType] = c
        end
    end
end

function Optimizer.Update_Craft_Logic(pData)
    for id, info in pairs(CraftToggles) do
        local data, toggle = info.Data, info.UI
        local currentLvl = (pData.Crafts and pData.Crafts[id]) or 0
        local maxLvl, nextLvl = data.MaxLevel, currentLvl + 1
        
        local newTitle, newDesc, isMaxed = "", "", false
        local curBonusStr = FormatBonusString(data.Bonuses and data.Bonuses[currentLvl])

        if currentLvl >= maxLvl then
            isMaxed = true; newTitle = data.Display .. " [MAX]"; newDesc = string.format("<b>Max Level Reached</b>\n\nActive Bonus:\n%s", curBonusStr)
        else
            local nextBonusStr = FormatBonusString(data.Bonuses and data.Bonuses[nextLvl])
            local costStr = "None"
            if data.Costs[nextLvl] then
                local parts = {}
                for matName, reqAmt in pairs(data.Costs[nextLvl]) do
                    local myAmt = pData.Materials[matName] or 0
                    local dName, dIcon = matName, ""
                    if MaterialsModule[matName] then dName = MaterialsModule[matName].Display; if MaterialsModule[matName].Template then dIcon = GetIcon(MaterialsModule[matName].Template) end end
                    table.insert(parts, string.format("%s%s %s/%s", dIcon, dName, UtilsModule.ToText(reqAmt), UtilsModule.ToText(myAmt)))
                end
                costStr = table.concat(parts, "\n")
            end
            newTitle = string.format("%s [Lv %d -> %d]", data.Display, currentLvl, nextLvl)
            newDesc = string.format("%s\n\nCurrent [Lv %d]: %s\nNext [Lv %d]: %s", costStr, currentLvl, curBonusStr, nextLvl, nextBonusStr)
        end

        local lastState = Optimizer.Cache.Craft[id] or {}
        if lastState.Title ~= newTitle then toggle:SetTitle(newTitle) end
        if lastState.Desc ~= newDesc then toggle:SetDesc(newDesc) end
        if isMaxed and not lastState.IsMaxed and toggle.SetMainImage then toggle:SetMainImage({ Image = "rbxassetid://"..tostring(data.Template), Quantity = "MAX", Title = data.Display, Gradient = GetGameGradient(data.Rarity) }, 50) end
        if lastState.Title ~= newTitle or lastState.Desc ~= newDesc or lastState.IsMaxed ~= isMaxed then Optimizer.Cache.Craft[id] = { Title = newTitle, Desc = newDesc, IsMaxed = isMaxed } end
        
        if isMaxed and Config["AutoCraft_"..id] then Config["AutoCraft_"..id] = false; toggle:Set(false) end
        
        if Config["AutoCraft_"..id] and not isMaxed and CanAffordCraft(id, nextLvl) then
            if Reliable then 
                local s = pcall(function() Reliable:FireServer("Upgrade Craft", { tostring(id) }) end) 
                if s then 
                    local now, hk = os.time(), "Craft_"..id
                    if not LastWebhookTime[hk] or (now - LastWebhookTime[hk]) >= 3 then SendUpgradeWebhook("Trainer", "Craft: "..data.Display, nextLvl, 0); LastWebhookTime[hk] = now end
                end
            end
        end
    end
end

function Optimizer.Update_Trainer_Logic(pData)
    for name, data in pairs(CombinedToggleUI) do
        local toggle, mod, isGacha = data.Toggle, data.Mod, data.IsGacha
        local currentLvl, tokenKey = 0, ""
        local itemName, currentImage, currentRarity = (mod.Display or name), "rbxassetid://84366761557806", "Common"

        if isGacha then
            if pData.Attributes and pData.GachaLevel and pData.Attributes[name] then
                local equippedIndex = pData.Attributes[name]
                if mod.List and mod.List[equippedIndex] then
                    local iData = mod.List[equippedIndex]
                    itemName, currentRarity = iData.Display, iData.Rarity
                    if iData.Template then currentImage = GetIcon(iData.Template) end
                end
                currentLvl = pData.GachaLevel[name][tostring(equippedIndex)] or 0
            end
            if currentLvl == 0 then currentLvl = 1 end
            tokenKey = mod.UpgradeMaterial or (name.."Token")
        else
            currentLvl = (pData.CrateUpgrades and pData.CrateUpgrades[name]) or 0
            if mod.ImageId then currentImage = GetIcon(mod.ImageId) end
            tokenKey = mod.TOKEN_NAME or (name.."Token")
        end

        local cost, maxLvl = mod.GetCost(currentLvl), (mod.MAX_LEVEL or mod.MaxLevel or 100)
        local currentMat = pData.Materials[tokenKey] or 0
        local matInfo = MaterialsModule[tokenKey]
        local matDisplay = string.format("%s%s", (matInfo and matInfo.Template and GetIcon(matInfo.Template) or ""), (matInfo and matInfo.Display or tokenKey))

        local newTitle, newDesc, isMaxed = "", "", false
        if currentLvl >= maxLvl then
            isMaxed = true; newTitle = itemName .. " [MAX]"; newDesc = "Max Level Reached"
        else
            local chanceTxt = (not isGacha and mod.GetChance) and (" | Chance: " .. (math.floor(mod.GetChance(currentLvl) * 10) / 10) .. "%") or ""
            newTitle = string.format("%s [%d/%d]", name, currentLvl, maxLvl)
            newDesc = string.format("Cost: %s%s\n%s: %s", UtilsModule.ToText(cost), chanceTxt, matDisplay, UtilsModule.ToText(currentMat))
        end

        local cache = Optimizer.Cache.Upgrade[name] or {}
        if cache.Title ~= newTitle then toggle:SetTitle(newTitle) end
        if cache.Desc ~= newDesc then toggle:SetDesc(newDesc) end
        if isMaxed and not cache.IsMaxed then toggle:Lock(); local k = isGacha and ("AutoUpgrade_"..name) or ("AutoChance_"..name); if Config[k] then Config[k] = false; toggle:Set(false) end end
        if isGacha and toggle.SetMainImage and (cache.Image ~= currentImage or cache.Rarity ~= currentRarity) then toggle:SetMainImage({ Image = currentImage, Quantity = currentRarity, Title = itemName, Gradient = GetGameGradient(currentRarity) }, 50) end
        
        Optimizer.Cache.Upgrade[name] = { Title = newTitle, Desc = newDesc, IsMaxed = isMaxed, Image = currentImage, Rarity = currentRarity }
    end
end

function Optimizer.Update_Vault_Logic(pData)
    -- Fungsi Helper untuk membuat "Sidik Jari" data saat ini
    local function GetVaultSnapshot(pd)
        if not pd.Attributes then return "" end
        local s = {}
        
        -- 1. Masukkan data Vault (Luck, Yen, dll) ke dalam sidik jari
        if pd.Vault then
            for c, _ in pairs(pd.Vault) do 
                if pd.Attributes[c] then s[c] = pd.Attributes[c] end 
            end
        end
        
        -- 2. Masukkan data Accessory
        if pd.Attributes.Accessory then s["Accessory"] = pd.Attributes.Accessory end

        -- 3. [PERBAIKAN] Masukkan data WEAPON
        -- Tanpa baris ini, script tidak tahu kalau senjata berubah
        if pd.Attributes.Weapon then s["Weapon"] = pd.Attributes.Weapon end

        return HttpService:JSONEncode(s)
    end
    
    local IsVisible = VaultGroup and VaultGroup.GroupFrame and VaultGroup.GroupFrame.Visible
    local CurrentHash = GetVaultSnapshot(pData)
    
    -- Cek apakah sidik jari berubah?
    local DataChanged = (CurrentHash ~= Optimizer.Cache.VaultHash)
    
    if DataChanged then 
        Optimizer.Cache.VaultHash = CurrentHash 
    end
    
    -- Refresh UI jika Data Berubah DAN Tab sedang dibuka
    -- ATAU jika Tab baru saja dibuka (VaultWasVisible false -> true)
    if (DataChanged and IsVisible) or (IsVisible and not Optimizer.Cache.VaultWasVisible) then 
        RefreshVaultUI() 
    end
    
    Optimizer.Cache.VaultWasVisible = IsVisible
end

function Optimizer.Update_Avatar_Logic(pData)
        if not pData.AvatarLevels then return end
        if pData and pData.Attributes and pData.AvatarLevels and pData.Materials and AvatarLevelsModule then
            
            -- [1. AMBIL DATA AVATAR]
            local currentAvatar = pData.Attributes.Avatar
            local isAvatarSelected = currentAvatar and currentAvatar ~= ""

            -- Ambil Level & Token
            local currentLevel = pData.AvatarLevels[currentAvatar] or 0
            local maxLevel = AvatarLevelsModule.MaxLevel or 100
            local tokenKey = AvatarLevelsModule.Token or "AvatarToken"
            local myTokens = pData.Materials[tokenKey] or 0
            
            -- [2. UPDATE VISUAL UI]
            local avatarDisplayName = currentAvatar
            local tokenDisplayName = tokenKey 

            pcall(function()
                local newTitle = "No Avatar Selected"
                local newDesc = "Select an avatar in the game's interface to begin."
                
                if isAvatarSelected then
                    -- 1. Ambil Nama Asli Avatar (Cari di EnemiesConfig)
                    if EnemiesConfig and EnemiesConfig[currentAvatar] and EnemiesConfig[currentAvatar].Display then
                        avatarDisplayName = EnemiesConfig[currentAvatar].Display
                    end

                    -- 2. Ambil Nama Asli Token (Cari di MaterialsModule)
                    if MaterialsModule and MaterialsModule[tokenKey] and MaterialsModule[tokenKey].Display then
                        tokenDisplayName = MaterialsModule[tokenKey].Display
                    end

                    local nextLevel = currentLevel + 1
                    local isMaxed = currentLevel >= maxLevel
                    
                    local currentBuff = AvatarLevelsModule.GetBuff(currentLevel)
                    local nextBuff = isMaxed and currentBuff or AvatarLevelsModule.GetBuff(nextLevel)
                    local cost = isMaxed and 0 or AvatarLevelsModule.GetCost(currentLevel)
                    
                    local costStr = UtilsModule.ToText(cost, 0)
                    local tokenCountStr = UtilsModule.ToText(myTokens, 0)
                    
                    -- Update Title menggunakan avatarDisplayName
                    newTitle = string.format("%s (Lv. %d / %d)", avatarDisplayName, currentLevel, maxLevel)
                    
                    if isMaxed then
                        newDesc = string.format("<b>MAX Level Reached!</b>\n\nBuff: +%s%%\n%s %s", 
                            UtilsModule.ToText(currentBuff),GetAvatarTokenIcon(), tokenCountStr)
                        AvatarLevelToggle:Lock()
                        AvatarLevelToggle:SetTitle("Auto Avatar Level Up [MAX]")
                        Config.AutoAvatarLevelUp = false
                        AvatarLevelToggle:Set(false)
                    else
                        -- Update Desc menggunakan tokenDisplayName
                        newDesc = string.format("<b>Current Buff: +%s%%</b>\nNext Buff: +%s%%\n\nCost: %s / %s (%s %s)",
                            UtilsModule.ToText(currentBuff), UtilsModule.ToText(nextBuff),
                            costStr, tokenCountStr,GetAvatarTokenIcon(), tokenDisplayName)
                        AvatarLevelToggle:Unlock()
                        AvatarLevelToggle:SetTitle("Auto Avatar Level Up")
                    end
                else
                    Config.AutoAvatarLevelUp = false
                    AvatarLevelToggle:Set(false)
                    AvatarLevelToggle:Lock()
                end

                if not Window.Closed then
                    AvatarStatusPara:SetTitle(newTitle)
                    AvatarStatusPara:SetDesc(newDesc)
                end
            end)

            -- [3. LOGIC AUTO UPGRADE]
            if Config.AutoAvatarLevelUp and isAvatarSelected and currentLevel < maxLevel then
                local cost = AvatarLevelsModule.GetCost(currentLevel)
                
                if myTokens >= cost then
                    if Reliable then
                        local s = pcall(function()
                            Reliable:FireServer("Avatar Upgrade")
                        end)
                        
                        if s then
                            -- Gunakan avatarDisplayName untuk Notify
                            Notify("Avatar", string.format("Auto Level Up: %s to Lv. %d", avatarDisplayName, currentLevel + 1), "arrow-up")
                            local now = os.time()
                            if not LastWebhookTime["AvatarLevels"] or (now - LastWebhookTime["AvatarLevels"]) >= 10 then
                                local newLevel = currentLevel + 1
                                local max = AvatarLevelsModule.MaxLevel or 100 -- Mengambil maxLevel dari config
                                local buffPercentage = AvatarLevelsModule.GetBuff(newLevel)
                                SendAvatarUpgradeWebhook(avatarDisplayName, newLevel, max, buffPercentage)
                                LastWebhookTime["AvatarLevels"] = now
                            end                            
                            -- Tunggu sinkronisasi data dari server
                            task.wait(1.5)  
                        end
                    end
                end
            end
        else
            -- Jika data belum dimuat, pastikan toggle mati dan terkunci
            pcall(function()
                if AvatarLevelToggle and not AvatarLevelToggle.Locked then
                    AvatarLevelToggle:Lock()
                    AvatarLevelToggle:SetTitle("Auto Avatar Level Up [Waiting Data]")
                    Config.AutoAvatarLevelUp = false
                    AvatarLevelToggle:Set(false)
                end
            end)
        end
end

function Optimizer.Update_Heroes_Logic(pData)
    if not HeroesStatsModule or not Reliable or not pData.EquippedHeroes or not pData.Heroes then return end
    
    -- Init Cache Variables
    if not Optimizer.Cache.LastHeroRollTime then Optimizer.Cache.LastHeroRollTime = 0 end
    if not Optimizer.Cache.EquippedHeroesHash then Optimizer.Cache.EquippedHeroesHash = "" end

    -- [1] KUMPULKAN HERO YANG SEDANG DIPAKAI (EQUIPPED)
    local activeHeroesList = {}
    local hashBuilder = "" 
    
    for uid, isEquipped in pairs(pData.EquippedHeroes) do 
        if isEquipped == true and pData.Heroes[uid] then 
            local hData = pData.Heroes[uid]
            local hName = "Unknown"
            local hRarity = "Common"
            local damageDisplay = "0%"
            
            if HeroesConfigModule and hData.Index and HeroesConfigModule[hData.Index] then
                local cfg = HeroesConfigModule[hData.Index]
                hName = cfg.Display or hName
                hRarity = cfg.Rarity or hRarity
                
                local baseDamage = cfg.Damage or 0
                local damageStatIndex = (hData.Stats and hData.Stats.Damage) or 1
                
                local buffMultiplier = 1
                if HeroesStatsModule.GetBuff then
                    pcall(function()
                        buffMultiplier = HeroesStatsModule.GetBuff("Damage", damageStatIndex)
                    end)
                end
                
                local finalDamage = baseDamage * 100 * buffMultiplier
                damageDisplay = UtilsModule.ToText(finalDamage, 3) .. "%"
            end
            
            local displayTitle = string.format("%s [%s]", hName, hRarity)

            table.insert(activeHeroesList, {
                Title = displayTitle,
                Value = uid,
                Desc = "Damage: " .. damageDisplay
            })
            
            hashBuilder = hashBuilder .. uid
        end 
    end
    
    -- [2] UPDATE DROPDOWN
    if hashBuilder ~= Optimizer.Cache.EquippedHeroesHash then
        table.sort(activeHeroesList, function(a,b) return a.Title < b.Title end)
        
        if HeroSelectDrop and HeroSelectDrop.Refresh then
            HeroSelectDrop:Refresh(activeHeroesList)
        end
        
        if not SelectedHeroUID and #activeHeroesList > 0 then
            SelectedHeroUID = activeHeroesList[1].Value
            if HeroSelectDrop.Select then
                pcall(function() HeroSelectDrop:Select(SelectedHeroUID) end)
            end
        end
        
        Optimizer.Cache.EquippedHeroesHash = hashBuilder
    end

    -- [3] TAMPILKAN STATS HERO YANG DIPILIH
    local isValidSelection = false
    if SelectedHeroUID and pData.EquippedHeroes[SelectedHeroUID] == true then
        isValidSelection = true
    else
        if #activeHeroesList > 0 then
            SelectedHeroUID = activeHeroesList[1].Value
            isValidSelection = true
            if HeroSelectDrop.Select then pcall(function() HeroSelectDrop:Select(SelectedHeroUID) end) end
        end
    end

    if isValidSelection and SelectedHeroUID then
        local hData = pData.Heroes[SelectedHeroUID]
        local hStats = hData.Stats or {}
        local lStats = pData.LockedHeroesStats or {}
        
        local hName = "Unknown Hero"
        local hRarity = "Common"
        local hDamageStr = "0%"

        if HeroesConfigModule and hData.Index and HeroesConfigModule[hData.Index] then
            local cfg = HeroesConfigModule[hData.Index]
            hName = cfg.Display or hName
            hRarity = cfg.Rarity or hRarity
            
            local baseDamage = cfg.Damage or 0
            local damageStatIndex = hStats.Damage or 1
            local buffMultiplier = 1
            if HeroesStatsModule.GetBuff then
                pcall(function() buffMultiplier = HeroesStatsModule.GetBuff("Damage", damageStatIndex) end)
            end
            hDamageStr = UtilsModule.ToText(baseDamage * 100 * buffMultiplier, 3) .. "%"
        end
        
        -- A. UPDATE VISUAL PARAGRAPH
        if not Window.Closed then
            local lines = ""
            for _, sName in ipairs(ValidStatsList) do
                local sIdx = hStats[sName] or 1
                local sColor = GetModularColor(sIdx)
                local sRankName = RarityIndexMap[sIdx] or "?"
                local sBuff = GetClassBuffPercentage(sName, sIdx)
                local sLockStatus = (lStats[sName] and "" or "")
                
                lines = lines .. string.format('<font color="#%s"><b>[%s]</b></font> %s (%s): %s\n', sColor, sRankName, sName, sBuff, sLockStatus)
            end
            
            -- [PERUBAHAN BARU] Menambahkan Material Shards di paling bawah
            local myShards = pData.Materials.HeroesStats or 0
            local shardsStr = UtilsModule.ToText(myShards)
            
            -- Tambahkan baris kosong lalu info material dengan warna mencolok (Cyan/Biru Muda)
            lines = lines .. string.format('\n<font color="#00ffff"><b>Hero Shards:</b></font> %s', shardsStr)
            
            -- Update UI (Judul bersih, Material di deskripsi)
            HeroStatsInfo:SetTitle(string.format("%s [%s] - %s DMG", hName, hRarity, hDamageStr))
            HeroStatsInfo:SetDesc(lines)
        end
        
        -- B. LOGIC AUTO LOCK & ROLL
        if Config.AutoRollHeroStats then
            local currency = pData.Materials.HeroesStats or 0
            if currency > 0 then
                local safeToRoll = true
                
                if Config.EnableAutoLock then
                    local targetIdx = RarityMap[TargetLockTier] or 999
                    for _, sName in ipairs(ValidStatsList) do
                        local currentIdx = hStats[sName] or 1
                        if currentIdx >= targetIdx and not lStats[sName] then
                            Reliable:FireServer("Lock Hero Stats", {sName})
                            if Notify then Notify("Auto Lock", "Locking "..sName.." ("..hName..")", "lock") end
                            safeToRoll = false
                            task.wait(0.2)
                        end
                    end
                end
                
                if safeToRoll and currency > 15 then
                    if (os.time() - Optimizer.Cache.LastHeroRollTime) >= 2 then
                        local anyUnlocked = false
                        for _, sName in ipairs(ValidStatsList) do 
                            if not lStats[sName] then anyUnlocked = true; break end 
                        end
                        
                        if anyUnlocked then
                            Reliable:FireServer("Roll Hero Stats", {SelectedHeroUID, false})
                            Optimizer.Cache.LastHeroRollTime = os.time()
                        end
                    end
                end
            end
        end
    else
        HeroStatsInfo:SetTitle("No Hero Selected")
        HeroStatsInfo:SetDesc("Please equip a hero and select it from the dropdown.")
    end
end

function Optimizer.Update_Main_Data_Logic(pData)
    -- Rank
    local cRank, cMastery = (pData.Attributes.Rank or 0), (pData.Attributes.Mastery or 0)
    local req, cBuff, nBuff = RankModule.GetRequirement(cRank), RankModule.GetBuff(cRank), RankModule.GetBuff(cRank+1)
    
    if RankProgressUI and not Window.Closed then
        local pct = req>0 and math.clamp(cMastery/req,0,1) or 0
        local bar = string.rep("", math.floor(pct*10)) .. string.rep("", 10-math.floor(pct*10))
        local bt = (cRank>=RankModule.MAX) and ("Buff: "..UtilsModule.ToText(cBuff).."% (MAX)") or ("Buff: "..UtilsModule.ToText(cBuff).."% >> "..UtilsModule.ToText(nBuff).."%")
        RankProgressUI:SetTitle("Rank "..cRank); RankProgressUI:SetDesc(string.format("%s\n[%s] %d%%\n%s / %s", bt, bar, math.floor(pct*100), UtilsModule.ToText(cMastery), UtilsModule.ToText(req)))
    end
    if Config.AutoRankUp and cMastery >= req and cRank < RankModule.MAX then
         if Reliable then pcall(function() Reliable:FireServer("RankUp") end) end
    end

    -- Yen
    if pData.YenUpgrades then
        local cYen = pData.Attributes.Yen or 0
        for name, cfg in pairs(YenUpgradeConfig) do
            local lvl = pData.YenUpgrades[name] or 0
            local cost, buff = YenModule.GetUpgradeCost(lvl, name), YenModule.GetUpgradeBuff(name, lvl)
            local toggle = YenUpgradeToggleUI[name]
            local max = cfg.MaxLevel or 20
            
            if toggle and not Window.Closed then
                if lvl >= max then toggle:SetTitle(name.." [MAX]"); toggle:SetDesc("Maxed (Buff: +"..UtilsModule.ToText(buff).."%)"); if not toggle.Locked then toggle:Lock(); toggle:Set(false) end
                else toggle:SetTitle(name.." ["..lvl.."/"..max.."]"); toggle:SetDesc("Cost: "..UtilsModule.ToText(cost).." | Buff: +"..UtilsModule.ToText(buff).."%") end
            end
            if Config["AutoYen_"..name] and cYen >= cost and lvl < max and Reliable then
                 pcall(function() Reliable:FireServer("Yen Upgrade", {name}) end)
            end
        end
    end
    
    -- Token
    if pData.TokenUpgrades then
        local cTok = pData.Materials.UpgradeToken or 0
        for name, cfg in pairs(TokenUpgradeConfig) do
            local lvl = pData.TokenUpgrades[name] or 0
            local cost, buff = TokenModule.GetUpgradeCost(lvl, name), TokenModule.GetUpgradeBuff(name, lvl)
            local toggle = TokenUpgradeToggleUI[name]
            local max = cfg.MaxLevel or 999
            
            if toggle and not Window.Closed then
                 if lvl >= max then toggle:SetTitle(name.." [MAX]"); toggle:SetDesc("Maxed (Buff: +"..UtilsModule.ToText(buff).."%)"); if not toggle.Locked then toggle:Lock() end
                 else toggle:SetTitle(name.." ["..lvl.."/"..max.."]"); toggle:SetDesc("Cost: "..UtilsModule.ToText(cost).." | Buff: +"..UtilsModule.ToText(buff).."%\nShard: "..UtilsModule.ToText(cTok)) end
            end
            if Config["AutoToken_"..name] and cTok >= cost and lvl < max and Reliable then
                 pcall(function() Reliable:FireServer("Token Upgrade", {name}) end)
            end
        end
    end
end

-- MAIN GLOBAL LOOP TRIGGER
task.spawn(function()
    while not Window.Destroyed do
        local pData = (getgenv()).PlayerData
        if not pData then 
            ScanPlayerData() 
        else
            -- Jalankan semua update UI dalam satu frame (Protected Call agar error satu tidak mematikan yg lain)
            pcall(Optimizer.Update_Ascension_Logic, pData)
            pcall(Optimizer.Update_Enchantments_Logic, pData)
            pcall(Optimizer.Update_Exchange_Logic, pData)
            pcall(Optimizer.Update_Roll_Logic, pData)
            pcall(Optimizer.Update_Craft_Logic, pData)
            pcall(Optimizer.Update_Trainer_Logic, pData)
            pcall(Optimizer.Update_Vault_Logic, pData)
            pcall(Optimizer.Update_Avatar_Logic, pData)
            pcall(Optimizer.Update_Heroes_Logic, pData)
            pcall(Optimizer.Update_Main_Data_Logic, pData)
            pcall(Optimizer.Update_Gamemode_Dropdowns)
        end
        task.wait(0.5) -- GLOBAL THROTTLE (1 DETIK)
    end
end)
Window:SelectTab(FarmTab.Index);
