if game.PlaceId ~= 95760142548121 then return end
repeat task.wait() until game:IsLoaded()
getgenv().SLoading = getgenv().SLoading or {}
getgenv().SLoading.SubTitle = "Anime Spike"
loadstring(game:HttpGet("https://raw.githubusercontent.com/ANHub-Script/ANUI/refs/heads/main/dist/loading.lua"))()

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ReplicatedFirst = game:GetService("ReplicatedFirst")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local VirtualUser = game:GetService("VirtualUser")
local UserInputService = game:GetService("UserInputService")

local FolderPath = "ANUI/AnimeSpike"
local ExpiryFile = FolderPath .. "/ANHub_Key_Timer.txt"
local IsPremium = false
local ValidKeys = {"ANHUB-2025"}
local Config = {
    SelectedEnemies = {}, -- Berubah menjadi tabel untuk mendukung Multi-Select
    AutoFarm = false
}

-- Variabel global untuk menampung target aktif saat ini
local currentTarget = nil
local ConfigName = "ANHub"
local CurrentMapEnemiesCache = {}
local IsLoadingConfig = false

local UI
local Window

-- Jalur Library yang benar sesuai decompile
-- Tambahkan di bawah variabel Config (Sekitar baris 30)

-- ==========================================
-- MANUAL SERVICE LOCATOR (FIX ERROR)
-- ==========================================
local LibraryModule = ReplicatedStorage:WaitForChild("frame_work"):WaitForChild("library")

local NightXLibrary = {}

-- Bypass get_service: Langsung require ke folder _services
function NightXLibrary.get_service(name)
    return require(LibraryModule:WaitForChild("_services"):WaitForChild(name))
end

-- Bypass get_index: Langsung require ke folder _index
function NightXLibrary.get_index(name)
    return require(LibraryModule:WaitForChild("_index"):WaitForChild(name))
end

-- Bypass get_connection: Langsung ambil dari module connection
function NightXLibrary.get_connection()
    return require(LibraryModule:WaitForChild("connection")).getConnection()
end

-- ==========================================
-- INISIALISASI DATA & SERVICES
-- ==========================================
local Debounce = NightXLibrary.get_service("debounce_service")
local Connection = NightXLibrary.get_connection()
local AbbreviateService = NightXLibrary.get_service("abbreviate_service")
local GradientFolder = ReplicatedStorage:WaitForChild("_assets"):WaitForChild("_gradients")
local EnemiesIndex = NightXLibrary.get_index("_enemies")
local DropsIndex = NightXLibrary.get_index("_drops")
local ItemsIndex = NightXLibrary.get_index("_items")
local VaultGachasIndex = NightXLibrary.get_index("_vault_gachas")
local AccessoriesIndex = NightXLibrary.get_index("_accessories")
local AscensionData = NightXLibrary.get_index("_ascension")
local IslandsIndex = NightXLibrary.get_index("_islands")
local WeaponsIndex = NightXLibrary.get_index("_weapons")
local MultsIndex = NightXLibrary.get_index("_mults")
-- Fungsi untuk mengecek apakah sedang dalam Minigame
local function IsInMinigame()
    local enemiesFolder = workspace:FindFirstChild("_enemies")
    if enemiesFolder then
        local firstEnemy = enemiesFolder:FindFirstChildOfClass("Model")
        if firstEnemy then
            -- Menambahkan pengecekan atribut _area -200
            if firstEnemy:GetAttribute("Minigame") or firstEnemy:GetAttribute("_area") == -200 then
                return true
            end
        end
    end
    return false
end

-- ==========================================
-- PERBAIKAN FUNGSI GETBESTTARGET
-- ==========================================
local function GetBestTarget()
    local enemiesFolder = workspace:FindFirstChild("_enemies")
    if not enemiesFolder then return nil end
    
    local inMinigame = IsInMinigame()
    -- Jika tidak di minigame dan tidak ada musuh yang dipilih di dropdown, batalkan target
    if not inMinigame and #Config.SelectedEnemies == 0 then return nil end
    
    local target = nil
    local shortestDist = math.huge
    local myRoot = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not myRoot then return nil end

    for _, v in pairs(enemiesFolder:GetChildren()) do
        local enemyArea = v:GetAttribute("_area")
        local isMinigameEnemy = v:GetAttribute("Minigame") or enemyArea == -200
        
        -- LOGIKA FILTER:
        -- 1. Jika di Minigame: Hanya boleh target musuh yang punya atribut Minigame/Area -200
        -- 2. Jika Farm Biasa: Hanya target musuh yang ada di daftar SelectedEnemies (Dropdown)
        local isSelected = false
        if inMinigame then
            isSelected = isMinigameEnemy 
        else
            -- Pastikan musuh bukan musuh minigame saat sedang farm biasa
            isSelected = not isMinigameEnemy and table.find(Config.SelectedEnemies, v.Name)
        end
        
        if isSelected and v:FindFirstChild("HumanoidRootPart") and v:GetAttribute("_id") then
            local currentHP = v:GetAttribute("_h")
            if currentHP and currentHP > 0 then
                local dist = (v.HumanoidRootPart.Position - myRoot.Position).Magnitude
                if dist < shortestDist then
                    shortestDist = dist
                    target = v
                end
            end
        end
    end
    return target
end

local function GetEnemiesList()
    local list = {}
    local processed = {}
    local enemiesFolder = workspace:FindFirstChild("_enemies")
    
    if enemiesFolder then
        for _, enemy in pairs(enemiesFolder:GetChildren()) do
            if enemy:GetAttribute("_id") and not processed[enemy.Name] then
                processed[enemy.Name] = true
                
                local stats = EnemiesIndex[enemy.Name]
                if stats then
                    local displayName = stats[1]
                    local mapId = stats[3]
                    
                    local maxHP = enemy:GetAttribute("_m_h") or stats[2]
                    local maxDisplay = AbbreviateService and AbbreviateService:Comma(maxHP) or tostring(maxHP)
                    
                    local dropCards = {}
                    local targetDropData = DropsIndex[enemy.Name]

                    if not targetDropData then
                        for islandKey, islandInfo in pairs(IslandsIndex) do
                            if islandInfo[3] == mapId then
                                targetDropData = DropsIndex[islandKey]
                                if targetDropData then break end
                            end
                        end
                    end
                    
                    if targetDropData then
                        for groupIndex, groupItems in pairs(targetDropData) do
                            if typeof(groupIndex) == "number" and typeof(groupItems) == "table" then
                                for rate, details in pairs(groupItems) do
                                    if typeof(rate) == "number" and typeof(details) == "table" then
                                        local itemId = details[1]
                                        local rawAmount = details[2]
                                        local dropType = details[3]
                                        
                                        local itemInfo = nil
                                        local itemName = "Unknown"
                                        local itemImage = "rbxassetid://0"
                                        
                                        if dropType == "Accessory" or AccessoriesIndex[itemId] then
                                            itemInfo = AccessoriesIndex[itemId]
                                            if itemInfo then
                                                itemName = itemInfo[1]
                                                itemImage = itemInfo["_image"]
                                            end
                                        end
                                        
                                        if not itemInfo then
                                            itemInfo = ItemsIndex[itemId]
                                            if itemInfo then
                                                itemName = itemInfo[1][1]
                                                itemImage = itemInfo["_image"]
                                            end
                                        end
                                        
                                        if itemInfo then
                                            local amountStr = (typeof(rawAmount) == "table") and (rawAmount[1] .. "-" .. rawAmount[2] .. "x") or (tostring(rawAmount or 1) .. "x")
                                            local rarityName = (dropType == "Accessory") and "Legendary" or (itemInfo.Rarity or "Common")
                                            local gradObj = GradientFolder:FindFirstChild(rarityName)

                                            table.insert(dropCards, {
                                                Title = itemName,
                                                Quantity = amountStr,
                                                Rate = rate .. "%",
                                                Gradient = gradObj and gradObj.Color or Color3.fromRGB(0, 162, 255),
                                                Image = itemImage
                                            })
                                        end
                                    end
                                end
                            end
                        end
                    end
                    
                    table.insert(list, {
                        Title = string.format("%s", displayName),
                        Desc = string.format("HP: %s", maxDisplay),
                        Images = dropCards, 
                        RawName = enemy.Name,
                        Rarity = maxHP
                    })
                end
            end
        end
    end
    table.sort(list, function(a, b) return (a.Rarity or 0) < (b.Rarity or 0) end)
    return list
end

local function SendConnection(...)
    -- Simpan kode biner panjang di dalam variabel agar rapi
    -- local binaryData = "01010010 01100101 01110000 01101100 01101001 01100011 01100001 01110100 01100101 01100100 01010011 01110100 01101111 01110010 01100001 01100111 01100101 00101110 01001110 01101001 01100111 01101000 01110100 01011000 00101110 01001100 01101001 01100010 01110010 01100001 01110010 01111001 00101110 01000011 01101111 01101110 01101110 01100101 01100011 01110100 01101001 01101111 01101110 00101110 01110100 01101000 01110010 01100101 01100001 01100100 01011111 01110011 01100101 01100011 01110101 01110010 01101001 01110100 01111001 00111010 00110001 00001010 01010010 01100101 01110000 01101100 01101001 01100011 01100001 01110100 01100101 01100100 01010011 01110100 01101111 01110010 01100001 01100111 01100101 00101110 01001110 01101001 01100111 01101000 01110100 01011000 00101110 01001100 01101001 01100010 01110010 01100001 01110010 01111001 00101110 01000011 01101111 01101110 01101110 01100101 01100011 01110100 01101001 01101111 01101110 00111010 00110001 00110101 00110110 00100000 01100110 01110101 01101110 01100011 01110100 01101001 01101111 01101110 00100000 01110011 01100101 01101110 01100100 00001010 01010010 01100101 01110000 01101100 01101001 01100011 01100001 01110100 01100101 01100100 01010011 01110100 01101111 01110010 01100001 01100111 01100101 00101110 01001110 01101001 01100111 01101000 01110100 01011000 00101110 01001100 01101001 01100010 01110010 01100001 01110010 01111001 00101110 01000011 01101100 01101001 01100101 01101110 01110100 00101110 01000101 01100111 01100111 01010011 01100101 01110100 01110101 01110000 00111010 00110001 00110010 00110101 00100000 01100110 01110101 01101110 01100011 01110100 01101001 01101111 01101110 00100000 01001111 01110000 01100101 01101110 01000101 01100111 01100111 00001010 01010010 01100101 01110000 01101100 01101001 01100011 01100001 01110100 01100101 01100100 01010011 01110100 01101111 01110010 01100001 01100111 01100101 00101110 01001110 01101001 01100111 01101000 01110100 01011000 00101110 01001100 01101001 01100010 01110010 01100001 01110010 01111001 00101110 01000011 01101100 01101001 01100101 01101110 01110100 00101110 01000101 01100111 01100111 01010011 01100101 01110100 01110101 01110000 00111010 00110011 00110101 00111000 00001010"
    local binaryData = "01010010 01100101 01110000 01101100 01101001 01100011 01100001 01110100 01100101 01100100 01010011 01110100 01101111 01110010 01100001 01100111 01100101 00101110 01100110 01110010 01100001 01101101 01100101 01011111 01110111 01101111 01110010 01101011 00101110 01101100 01101001 01100010 01110010 01100001 01110010 01111001 00101110 01100011 01101111 01101110 01101110 01100101 01100011 01110100 01101001 01101111 01101110 00101110 01110100 01101000 01110010 01100101 01100001 01100100 01011111 01110011 01100101 01100011 01110101 01110010 01101001 01110100 01111001 00111010 00110001 00001010 01010010 01100101 01110000 01101100 01101001 01100011 01100001 01110100 01100101 01100100 01010011 01110100 01101111 01110010 01100001 01100111 01100101 00101110 01100110 01110010 01100001 01101101 01100101 01011111 01110111 01101111 01110010 01101011 00101110 01101100 01101001 01100010 01110010 01100001 01110010 01111001 00101110 01100011 01101111 01101110 01101110 01100101 01100011 01110100 01101001 01101111 01101110 00111010 00110001 00110101 00111001 00100000 01100110 01110101 01101110 01100011 01110100 01101001 01101111 01101110 00100000 01110011 01100101 01101110 01100100 00001010 01010010 01100101 01110000 01101100 01101001 01100011 01100001 01110100 01100101 01100100 01010011 01110100 01101111 01110010 01100001 01100111 01100101 00101110 01100110 01110010 01100001 01101101 01100101 01011111 01110111 01101111 01110010 01101011 00101110 01101100 01101001 01100010 01110010 01100001 01110010 01111001 00101110 01011111 01110011 01100101 01110100 01110101 01110000 01110011 00101110 01000011 01001111 01010010 01000101 00101110 01011111 01110011 01100101 01110100 01110100 01110101 01110000 01110011 00101110 00110001 00100000 11100010 10000000 10100010 00100000 01101101 01101111 01110110 01100101 00100000 01110011 01100101 01110100 00101110 00110010 00100000 11100010 10000000 10100010 00100000 01101101 01101111 01110101 01110011 01100101 00111010 00110101 00111000 00001010"
    -- Menggabungkan biner dengan argumen tambahan yang kamu masukkan
    local args = {binaryData}
    local extra = {...}
    
    for i = 1, #extra do
        table.insert(args, extra[i])
    end

    -- Mencari RemoteEvent dan mengirim data
    for _, v in pairs(game:GetService("ReplicatedStorage"):GetDescendants()) do
        if v:IsA("RemoteEvent") then
            v:FireServer(unpack(args))
        end
    end
end

local function JSONPretty(val, indent)
    indent = indent or 0;
    local valType = typeof(val); -- Menggunakan typeof untuk deteksi Instance
    
    if valType == "table" then
        local s = "{\n";
        for k, v in pairs(val) do
            local formattedKey = typeof(k) == "number" and tostring(k) or "\"" .. tostring(k) .. "\"";
            s = s .. string.rep("    ", indent + 1) .. formattedKey .. ": " .. tostring(JSONPretty(v, indent + 1)) .. ",\n";
        end;
        return s .. string.rep("    ", indent) .. "}";
    elseif valType == "string" then
        return "\"" .. val .. "\"";
    elseif valType == "Instance" then
        -- PERBAIKAN: Jika objek adalah Instance, ambil jalur lengkapnya (Hierarchy)
        return "\"" .. val:GetFullName() .. "\""; 
    elseif valType == "function" then
        local info = debug.getinfo(val)
        return "\"function: " .. tostring(info.source) .. " | Line: " .. tostring(info.linedefined) .. "\"";
    else
        -- Untuk tipe data lain seperti boolean, number, atau RBXScriptConnection
        local result = tostring(val)
        if valType == "number" or valType == "boolean" then
            return result
        else
            return "\"" .. result .. "\""
        end
    end;
end;

-- setclipboard(JSONPretty(DropsIndex, 1))
local function Notify(title, content, icon)
    task.spawn(function()
        pcall(function()
            if UI and UI.Notify then
                UI:Notify({ Title = title, Content = content, Icon = icon, Duration = 3 })
            end
        end)
    end)
end

task.spawn(function()
    repeat task.wait() until game:GetService("Players").LocalPlayer
    local LP = game:GetService("Players").LocalPlayer

    LP.Idled:Connect(function()
        local VirtualUser = game:GetService("VirtualUser")
        VirtualUser:Button2Down(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
        task.wait(1)
        VirtualUser:Button2Up(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
    end)
end)

local GameIconURL = string.format("rbxthumb://type=GameIcon&id=%d&w=150&h=150", game.GameId)
local BaseProfile = {
    Banner = "rbxassetid://124762019485618", 
    Avatar = "rbxassetid://84366761557806", 
    Status = true,
    Badges = {
        {
            Icon = "geist:logo-discord", Title = "Discord", Desc = "Join ANHUB Discord",
            Callback = function() setclipboard("https://discord.gg/bUkCZvmrpH") Notify("Discord", "Invite link copied!", "geist:logo-discord") end
        },
        {
            Icon = "youtube", Desc = "Subscribe to YouTube",
            Callback = function() setclipboard("https://www.youtube.com/@ANHubRoblox") Notify("YouTube", "Channel link copied!", "youtube") end
        }
    }
}

local function MakeProfile(data)
    local p = table.clone(BaseProfile)
    for k, v in pairs(data or {}) do p[k] = v end
    return p
end

local function SecureWipe()
    if not isfile or (not delfile) or (not readfile) or (not listfiles) then
        return
    end
    
    local currentTime = os.time()
    local isExpired = false

    if isfile(ExpiryFile) then
        local savedTime = tonumber(readfile(ExpiryFile)) or 0
        if currentTime > savedTime then
            isExpired = true
        end
    elseif isfolder and isfolder(FolderPath) then
        isExpired = true
    end

    if isExpired then
        if isfile(ExpiryFile) then
            delfile(ExpiryFile)
        end

        local possiblePaths = { FolderPath }
        local userId = tostring(LocalPlayer.UserId)
        
        for _, path in pairs(possiblePaths) do
            if isfolder and isfolder(path) then
                for _, file in pairs(listfiles(path)) do
                    if string.find(file, ".key") or string.find(file, ".json") or string.find(file, userId) then
                        pcall(function()
                            delfile(file)
                        end)
                    end
                end
            end
        end
        task.wait(0.5)
    end
end

SecureWipe()

pcall(function()
    if makefolder and isfolder then
        if not isfolder("ANUI") then makefolder("ANUI") end
        if not isfolder(FolderPath) then makefolder(FolderPath) end
    end
end)

local function LoadKeySystemData()
    local url = "https://raw.githubusercontent.com/AdityaNugrahaInside/ANHub/refs/heads/main/Key.txt"
    local success, response = pcall(function()
        return game:HttpGet(url)
    end)
    
    if success then
        for line in response:gmatch("[^\r\n]+") do
            local parts = string.split(line, ":")
            if #parts >= 2 then
                local useridInFile = string.gsub(parts[1], "%s+", "")
                local keyInFile = string.gsub(parts[2], "%s+", "")
                
                table.insert(ValidKeys, keyInFile)
                
                if useridInFile == tostring(LocalPlayer.UserId) then
                    IsPremium = true
                end
            end
        end
    end
end

LoadKeySystemData()
getgenv().IsPremium = IsPremium

UI = loadstring(game:HttpGet("https://raw.githubusercontent.com/ANHub-Script/ANUI/refs/heads/main/dist/main.lua?v=" .. math.random()))()

Window = UI:CreateWindow({
    Title = "AN Hub - Anime Spike",
    Icon = "rbxassetid://84366761557806",
    Author = "Aditya Nugraha",
    Folder = "AnimeSpike",
    Size = UDim2.fromOffset(580, 460),
    KeySystem = {
        Enabled = not IsPremium,
        Title = "ANHub Access",
        Description = "Free Key: ANHUB-2025",
        Key = ValidKeys,
        URL = "https://discord.gg/bUkCZvmrpH",
        Note = "Premium Users are auto-verified!",
        SaveKey = true
    }
})

task.delay(1.0, function() Window:CollapseSidebar() end)
task.delay(3.0, function() Window:ExpandSidebar() end)
Window:Tab({
    Profile = MakeProfile({ Title = "ANHub Script", Desc = "Anime Spike" }),
    SidebarProfile = true
})

local function IsWindowAlive()
    return Window and not Window.Destroyed
end

local function IsWindowOpen()
    return IsWindowAlive() and not Window.Closed
end

local _UIStateByObject = setmetatable({}, { __mode = "k" })
local _UIOpenEpoch = 0
local _UIOnOpenCallbacks = {}

local function _RegisterUIOnOpen(fn)
    if type(fn) ~= "function" then
        return
    end
    table.insert(_UIOnOpenCallbacks, fn)
end

Optimizer = Optimizer or {
    Cache = {
        RankUp = {},
        VaultGachas = { Entries = {}, Cursor = 1 },
        WeaponShop = {}
    }
}

function Optimizer.MarkUIStale()
    local c = Optimizer.Cache
    c.RankUp.LastRank = nil
    c.RankUp.LastCoins = nil
    c.RankUp.LastAscend = nil
    c.RankUp.NextCost = nil

    c.WeaponShop.LastWeaponShop = nil
    c.WeaponShop.LastCoins = nil
    c.WeaponShop.LastDiscount = nil
    c.WeaponShop.LastMainImageKey = nil
    c.WeaponShop.NextPrice = nil

    c.VaultGachas.Cursor = 1
    for _, e in ipairs(c.VaultGachas.Entries) do
        if type(e) == "table" then
            e.lastOwned = nil
            e.lastEquippedId = nil
            e.lastLockReason = nil
            e.lastDesc = nil
        end
    end
end

local function _GetUIState(ui)
    if not ui then
        return nil
    end
    local state = _UIStateByObject[ui]
    if not state then
        state = {}
        _UIStateByObject[ui] = state
    end
    return state
end

local function _ApplyUIState(ui)
    if not ui or not IsWindowOpen() then
        return
    end

    local state = _UIStateByObject[ui]
    if not state then
        return
    end

    if state.desiredTitle ~= nil and ui.SetTitle and (state.appliedTitle ~= state.desiredTitle or state.appliedTitleEpoch ~= _UIOpenEpoch) then
        pcall(function()
            ui:SetTitle(state.desiredTitle)
            state.appliedTitle = state.desiredTitle
            state.appliedTitleEpoch = _UIOpenEpoch
        end)
    end

    if state.desiredDesc ~= nil and ui.SetDesc and (state.appliedDesc ~= state.desiredDesc or state.appliedDescEpoch ~= _UIOpenEpoch) then
        pcall(function()
            ui:SetDesc(state.desiredDesc)
            state.appliedDesc = state.desiredDesc
            state.appliedDescEpoch = _UIOpenEpoch
        end)
    end

    local desiredImageKey = nil
    if state.desiredMainImageKey ~= nil then
        desiredImageKey = tostring(state.desiredMainImageKey) .. "|" .. tostring(state.desiredMainImageSize)
    elseif state.desiredMainImageVersion ~= nil then
        desiredImageKey = state.desiredMainImageVersion
    end

    if desiredImageKey ~= nil and ui.SetMainImage and (state.appliedMainImageKey ~= desiredImageKey or state.appliedMainImageEpoch ~= _UIOpenEpoch) then
        pcall(function()
            if state.desiredMainImageSize ~= nil then
                ui:SetMainImage(state.desiredMainImage, state.desiredMainImageSize)
            else
                ui:SetMainImage(state.desiredMainImage)
            end
            state.appliedMainImageKey = desiredImageKey
            state.appliedMainImageEpoch = _UIOpenEpoch
        end)
    end
end

local function _FlushAllUIStates()
    if not IsWindowOpen() then
        return
    end
    for ui, _ in pairs(_UIStateByObject) do
        _ApplyUIState(ui)
    end
end

do
    local function onOpen()
        _UIOpenEpoch = _UIOpenEpoch + 1
        pcall(function()
            if Optimizer and Optimizer.MarkUIStale then
                Optimizer.MarkUIStale()
            end
        end)
        for _, fn in ipairs(_UIOnOpenCallbacks) do
            pcall(fn)
        end
        task.defer(_FlushAllUIStates)
    end

    if type(Window) == "table" and Window.OnOpen and Window.OnClose then
        Window:OnOpen(onOpen)
    else
        task.spawn(function()
            local wasClosed = Window and Window.Closed == true
            while Window and not Window.Destroyed do
                local isClosed = Window.Closed == true
                if wasClosed and not isClosed then
                    onOpen()
                end
                wasClosed = isClosed
                task.wait(0.1)
            end
        end)
    end
end

do
    if IsPremium then
        Window:Tag({
            Title = "Premium User",
            Icon = "crown",
            Color = Color3.fromHex("#FFD700")
        })
        Notify("Welcome!", "Premium Access Verified. Enjoy!", "crown")
    else
        Window:Tag({
            Title = "Free User",
            Icon = "user",
            Color = Color3.fromHex("#FFFFFF")
        })
    end
end

pcall(function()
    if writefile and isfile and (not isfile(ExpiryFile)) then
        writefile(ExpiryFile, tostring(os.time() + 86400))
    end
end)

local FM_Categories = {}
local FM_CategoryDescriptions = {
    ["Farm"] = "Auto farm enemies and specific targets.",
    ["Rank Up"] = "Auto rank up and progression features.",
    ["Vault Gachas"] = "Remote gacha machines from anywhere.", -- Deskripsi baru
}
local function FM_GetElementFrame(elem)
    return rawget(elem, "ElementFrame") or (elem.UIElements and elem.UIElements.Main) or rawget(elem, "GroupFrame")
end

local function FM_UpdateTabProfile(selected)
    local desc = FM_CategoryDescriptions[selected] or ""
    local containers = {}
    if FarmTab and FarmTab.UIElements then
        table.insert(containers, FarmTab.UIElements.ContainerFrameCanvas)
        table.insert(containers, FarmTab.UIElements.ContainerFrame)
    end
    for _, cf in ipairs(containers) do
        if cf then
            local header = cf:FindFirstChild("ProfileHeader")
            if header then
                local tc = header:FindFirstChild("TextContainer")
                if tc then
                    for _, child in ipairs(tc:GetChildren()) do
                        if child:IsA("TextLabel") then
                            if child.LayoutOrder == 1 then child.Text = selected end
                            if child.LayoutOrder == 2 then child.Text = desc end
                        end
                    end
                end
            end
        end
    end
end

local function FM_Add(cat, elem)
    if not FM_Categories[cat] then FM_Categories[cat] = {} end
    table.insert(FM_Categories[cat], elem)
    local frame = FM_GetElementFrame(elem)
    if frame then frame.Visible = false end
    return elem
end

local function FM_OnChange(selected)
    for name, elems in pairs(FM_Categories) do
        local vis = (name == selected)
        for _, e in ipairs(elems) do
            local f = FM_GetElementFrame(e)
            if f then f.Visible = vis end
        end
    end
    pcall(function() FM_UpdateTabProfile(selected) end)
end

-- [[ FARM TAB ]] --
FarmTab = Window:Tab({
    Title = "Main Feature",
    Icon = "swords",
    Profile = MakeProfile({
        Avatar = GameIconURL,
        Title = "Main Feature",
        Desc = "Anime Spike"
    }),
    SidebarProfile = false
});

FM_CategorySelector = FarmTab:Category({
    Title = "Select Category",
    Default = "Farm",
    Options = {
        {Title = "Farm", Icon = "rbxassetid://89761068698333"},
        {Title = "Rank Up", Icon = "rbxassetid://74044855367151"},
        {Title = "Vault Gachas", Icon = "rbxassetid://89761068698333"},
        {Title = "Mini Game", Icon = "rbxassetid://109634928579023"},
        {Title = "Trial/Power Upgrade", Icon = "rbxassetid://79672544012982"},
        {Title = "Eggs", Icon = "rbxassetid://92349810618564"},
        {Title = "Weapon Shop", Icon = "rbxassetid://107655675881805"}
    },
    Callback = FM_OnChange
})


-- [[ FARM ELEMENTS ]] --
local EnemyDropdown = FM_Add("Farm", FarmTab:Dropdown({
    Title = "Select Enemy",
    Values = GetEnemiesList(),
    Multi = true,
    AllowNone = true,
    Flag = "EnemySelector_Config",
    Callback = function(val)
        Config.SelectedEnemies = {}
        if typeof(val) == "table" then for _, item in ipairs(val) do table.insert(Config.SelectedEnemies, item.RawName) end end
        currentTarget = nil
    end
}))

-- ==========================================
-- PERBAIKAN LOGIKA AUTO ATTACK ENEMIES
-- ==========================================
local lastMiniState = false -- Variabel pembantu untuk deteksi perpindahan mode

FM_Add("Farm", FarmTab:Toggle({
    Title = "Auto Attack Enemies",
    Default = false,
    Flag = "AutoAttack_Toggle",
    Callback = function(val)
        Config.AutoFarm = val
        if val then
            task.spawn(function()
                while Config.AutoFarm do
                    task.wait(0.3) -- Jeda sedikit dipercepat agar lebih responsif
                    if not IsWindowAlive() then break end
                    
                    local enemiesFolder = workspace:FindFirstChild("_enemies")
                    local firstEnemy = enemiesFolder and enemiesFolder:FindFirstChildOfClass("Model")
                    local isPowerArea = firstEnemy and firstEnemy:GetAttribute("_area") == -200
                    local inMini = IsInMinigame()
                    
                    -- RESET TARGET JIKA MODE BERUBAH (Dari Normal ke Mini atau sebaliknya)
                    if lastMiniState ~= inMini then
                        lastMiniState = inMini
                        currentTarget = nil -- Paksa cari target baru sesuai mode
                    end

                    if Config.AutoPowerArea and isPowerArea then
                        local char = LocalPlayer.Character
                        local myRoot = char and char:FindFirstChild("HumanoidRootPart")
                        local powerPos = Vector3.new(52255.9921875, 3.5937516689300537, 15767.1015625)

                        if myRoot then
                            local distToPower = (myRoot.Position - powerPos).Magnitude
                            if distToPower > 10 then
                                myRoot.CFrame = CFrame.new(powerPos)
                            end
                        end
                    elseif inMini or #Config.SelectedEnemies > 0 then
                        -- Cek apakah target saat ini masih valid sesuai mode (Mini/Normal)
                        local enemyArea = currentTarget and currentTarget:GetAttribute("_area")
                        local currentTargetIsMini = currentTarget and (currentTarget:GetAttribute("Minigame") or enemyArea == -200)
                        
                        local isValid = currentTarget 
                            and currentTarget.Parent 
                            and (currentTarget:GetAttribute("_h") and currentTarget:GetAttribute("_h") > 0)
                            -- Validasi tambahan: Target harus sesuai dengan mode minigame yang sedang aktif
                            and (inMini == currentTargetIsMini) 

                        if not isValid then
                            currentTarget = GetBestTarget()
                        end

                        if currentTarget and currentTarget:FindFirstChild("HumanoidRootPart") then
                            local char = LocalPlayer.Character
                            local myRoot = char and char:FindFirstChild("HumanoidRootPart")
                            if myRoot then
                                local distance = (myRoot.Position - currentTarget.HumanoidRootPart.Position).Magnitude
                                local offsetZ = inMini and 5 or 9
                                if distance > 10 then 
                                    myRoot.CFrame = currentTarget.HumanoidRootPart.CFrame * CFrame.new(0, 0, offsetZ)
                                end
                            end
                        end
                    else
                        currentTarget = nil
                    end
                end
            end)
        end
    end
}))
-- [[ PERBAIKAN LOGIKA AUTO ATTACK ]] --
local AutoFastAttackToggle
AutoFastAttackToggle = FM_Add("Farm", FarmTab:Toggle({
    Title = "Auto Fast Attack",
    Default = false,
    Flag = "AutoFastAttack_Toggle",
    Callback = function(val)
        if val and not IsPremium then
            Config.FastClick = false
            pcall(function()
                AutoFastAttackToggle:Unlock()
                AutoFastAttackToggle:Set(false, false, true)
                AutoFastAttackToggle:Lock("Premium Only")
            end)
            return
        end
        Config.FastClick = val
    end
}))
if not IsPremium then
    Config.FastClick = false
    pcall(function()
        AutoFastAttackToggle:Set(false, false, true)
        AutoFastAttackToggle:Lock("Premium Only")
    end)
end
OriginalDebounceCheck = Debounce.Check
-- [[ AUTO COLLECT TIME REWARDS ]] --
Config.AutoTimeRewards = false
task.spawn(function()
    while task.wait(1) do
        if not Window or Window.Destroyed then 
            Debounce.Check = function(player, action, duration)
                if action == "AntiAfkCounter" then
                    return true
                end
                return OriginalDebounceCheck(player, action, duration)
            end
            break
        end
        Debounce.Check = function(player, action, duration)
            if (action == "_combat" or action == "_click_client") and Config.FastClick then
                return false
            end
            if action == "AntiAfkCounter" then
                return true
            end
            return OriginalDebounceCheck(player, action, duration)
        end
    end
end)
local AutoTimeRewardsToggle
AutoTimeRewardsToggle = FM_Add("Farm", FarmTab:Toggle({
    Title = "Auto Collect Time Rewards",
    Desc = "Automatically claims playtime rewards when ready.",
    Default = false,
    Flag = "AutoTimeRewards_Toggle",
    Callback = function(val)
        if val and not IsPremium then
            Config.AutoTimeRewards = false
            pcall(function()
                AutoTimeRewardsToggle:Unlock()
                AutoTimeRewardsToggle:Set(false, false, true)
                AutoTimeRewardsToggle:Lock("Premium Only")
            end)
            return
        end
        Config.AutoTimeRewards = val
    end
}))
if not IsPremium then
    Config.AutoTimeRewards = false
    pcall(function()
        AutoTimeRewardsToggle:Set(false, false, true)
        AutoTimeRewardsToggle:Lock("Premium Only")
    end)
end

-- [[ TIME REWARDS AUTO-COLLECT LOGIC ]] --
task.spawn(function()
    local TimeRewardsIndex = NightXLibrary.get_index("_time_rewards")
    local TimeRewardsFolder = LocalPlayer:WaitForChild("TimeRewards")

    while task.wait(3) do -- Check every 5 seconds to save CPU
        if not Window or Window.Destroyed then break end
        
        if Config.AutoTimeRewards then
            local currentPlaytime = LocalPlayer:GetAttribute("RewardsTime") or 0
            
            -- Loop through the reward index (usually 1 to 12)
            for i = 1, #TimeRewardsIndex do
                local rewardData = TimeRewardsIndex[i]
                local rewardId = tostring(i)
                
                if rewardData then
                    local requiredTime = rewardData[1]
                    local isClaimed = TimeRewardsFolder:GetAttribute(rewardId)
                    
                    -- Check if time is reached and not already claimed
                    if currentPlaytime >= requiredTime and not isClaimed then
                        -- Send the exact remote signal used by the game
                        SendConnection("System", "_main", "_collect_reward", rewardId)
                        
                        Notify("Farm", "Collected Time Reward #" .. rewardId, "gift")
                        task.wait(0.5) -- Small delay between claims
                    end
                end
            end
        end
    end
end)
-- [[ ELEMEN UNTUK KATEGORI RANK UP ]] --

local RankUpToggle = FM_Add("Rank Up", FarmTab:Toggle({
    Title = "Auto Rank Up",
    Desc = "Mengecek persyaratan...",
    Default = false,
    Flag = "AutoRankUp_Toggle",
    Callback = function(val)
        Config.AutoRankUp = val
    end
}))

local _RankUpUIState = _GetUIState(RankUpToggle)

local function UpdateRankUpUI()
    if not IsWindowAlive() or not RankUpToggle then
        return
    end

    local currentRank = LocalPlayer:GetAttribute("Rank") or 0
    local currentCoins = LocalPlayer:GetAttribute("Coins") or 0

    local cache = Optimizer and Optimizer.Cache and Optimizer.Cache.RankUp
    if cache and cache.LastRank == currentRank and cache.LastCoins == currentCoins then
        if Config.AutoRankUp and cache.NextCost and currentCoins >= cache.NextCost then
            local now = os.clock()
            local lastAscend = cache.LastAscend or 0
            if (now - lastAscend) >= 1 then
                cache.LastAscend = now
                SendConnection("System", "_main", "_ascension")
                Notify("Rank Up!", "Berhasil naik ke Rank " .. (currentRank + 1), "arrow-up")
            end
        end
        if IsWindowOpen() then
            _ApplyUIState(RankUpToggle)
        end
        return
    end
    if cache then
        cache.LastRank = currentRank
        cache.LastCoins = currentCoins
    end

    local nextRankData = AscensionData[currentRank + 1]
    local currentRankData = AscensionData[currentRank]

    if nextRankData then
        local cost = nextRankData[1]
        if cache then
            cache.NextCost = cost
        end
        local progress = math.clamp(currentCoins / cost, 0, 1)

        local barLen = 15
        local filled = math.floor(progress * barLen)
        local bar = "[" .. string.rep("█", filled) .. string.rep("░", barLen - filled) .. "]"

        local titleTxt = string.format("Rank: %s | Bonus: +%s%%", currentRank, (currentRankData[2] - 1) * 100)
        local descTxt = string.format(
            "%s %s%%\nCoins: %s / %s",
            bar,
            math.floor(progress * 100),
            AbbreviateService:Comma(currentCoins),
            AbbreviateService:Comma(cost)
        )

        if _RankUpUIState then
            _RankUpUIState.desiredTitle = titleTxt
            _RankUpUIState.desiredDesc = descTxt
        end
        if IsWindowOpen() then
            _ApplyUIState(RankUpToggle)
        end

        if Config.AutoRankUp and currentCoins >= cost then
            local now = os.clock()
            local lastAscend = cache and cache.LastAscend or 0
            if (now - lastAscend) >= 1 then
                if cache then
                    cache.LastAscend = now
                end
                SendConnection("System", "_main", "_ascension")
                Notify("Rank Up!", "Berhasil naik ke Rank " .. (currentRank + 1), "arrow-up")
            end
        end
    else
        if cache then
            cache.NextCost = nil
        end
        if _RankUpUIState then
            _RankUpUIState.desiredTitle = "Rank: MAX"
            _RankUpUIState.desiredDesc = "Kamu telah mencapai Rank tertinggi!"
        end
        if IsWindowOpen() then
            _ApplyUIState(RankUpToggle)
        end
    end
end

LocalPlayer.AttributeChanged:Connect(function(attr)
    if attr == "Rank" or attr == "Coins" then
        UpdateRankUpUI()
    end
end)

_RegisterUIOnOpen(UpdateRankUpUI)
task.delay(1, UpdateRankUpUI)

task.spawn(function()
    while Window and not Window.Destroyed do
        if Config.AutoRankUp then
            UpdateRankUpUI()
            task.wait(0.25)
        else
            task.wait(0.6)
        end
    end
end)

-- [[ ELEMEN UNTUK KATEGORI VAULT GACHAS ]] --

local ActiveGachaToggles = {}
-- [[ ELEMEN UNTUK KATEGORI VAULT GACHAS (GROUP VERSION) ]] --

-- 1. Kumpulkan data agar bisa diurutkan (Pairs acak, jadi perlu tabel biasa)
local SortedGachas = {}
for gachaId, gachaData in pairs(VaultGachasIndex) do
    table.insert(SortedGachas, {ID = gachaId, Data = gachaData})
end

-- 2. Urutkan berdasarkan ID (Nama) agar posisi item stabil
table.sort(SortedGachas, function(a, b) return a.ID < b.ID end)

local function UpdateVaultGachaEntry(entry, isOpen)
    if not entry or not entry.toggle then
        return
    end

    if isOpen == nil then
        isOpen = IsWindowOpen()
    end

    local function applyVisuals()
        if not isOpen then
            return
        end

        if entry.appliedLockEpoch ~= _UIOpenEpoch or entry.appliedLockReason ~= entry.desiredLockReason then
            entry.appliedLockEpoch = _UIOpenEpoch
            entry.appliedLockReason = entry.desiredLockReason
            pcall(function()
                if entry.desiredLockReason then
                    entry.toggle:Lock(entry.desiredLockReason)
                    entry.toggle:Set(false)
                    entry.pendingOff = false
                else
                    entry.toggle:Unlock()
                end
            end)
        end

        if entry.pendingOff then
            pcall(function()
                entry.toggle:Set(false)
            end)
            entry.pendingOff = false
        end

        _ApplyUIState(entry.toggle)
    end

    if not entry.vaultFolder then
        local mainFolder = LocalPlayer:FindFirstChild("VaultGachas")
        if mainFolder then
            entry.vaultFolder = mainFolder:FindFirstChild(entry.gachaId)
        end
    end

    local invItem = LocalPlayer.Inventory.Items:FindFirstChild(entry.costId)
    local owned = invItem and invItem:GetAttribute("Amount") or 0
    local equippedId = entry.vaultFolder and entry.vaultFolder:GetAttribute("Name") or ""
    local equippedNum = tonumber(equippedId) or -1
    local lockReason = (not IsPremium) and "Premium Only" or ((equippedNum == 1) and "Secret Equipped!" or nil)
    entry.desiredLockReason = lockReason

    if owned == entry.lastOwned and equippedId == entry.lastEquippedId and lockReason == entry.lastLockReason then
        applyVisuals()
        return
    end

    entry.lastOwned = owned
    entry.lastEquippedId = equippedId
    entry.lastLockReason = lockReason

    if lockReason then
        if Config["AutoGacha_" .. entry.gachaId] then
            Config["AutoGacha_" .. entry.gachaId] = false
            entry.pendingOff = true
        end
    end

    local equippedData = entry.gachaData[equippedNum]
    local price = 1

    local colorCode = (owned >= price) and "#00FF00" or "#FF0000"
    local materialStatus = string.format("<font color=\"%s\">%s: %s/%s</font>", colorCode, entry.costName, AbbreviateService:Comma(owned), price)

    local currentDesc = ""
    if equippedData and equippedId ~= "" then
        currentDesc = string.format("Equipped: %s (%s%%)\n%s\nStats:", equippedData[2], equippedData[1], materialStatus)
        for stat, val in pairs(equippedData.Mults or {}) do
            currentDesc = currentDesc .. string.format("\n• %s: +%s%%", stat, val * 100)
        end
    else
        currentDesc = "Empty\n" .. materialStatus
    end

    if currentDesc ~= entry.lastDesc then
        entry.lastDesc = currentDesc
        if entry.uiState then
            entry.uiState.desiredDesc = currentDesc
        end
    end

    if equippedId ~= entry.lastEquippedIdForImage then
        entry.lastEquippedIdForImage = equippedId
        if equippedData and equippedId ~= "" and entry.uiState then
            local rarityName = equippedData[2]
            local gradientObj = GradientFolder:FindFirstChild(rarityName)
            entry.uiState.desiredMainImage = {
                Image = equippedData.Image or "rbxassetid://0",
                Gradient = gradientObj and gradientObj.Color or nil,
                Quantity = equippedData[1] .. "%",
                Title = rarityName
            }
            entry.uiState.desiredMainImageSize = 50
            entry.uiState.desiredMainImageKey = tostring(equippedId)
        end
    end

    applyVisuals()
end

task.spawn(function()
    while Window and not Window.Destroyed do
        local isOpen = IsWindowOpen()
        local entries = Optimizer and Optimizer.Cache and Optimizer.Cache.VaultGachas and Optimizer.Cache.VaultGachas.Entries
        if not entries or #entries == 0 then
            task.wait(0.5)
            continue
        end

        local n = #entries
        local cursor = Optimizer.Cache.VaultGachas.Cursor or 1
        if cursor < 1 or cursor > n then
            cursor = 1
        end

        local perTick = isOpen and math.clamp(math.floor(n / 10) + 1, 1, 6) or math.clamp(math.floor(n / 20) + 1, 1, 3)
        for _ = 1, perTick do
            local entry = entries[cursor]
            cursor = cursor + 1
            if cursor > n then
                cursor = 1
            end
            pcall(function()
                UpdateVaultGachaEntry(entry, isOpen)
            end)
        end
        Optimizer.Cache.VaultGachas.Cursor = cursor

        task.wait(isOpen and 0.15 or 0.25)
    end
end)

_RegisterUIOnOpen(function()
    local entries = Optimizer and Optimizer.Cache and Optimizer.Cache.VaultGachas and Optimizer.Cache.VaultGachas.Entries
    if not entries or #entries == 0 then
        return
    end
    Optimizer.Cache.VaultGachas.Cursor = 1
    task.defer(function()
        local isOpen = IsWindowOpen()
        for i, e in ipairs(entries) do
            UpdateVaultGachaEntry(e, isOpen)
            if i % 4 == 0 then
                task.wait()
            end
        end
    end)
end)

-- 3. Fungsi Pembuat Toggle (Agar codingan lebih bersih & bisa dipanggil di loop)
local function CreateGachaToggle(ParentGroup, gachaId, gachaData)
    local cleanName = gachaId:gsub("^_", ""):gsub("_", " ")
    cleanName = cleanName:sub(1,1):upper() .. cleanName:sub(2)

    local costId = gachaData.Cost
    local costItem = ItemsIndex[costId]
    local costName = costItem and costItem[1][1] or "Unknown"

    -- Buat Toggle DI DALAM Group
    local GachaToggle = ParentGroup:Toggle({
        Title = cleanName, -- Judul dipendekkan agar muat di grid
        Default = false,
        Image = gachaData[1] and gachaData[1].Image or "rbxassetid://0", 
        Flag = "AutoGacha_" .. gachaId,
        Callback = function(val)
            if val and not IsPremium then
                Config["AutoGacha_" .. gachaId] = false
                pcall(function()
                    GachaToggle:Unlock()
                    GachaToggle:Set(false, false, true)
                    GachaToggle:Lock("Premium Only")
                end)
                return
            end
            Config["AutoGacha_" .. gachaId] = val
            if val then
                task.spawn(function()
                    while Config["AutoGacha_" .. gachaId] do
                        if not Window or Window.Destroyed then break end
                        local invItem = LocalPlayer.Inventory.Items:FindFirstChild(costId)
                        local owned = invItem and invItem:GetAttribute("Amount") or 0
                        if owned >= 1 then
                            SendConnection("System", "_main", "_gachas", gachaId, 1)
                        end
                        task.wait(3)
                    end
                end)
            end
        end
    })
    if not IsPremium then
        Config["AutoGacha_" .. gachaId] = false
        pcall(function()
            GachaToggle:Set(false, false, true)
            GachaToggle:Lock("Premium Only")
        end)
    end

    local _GachaUIState = _GetUIState(GachaToggle)
    if _GachaUIState then
        _GachaUIState.desiredTitle = cleanName
    end

    local entry = {
        gachaId = gachaId,
        gachaData = gachaData,
        costId = costId,
        costName = costName,
        toggle = GachaToggle,
        uiState = _GachaUIState,
        vaultFolder = LocalPlayer:WaitForChild("VaultGachas", 5):FindFirstChild(gachaId),
        lastOwned = nil,
        lastEquippedId = nil,
        lastEquippedIdForImage = nil,
        lastLockReason = nil,
        lastDesc = nil
    }
    table.insert(Optimizer.Cache.VaultGachas.Entries, entry)

    ActiveGachaToggles[gachaId] = GachaToggle
end

-- 4. Loop Utama: Pasang Group setiap 2 Item
for i = 1, #SortedGachas, 2 do
    local item1 = SortedGachas[i]
    local item2 = SortedGachas[i+1] -- Bisa nil jika jumlah gacha ganjil

    -- Buat Group Container & Daftarkan ke sistem Kategori
    local Group = FM_Add("Vault Gachas", FarmTab:Group({}))

    -- Pasang Toggle Item 1
    CreateGachaToggle(Group, item1.ID, item1.Data)

    -- Pasang Toggle Item 2 (Jika ada)
    if item2 then
        CreateGachaToggle(Group, item2.ID, item2.Data)
    end
end
-- [[ MINI GAME CATEGORY ELEMENTS ]] --

-- [[ MINI GAME CATEGORY - UPDATED WITH DECOMPILE LOGIC ]] --

-- Control variables
-- [[ MINI GAME & AUTO LEAVE ]] --
Config.TargetWave = 10; Config.LastIsland = "_hub"
FM_Add("Mini Game", FarmTab:Toggle({ Title = "Auto Enter Trial Easy", Default = false, Flag = "AutoTrialEasy_Toggle", Callback = function(val) Config.AutoTrialEasy = val end }))
FM_Add("Mini Game", FarmTab:Toggle({ Title = "Auto Leave Trial", Default = false, Flag = "AutoLeaveWave_Toggle", Callback = function(val) Config.AutoLeaveWave = val end }))

-- TOGGLE BARU: Auto 2x Power Area
local AutoPowerAreaToggle
AutoPowerAreaToggle = FM_Add("Mini Game", FarmTab:Toggle({ 
    Title = "Auto 2x Power Area", 
    Desc = "Teleports to Training Area when area is Dbz Defense.",
    Default = false, 
    Flag = "AutoPowerArea_Toggle",
    Callback = function(val) 
        if val and not IsPremium then
            Config.AutoPowerArea = false
            pcall(function()
                AutoPowerAreaToggle:Unlock()
                AutoPowerAreaToggle:Set(false, false, true)
                AutoPowerAreaToggle:Lock("Premium Only")
            end)
            return
        end
        Config.AutoPowerArea = val 
    end 
}))
if not IsPremium then
    Config.AutoPowerArea = false
    pcall(function()
        AutoPowerAreaToggle:Set(false, false, true)
        AutoPowerAreaToggle:Lock("Premium Only")
    end)
end

FM_Add("Mini Game", FarmTab:Input({ Title = "Target Wave to Leave", Placeholder = "10", Flag = "TargetWave_Input", Callback = function(val) Config.TargetWave = tonumber(val) or 10 end }))

-- [[ SCHEDULER & LOCATION RECORDING LOGIC ]] --
task.spawn(function()
    while task.wait(1) do
        if not Window or Window.Destroyed then break end
        
        if Config.AutoTrialEasy then
            local currentTime = os.date("*t")
            local minute = currentTime.min
            
            -- Check for minute 00 or 30
            if (minute == 0 or minute == 30) and minute ~= lastTrialMinute then
                lastTrialMinute = minute
                
                -- RECORD CURRENT LOCATION BEFORE TELEPORT
                local currentAreaId = LocalPlayer:GetAttribute("Island")
                for id, info in pairs(IslandsIndex) do
                    -- Match Area ID with Island Index
                    if info[3] == currentAreaId and id ~= "_trial_easy" and id ~= "_hub" then
                        Config.LastIsland = id
                        break
                    end
                end

                pcall(function()
                    -- Teleport to Trial Easy Area
                    SendConnection("System", "_main", "_teleport", "_trial_easy")
                    Notify("Mini Game", "Entering Trial Easy. Return location saved: " .. Config.LastIsland, "info")
                end)
                
                task.wait(60) -- Prevent multiple teleports in the same minute
            end
        end
    end
end)

-- [[ UPDATED AUTO LEAVE LOGIC (STRING BASED) ]] --
Connection:receive("_update_minigame", function(data)
    if not Window or Window.Destroyed then return end
    
    -- Ambil data sesuai info debug kamu
    local mainInfo = data[1]       -- Nama Musuh
    local modeString = data[2]     -- Format: "Wave 3 / 20"
    local waveInfo = data[3] and data[3][1]
    local progressRatio = data[3] and data[3][2] or 0

    -- LOGIKA EXTRAKSI WAVE DARI STRING "Wave X / Y"
    -- Kita mencari angka setelah kata "Wave"
    local currentWave = tonumber(string.match(modeString, "Wave%s+(%d+)"))
    
    if currentWave then
        
        -- [[ LOGIKA AUTO LEAVE ]] --
        if Config.AutoLeaveWave and currentWave >= tonumber(Config.TargetWave or 10) then
            local IslandService = NightXLibrary.get_service("island_service")
            
            pcall(function()
                -- TELEPORT BALIK KE PULAU TERAKHIR (LOBBY)
                SendConnection("System", "_main", "_teleport", Config.LastIsland or "_hub", "Lobby")                
                -- Kirim Notifikasi
                Notify("Auto Leave", "Reached Wave " .. currentWave .. "! Returning to " .. (Config.LastIsland or "Hub"), "log-out")
                
                -- Matikan toggle agar tidak spam teleport saat loading
                Config.AutoLeaveWave = false 
            end)
        end
    end
end)

-- [[ UPDATED EGGS CATEGORY ]] --

-- 1. Egg Selection Dropdown
local EggList = {
    {Title = "Ninja Village Egg (50)", Value = 1},
    {Title = "Tokyo City Egg (250M)", Value = 2},
    {Title = "XYZ Province Egg (5T)", Value = 3},
    {Title = "Dragon Island Egg (500Q)", Value = 4}
}

FM_Add("Eggs", FarmTab:Dropdown({
    Title = "Select Egg",
    Desc = "Choose which egg you want to hatch.",
    Values = EggList,
    Flag = "SelectedEgg_Dropdown",
    Callback = function(val)
        Config.SelectedEgg = val.Value
    end
}))

-- 3. Auto Hatch Toggle
FM_Add("Eggs", FarmTab:Toggle({
    Title = "Auto Hatch Eggs",
    Desc = "Uses Manual Hatch logic with no delay.",
    Default = false,
    Flag = "AutoHatch_Toggle",
    Callback = function(val)
        Config.AutoHatch = val
        local EggService = require(ReplicatedStorage.frame_work.library._services.animations_service.egg)
        if val then
            if not getgenv().OriginalEggAnimation then
                getgenv().OriginalEggAnimation = EggService._s
            end
            EggService._s = function() end --
        else
            if getgenv().OriginalEggAnimation then
                EggService._s = getgenv().OriginalEggAnimation
            end
        end
    end
}))

-- [[ MANUAL-STYLE AUTO HATCH LOGIC ]] --
task.spawn(function()
    while true do
        task.wait(1)
        if not Window or Window.Destroyed then break end
        
        if Config.AutoHatch then
            local charPos = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
            if not charPos then continue end

            -- Logic from _open_upvr: Check all eggs in workspace
            for _, eggModel in pairs(workspace._interacts._eggs:GetChildren()) do
                -- Check if this is the egg we selected in the UI
                if tonumber(eggModel.Name) == Config.SelectedEgg then
                    -- Magnitude check (Distance <= 10)
                    local dist = (eggModel.M.Position - charPos.Position).Magnitude
                    if dist <= 10 then
                        -- Send exact remote: "System", "_egg", "_open"
                        SendConnection("System", "_egg", "_open", Config.SelectedEgg)
                        task.wait(3)
                    end
                end
            end
        end
    end
end)

-- [[ WEAPON SHOP CATEGORY ]] --

-- Simpan toggle ke variabel lokal agar bisa diakses fungsi update
local WeaponInfoToggle = FM_Add("Weapon Shop", FarmTab:Toggle({
    Title = "Auto Buy Next Weapon",
    Desc = "Checking progress...",
    Default = false,
    Flag = "AutoWeapon_Toggle",
    Callback = function(val)
        Config.AutoWeaponShop = val
    end
}))

-- Fungsi Update yang dipanggil hanya saat diperlukan
local function SafeUpdateWeaponUI()
    -- Pastikan Window masih ada dan Toggle tidak nil
    if not IsWindowAlive() or not WeaponInfoToggle then return end

    local success, err = pcall(function()
        local currentWeaponShop = LocalPlayer:GetAttribute("WeaponShop") or 0
        local nextId = currentWeaponShop + 1
        local weaponData = WeaponsIndex[nextId]
        
        if weaponData then
            local discount = (MultsIndex and MultsIndex._discount) and MultsIndex._discount(LocalPlayer) or 1
            local finalPrice = (weaponData[4] or 0) / discount
            local currentCoins = LocalPlayer:GetAttribute("Coins") or 0
            
            -- Penyiapan Data Visual
            local weaponName = tostring(weaponData[1])
            local powerMult = tostring(AbbreviateService:Comma(weaponData[3]))
            local weaponImage = weaponData._image or weaponData.Image or "rbxassetid://0" -- Mengambil ID Gambar
            
            local displayTitle = "Next: " .. weaponName .. " (+" .. powerMult .. "x)"
            local displayDesc = string.format("Price: %s\nCoins: %s", tostring(AbbreviateService:Comma(finalPrice)), tostring(AbbreviateService:Comma(currentCoins)))
            
            -- Eksekusi aman di dalam thread UI
            task.defer(function()
                pcall(function()
                    WeaponInfoToggle:SetTitle(displayTitle)
                    WeaponInfoToggle:SetDesc(displayDesc)
                    WeaponInfoToggle:Unlock()
                end)
            end)

            -- Logika Auto Buy
            if Config.AutoWeaponShop and currentCoins >= finalPrice then
                SendConnection("System", "_main", "_weapon", "", "_all")
            end
        else
            -- Jika sudah mencapai level maksimal
            task.defer(function()
                WeaponInfoToggle:SetTitle("Weapon Shop: MAX")
                WeaponInfoToggle:SetDesc("All weapons unlocked.")
                WeaponInfoToggle:Lock("All weapons unlocked.")
                WeaponInfoToggle:Set(false)
            end)
        end
    end)
end

-- Hubungkan ke Event: Update hanya jika Coin atau Rank Toko berubah
LocalPlayer.AttributeChanged:Connect(function(attr)
    if attr == "Coins" or attr == "WeaponShop" then
        SafeUpdateWeaponUI()
    end
end)

-- Panggil sekali saat awal untuk inisialisasi teks dan gambar
task.delay(2, SafeUpdateWeaponUI)
-- [[ TRIAL & POWER UPGRADE CATEGORY - INTEGRATED LOGIC ]] --
local TrialUpgradeEntries = {}
local PowerUpgradeToggle = nil
local _PowerUpgradeUIState = nil
local PowerUpgradeIndex = NightXLibrary.get_index("_power_upgrades")

-- 1. Helper: Mendapatkan jumlah Dragon Shard
local function GetDragonShards()
    local inv = LocalPlayer:FindFirstChild("Inventory")
    local items = inv and inv:FindFirstChild("Items")
    local shard = items and items:FindFirstChild("_dbz_shard")
    return shard and shard:GetAttribute("Amount") or 0
end

-- 2. Helper: Mendapatkan jumlah Trial Upgrader
local function GetTrialCurrency()
    local inv = LocalPlayer:FindFirstChild("Inventory")
    local items = inv and inv:FindFirstChild("Items")
    local token = items and items:FindFirstChild("_trial_upgrader")
    return token and token:GetAttribute("Amount") or 0
end

-- 3. Fungsi Update untuk Power Upgrade (Dragon Shard)
local function UpdatePowerUpgradeUI()
    if not IsWindowAlive() or not PowerUpgradeToggle then return end
    
    local currentLevel = LocalPlayer:GetAttribute("PowerUpgrade") or 0
    local shardsOwned = GetDragonShards()
    local maxLevel = #PowerUpgradeIndex
    
    local nextData = PowerUpgradeIndex[currentLevel + 1]
    local currentData = PowerUpgradeIndex[currentLevel]
    
    local bonusTxt = "0%"
    if currentData then
        bonusTxt = ((currentData[2] - 1) * 100) .. "%"
    end
    
    local cost = nextData and nextData[1] or 0
    local isMax = currentLevel >= maxLevel
    
    -- Logika Warna Rich Text
    local colorCode = (shardsOwned >= cost) and "#00FF00" or "#FF0000"
    local costDisplay = isMax and "MAX" or AbbreviateService:Comma(cost)
    local statusDesc = string.format("Level: %d/%d | Bonus: +%s\n<font color=\"%s\">Dragon Shards: %s/%s</font>", 
        currentLevel, maxLevel, bonusTxt, colorCode, AbbreviateService:Comma(shardsOwned), costDisplay)

    pcall(function()
        PowerUpgradeToggle:SetTitle(isMax and "Power Upgrade [MAX]" or "Power Upgrade")
        PowerUpgradeToggle:SetDesc(statusDesc)
        if not IsPremium then
            PowerUpgradeToggle:Lock("Premium Only")
            PowerUpgradeToggle:Set(false)
        else
            PowerUpgradeToggle:Unlock()
        end
    end)

    -- Logika Auto Upgrade Power
    if IsPremium and Config.AutoPowerUpgrade and not isMax and shardsOwned >= cost then
        SendConnection("System", "_main", "_power_upgrades")
    end
end

-- 4. Fungsi Update untuk Trial Upgrades (Trial Token)
local function UpdateTrialUpgradeUI()
    if not IsWindowAlive() then return end
    local folder = LocalPlayer:FindFirstChild("TrialUpgrades")
    local currency = GetTrialCurrency()

    for _, entry in ipairs(TrialUpgradeEntries) do
        local level = (folder and folder:GetAttribute(entry.Name)) or 1
        local bonusBase = (entry.Name == "Luck" and 1) or (table.find({"Power","CritChance","CritDmg"}, entry.Name) and 10) or (entry.Name == "Coins" and 2.5) or 5
        
        local cost = 5 * level 
        local bonusTotal = bonusBase * (level - 1)
        local isMax = level >= 11

        local colorCode = (currency >= cost) and "#00FF00" or "#FF0000"
        local materialStatus = string.format("<font color=\"%s\">Trial Upgrader: %s/%s</font>", 
            colorCode, AbbreviateService:Comma(currency), isMax and "MAX" or AbbreviateService:Comma(cost))

        pcall(function()
            entry.toggle:SetTitle(isMax and entry.Name .. " [MAX]" or entry.Name)
            entry.toggle:SetDesc(string.format("Level: %d/11 | Bonus: +%.1f%%\n%s", level, bonusTotal, materialStatus))
            if not IsPremium then
                entry.toggle:Lock("Premium Only")
                entry.toggle:Set(false)
            else
                entry.toggle:Unlock()
            end
        end)

        if IsPremium and Config["AutoTrial_" .. entry.Name] and not isMax and currency >= cost then
            SendConnection("System", "_main", "_trial_upgrades", entry.Name)
        end
    end
end

-- 5. Pembuatan UI
-- Group 1: Power Upgrade Utama (Dragon Shard)
local MainPowerGroup = FM_Add("Trial/Power Upgrade", FarmTab:Group({ Title = "Dragon Shard Upgrades" }))
PowerUpgradeToggle = MainPowerGroup:Toggle({
    Title = "Power Upgrade",
    Desc = "Loading data...",
    Default = false,
    Flag = "AutoPowerUpgrade_Toggle",
    Callback = function(val)
        if val and not IsPremium then
            Config.AutoPowerUpgrade = false
            pcall(function()
                PowerUpgradeToggle:Unlock()
                PowerUpgradeToggle:Set(false, false, true)
                PowerUpgradeToggle:Lock("Premium Only")
            end)
            return
        end
        Config.AutoPowerUpgrade = val
    end
})
if not IsPremium then
    Config.AutoPowerUpgrade = false
    pcall(function()
        PowerUpgradeToggle:Set(false, false, true)
        PowerUpgradeToggle:Lock("Premium Only")
    end)
end

-- Group 2+: Trial Upgrades (Grup isi 2)
local TrialStats = {"Power", "Luck", "CritChance", "CritDmg", "Coins"}
for i = 1, #TrialStats, 2 do
    local Group = FM_Add("Trial/Power Upgrade", FarmTab:Group({ Title = "Trial Upgrades " .. math.ceil(i/2) }))
    for j = i, math.min(i + 1, #TrialStats) do
        local stat = TrialStats[j]
        local toggle = Group:Toggle({
            Title = stat,
            Desc = "Waiting...",
            Default = false,
            Flag = "AutoTrial_" .. stat,
            Callback = function(val)
                if val and not IsPremium then
                    Config["AutoTrial_" .. stat] = false
                    pcall(function()
                        toggle:Unlock()
                        toggle:Set(false, false, true)
                        toggle:Lock("Premium Only")
                    end)
                    return
                end
                Config["AutoTrial_" .. stat] = val
            end
        })
        if not IsPremium then
            Config["AutoTrial_" .. stat] = false
            pcall(function()
                toggle:Set(false, false, true)
                toggle:Lock("Premium Only")
            end)
        end
        table.insert(TrialUpgradeEntries, { Name = stat, toggle = toggle })
    end
end

-- 6. Loop Update & Listener
task.spawn(function()
    -- Listener untuk Power Upgrade
    LocalPlayer:GetAttributeChangedSignal("PowerUpgrade"):Connect(UpdatePowerUpgradeUI)
    
    -- Listener untuk Trial Upgrades
    local trialFolder = LocalPlayer:WaitForChild("TrialUpgrades", 10)
    if trialFolder then
        for _, stat in ipairs(TrialStats) do
            trialFolder:GetAttributeChangedSignal(stat):Connect(UpdateTrialUpgradeUI)
        end
    end

    while task.wait(1) do
        if not IsWindowAlive() then break end
        UpdatePowerUpgradeUI()
        UpdateTrialUpgradeUI()
    end
end)
-- PERBAIKAN JARAK: Mengatur posisi Category Frame dan Container
if FM_CategorySelector.ElementFrame then 
    FM_CategorySelector.ElementFrame.Parent = FarmTab.UIElements.ContainerFrameCanvas 
    FM_CategorySelector.ElementFrame.Position = UDim2.new(0, 0, 0, FarmTab.UIElements.ContainerFrame.Position.Y.Offset)
    
    local catSize = FM_CategorySelector.ElementFrame.Size.Y.Offset
    FarmTab.UIElements.ContainerFrame.Position = UDim2.new(0, 0, 0, FarmTab.UIElements.ContainerFrame.Position.Y.Offset + catSize)
    FarmTab.UIElements.ContainerFrame.Size = UDim2.new(1, 0, 1, FarmTab.UIElements.ContainerFrame.Size.Y.Offset - catSize)
    
    local pad = FarmTab.UIElements.ContainerFrame:FindFirstChildOfClass("UIPadding")
    if pad then pad.PaddingTop = UDim.new(0, 5) end
end

-- [[ Settings Tab ]] --
SettingsTab = Window:Tab({ Title = "Settings", Icon = "settings-2" });
SettingsTab:Section({ Title = "Config Manager", Icon = "save", Opened = true });
SettingsTab:Input({
    Title = "Config Name",
    Placeholder = "ANHub",
    Flag = "ConfigName_Input",
    Callback = function(txt)
        ConfigName = (txt and txt ~= "" and txt) or "ANHub"
    end
})
SettingsTab:Button({
    Title = "Save Config",
    Icon = "save",
    Callback = function()
        if Window.ConfigManager then
            pcall(function()
                local cfg = Window.ConfigManager:GetConfig(ConfigName) or Window.ConfigManager:CreateConfig(ConfigName)
                cfg:Save()
            end)
        end
        if Config.SelectedEnemy then
            SaveMapConfig(GetCurrentMapName(), Config.SelectedEnemy)
        end
        Notify("Success", "Saved!", "check")
    end
})
SettingsTab:Button({
    Title = "Load Config",
    Icon = "upload",
    Callback = function()
        if Window.ConfigManager then
            local ok = pcall(function()
                local cfg = Window.ConfigManager:GetConfig(ConfigName) or Window.ConfigManager:CreateConfig(ConfigName)
                IsLoadingConfig = true
                cfg:Load()
            end)
            IsLoadingConfig = false
        end
        LoadMapDB()
        ApplySavedEnemyForMap(GetCurrentMapName(), CurrentMapEnemiesCache)
        Notify("Success", "Loaded!", "check")
    end
})
SettingsTab:Button({
    Title = "Delete Config",
    Icon = "trash",
    Callback = function()
        if Window.ConfigManager then
            pcall(function()
                Window.ConfigManager:DeleteConfig(ConfigName)
            end)
        end
        Notify("Success", "Deleted!", "trash")
    end
})
SettingsTab:Button({
    Title = "Rejoin Server",
    Icon = "rotate-cw",
    Callback = function()
        local TeleportService = game:GetService("TeleportService")
        local Players = game:GetService("Players")
        local LocalPlayer = Players.LocalPlayer

        -- Melakukan teleportasi ulang ke PlaceId yang sama
        if #Players:GetPlayers() <= 1 then
            TeleportService:Teleport(game.PlaceId, LocalPlayer)
        else
            TeleportService:TeleportToPlaceInstance(game.PlaceId, game.JobId, LocalPlayer)
        end
    end
})
-- [[ PERFORMANCE / FPS BOOST SECTION ]] --
SettingsTab:Section({ Title = "Performance & FPS Boost", Icon = "zap", Opened = false });

local function ApplyFPSBoost()
    local Lighting = game:GetService("Lighting")
    local Terrain = workspace:FindFirstChildOfClass("Terrain")
    
    -- Lighting & Effects
    Lighting.GlobalShadows = false
    Lighting.FogEnd = 9e9
    Lighting.Brightness = 1
    
    for _, v in pairs(Lighting:GetDescendants()) do
        if v:IsA("PostEffect") or v:IsA("BloomEffect") or v:IsA("BlurEffect") or v:IsA("DepthOfFieldEffect") or v:IsA("SunRaysEffect") then
            v.Enabled = false
        end
    end

    -- Terrain
    if Terrain then
        Terrain.WaterSpikeize = 0
        Terrain.WaterSpikepeed = 0
        Terrain.WaterReflectance = 0
        Terrain.WaterTransparency = 0
    end

    -- Workspace Objects
    for _, v in pairs(game:GetDescendants()) do
        if v:IsA("Part") or v:IsA("MeshPart") or v:IsA("UnionOperation") then
            v.Material = Enum.Material.SmoothPlastic
            v.Reflectance = 0
        elseif v:IsA("Decal") or v:IsA("Texture") then
            v.Transparency = 1
        elseif v:IsA("ParticleEmitter") or v:IsA("Trail") then
            v.Enabled = false
        elseif v:IsA("Explosion") then
            v.Visible = false
        end
    end
    
    Notify("FPS Boost", "Performance settings applied!", "zap")
end

SettingsTab:Toggle({
    Title = "High Performance Mode",
    Desc = "Menghapus tekstur, bayangan, dan efek untuk menaikkan FPS.",
    Default = false,
    Callback = function(val)
        if val then
            ApplyFPSBoost()
        else
            Notify("Info", "Rejoin server untuk mengembalikan grafik normal.", "info")
        end
    end
})

SettingsTab:Button({
    Title = "Clean Workspace (Lag Fix)",
    Icon = "trash-2",
    Desc = "Menghapus sampah visual di workspace.",
    Callback = function()
        for _, v in pairs(workspace:GetChildren()) do
            if v:IsA("BasePart") and v.Transparency == 1 and not v:IsA("Terrain") then
                -- v:Destroy() -- Hati-hati dengan ini, bisa menghapus part penting
            end
        end
        Notify("Cleaned", "Workspace items optimized.", "check")
    end
})
-- [[ ADVANCED SMOOTHNESS FUNCTIONS ]] --
local function Toggle3DRendering(state)
    -- Benar-benar mematikan render dunia (layar jadi abu-abu/putih)
    -- Ini adalah cara paling efektif untuk menghemat baterai/listrik saat AFK
    game:GetService("RunService"):Set3dRenderingEnabled(not state)
end

local function MuteAllSounds()
    for _, v in pairs(game:GetDescendants()) do
        if v:IsA("Sound") then
            v.Volume = 0
        end
    end
end

local function BoostCPU()
    -- Mengatur kualitas render internal Roblox ke level terendah
    settings().Rendering.QualityLevel = Enum.QualityLevel.Level01
    settings().Rendering.MeshPartDetailLevel = Enum.MeshPartDetailLevel.Low
end
-- Toggle untuk mematikan Rendering 3D
SettingsTab:Toggle({
    Title = "CPU Mode (White Screen)",
    Desc = "Mematikan render 3D. Sangat cocok untuk AFK semalaman (Hemat GPU).",
    Default = false,
    Callback = function(val)
        Toggle3DRendering(val)
        if val then
            Notify("CPU Mode", "3D Rendering Disabled for performance.", "monitor-off")
        else
            Notify("CPU Mode", "3D Rendering Enabled.", "monitor")
        end
    end
})

-- Toggle untuk Mute Suara (Mengurangi beban CPU audio)
SettingsTab:Toggle({
    Title = "Mute All Sounds",
    Desc = "Mematikan semua suara di dalam game.",
    Default = false,
    Callback = function(val)
        if val then MuteAllSounds() end
    end
})

-- Tombol untuk Force Low Quality (Engine Level)
SettingsTab:Button({
    Title = "Force Ultra Low Quality",
    Icon = "mouse-pointer-2",
    Desc = "Memaksa engine Roblox menggunakan settingan terendah.",
    Callback = function()
        BoostCPU()
        Notify("Success", "Engine optimized for low-end PC.", "check")
    end
})
-- [[ OPTIMIZED ENEMY DROPDOWN REFRESH ]] --
local LastAreaID = nil

task.spawn(function()
    while task.wait(1) do -- Diubah ke 3 detik agar sangat ringan
        if not Window or Window.Destroyed then break end
        if IsInMinigame() then continue end 

        local enemiesFolder = workspace:FindFirstChild("_enemies")
        if enemiesFolder then
            local firstEnemy = enemiesFolder:FindFirstChildOfClass("Model")
            local currentEnemyArea = firstEnemy and firstEnemy:GetAttribute("_area")
            
            if currentEnemyArea and currentEnemyArea ~= LastAreaID then
                LastAreaID = currentEnemyArea
                
                if EnemyDropdown and EnemyDropdown.Refresh then
                    EnemyDropdown:Refresh(GetEnemiesList())
                end
            end
        end
    end
end)
-- Loop Refresh Dropdown Otomatis
FM_OnChange("Farm")

Window:SelectTab(FarmTab.Index);

task.spawn(function()
    task.wait(1.5)
    local CM = Window.ConfigManager
    if not CM then return end
    
    pcall(function()
        -- Tambahkan 'true' pada CreateConfig agar library tahu ini adalah sistem autoload
        local cfg = CM:GetConfig(ConfigName) or CM:CreateConfig(ConfigName, true)
        
        -- Mulai proses loading
        IsLoadingConfig = true 
        cfg:Load()
        
        -- PENTING: Set kembali ke false agar loop Auto Save bisa berjalan
        IsLoadingConfig = false 
    end)

    -- Loop Auto Save 10 Detik
    while not Window.Destroyed do
        task.wait(10)
        -- Sekarang Save akan berfungsi karena IsLoadingConfig sudah false
        if not IsLoadingConfig then
            pcall(function()
                local cfg = CM:GetConfig(ConfigName)
                if cfg then 
                    cfg:Save() 
                end
            end)
        end
    end
end)
